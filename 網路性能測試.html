<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²è·¯æ€§èƒ½æ¸¬è©¦ - ç­†é›»ç«¯è¨ºæ–·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
        .result {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        .warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1976d2;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }
        .metric {
            display: inline-block;
            margin: 10px 20px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196f3;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ç¶²è·¯æ€§èƒ½æ¸¬è©¦ - ç­†é›»ç«¯è¨ºæ–·</h1>
        
        <div class="test-box">
            <h2>ğŸ“Š ç•¶å‰ç¶²è·¯ç‹€æ…‹</h2>
            <div class="metric">
                <div class="metric-value" id="connectionType">æª¢æ¸¬ä¸­...</div>
                <div class="metric-label">é€£æ¥é¡å‹</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="downlink">æª¢æ¸¬ä¸­...</div>
                <div class="metric-label">ä¼°è¨ˆé »å¯¬ (Mbps)</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="rtt">æª¢æ¸¬ä¸­...</div>
                <div class="metric-label">å¾€è¿”å»¶é² (ms)</div>
            </div>
        </div>

        <div class="test-box">
            <h2>ğŸš€ å»¶é²æ¸¬è©¦</h2>
            <button onclick="startLatencyTest()">é–‹å§‹å»¶é²æ¸¬è©¦</button>
            <div class="progress">
                <div class="progress-bar" id="latencyProgress"></div>
            </div>
            <div id="latencyResults"></div>
        </div>

        <div class="test-box">
            <h2>ğŸ“¡ å”ä½œæœå‹™å™¨é€£æ¥æ¸¬è©¦</h2>
            <button onclick="startServerTest()">æ¸¬è©¦æœå‹™å™¨éŸ¿æ‡‰</button>
            <div id="serverResults"></div>
        </div>

        <div class="test-box">
            <h2>ğŸ”„ åŒæ­¥æ€§èƒ½æ¸¬è©¦</h2>
            <button onclick="startSyncTest()">æ¸¬è©¦åŒæ­¥å»¶é²</button>
            <div id="syncResults"></div>
        </div>

        <div class="test-box">
            <h2>ğŸ’¡ å„ªåŒ–å»ºè­°</h2>
            <div id="recommendations"></div>
        </div>
    </div>

    <script>
        // æª¢æ¸¬ç¶²è·¯é€£æ¥ä¿¡æ¯
        function detectNetworkInfo() {
            if ('connection' in navigator) {
                const connection = navigator.connection;
                document.getElementById('connectionType').textContent = 
                    connection.effectiveType || 'æœªçŸ¥';
                document.getElementById('downlink').textContent = 
                    connection.downlink ? connection.downlink.toFixed(1) : 'æœªçŸ¥';
                document.getElementById('rtt').textContent = 
                    connection.rtt || 'æœªçŸ¥';
            } else {
                document.getElementById('connectionType').textContent = 'ä¸æ”¯æ´æª¢æ¸¬';
                document.getElementById('downlink').textContent = 'ä¸æ”¯æ´æª¢æ¸¬';
                document.getElementById('rtt').textContent = 'ä¸æ”¯æ´æª¢æ¸¬';
            }
        }

        // å»¶é²æ¸¬è©¦
        async function startLatencyTest() {
            const results = document.getElementById('latencyResults');
            const progress = document.getElementById('latencyProgress');
            results.innerHTML = '<p>æ­£åœ¨æ¸¬è©¦å»¶é²...</p>';
            
            const testCount = 10;
            const latencies = [];
            
            for (let i = 0; i < testCount; i++) {
                const start = performance.now();
                
                try {
                    await fetch(`http://192.168.31.32/collaboration/network_test.php?t=${Date.now()}`, {
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    const end = performance.now();
                    const latency = end - start;
                    latencies.push(latency);
                } catch (error) {
                    latencies.push(5000); // è¶…æ™‚è¦–ç‚º 5 ç§’
                }
                
                progress.style.width = `${((i + 1) / testCount) * 100}%`;
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const avgLatency = latencies.reduce((a, b) => a + b, 0) / latencies.length;
            const minLatency = Math.min(...latencies);
            const maxLatency = Math.max(...latencies);
            
            let resultClass = 'result';
            let status = 'è‰¯å¥½';
            if (avgLatency > 1000) {
                resultClass = 'error';
                status = 'è¼ƒå·®';
            } else if (avgLatency > 500) {
                resultClass = 'warning';
                status = 'ä¸€èˆ¬';
            }
            
            results.innerHTML = `
                <div class="${resultClass}">
                    <h3>å»¶é²æ¸¬è©¦çµæœ - ${status}</h3>
                    <p><strong>å¹³å‡å»¶é²:</strong> ${avgLatency.toFixed(0)}ms</p>
                    <p><strong>æœ€å°å»¶é²:</strong> ${minLatency.toFixed(0)}ms</p>
                    <p><strong>æœ€å¤§å»¶é²:</strong> ${maxLatency.toFixed(0)}ms</p>
                    <p><strong>æ¸¬è©¦æ¬¡æ•¸:</strong> ${testCount}</p>
                </div>
            `;
        }

        // æœå‹™å™¨é€£æ¥æ¸¬è©¦
        async function startServerTest() {
            const results = document.getElementById('serverResults');
            results.innerHTML = '<p>æ­£åœ¨æ¸¬è©¦æœå‹™å™¨é€£æ¥...</p>';
            
            const tests = [
                { name: 'ä¸»é é¢', url: 'http://192.168.31.32/collaboration/' },
                { name: 'æ•¸æ“šåº«åˆå§‹åŒ–', url: 'http://192.168.31.32/collaboration/init_db.php' },
                { name: 'ä»£ç¢¼åŒæ­¥API', url: 'http://192.168.31.32/collaboration/code_sync_handler.php' },
                { name: 'èŠå¤©API', url: 'http://192.168.31.32/collaboration/chat_api_handler.php' }
            ];
            
            let resultHtml = '<h3>æœå‹™å™¨é€£æ¥æ¸¬è©¦çµæœ</h3>';
            
            for (const test of tests) {
                const start = performance.now();
                try {
                    const response = await fetch(test.url, {
                        method: 'HEAD',
                        cache: 'no-cache'
                    });
                    const end = performance.now();
                    const time = end - start;
                    
                    const status = response.ok ? 'âœ…' : 'âŒ';
                    const statusText = response.ok ? 'æ­£å¸¸' : `éŒ¯èª¤ ${response.status}`;
                    
                    resultHtml += `
                        <p>${status} <strong>${test.name}:</strong> ${statusText} (${time.toFixed(0)}ms)</p>
                    `;
                } catch (error) {
                    resultHtml += `
                        <p>âŒ <strong>${test.name}:</strong> é€£æ¥å¤±æ•— - ${error.message}</p>
                    `;
                }
            }
            
            results.innerHTML = `<div class="result">${resultHtml}</div>`;
        }

        // åŒæ­¥æ€§èƒ½æ¸¬è©¦
        async function startSyncTest() {
            const results = document.getElementById('syncResults');
            results.innerHTML = '<p>æ­£åœ¨æ¸¬è©¦åŒæ­¥æ€§èƒ½...</p>';
            
            // æ¨¡æ“¬å”ä½œåŒæ­¥è«‹æ±‚
            const syncTimes = [];
            const testCount = 5;
            
            for (let i = 0; i < testCount; i++) {
                const start = performance.now();
                
                try {
                    const response = await fetch('http://192.168.31.32/collaboration/code_sync_handler.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'test',
                            content: `æ¸¬è©¦åŒæ­¥ ${i + 1}`,
                            timestamp: Date.now()
                        })
                    });
                    
                    const end = performance.now();
                    syncTimes.push(end - start);
                } catch (error) {
                    syncTimes.push(5000);
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            const avgSync = syncTimes.reduce((a, b) => a + b, 0) / syncTimes.length;
            
            let syncStatus = 'è‰¯å¥½';
            let syncClass = 'result';
            if (avgSync > 2000) {
                syncStatus = 'è¼ƒå·®';
                syncClass = 'error';
            } else if (avgSync > 1000) {
                syncStatus = 'ä¸€èˆ¬';
                syncClass = 'warning';
            }
            
            results.innerHTML = `
                <div class="${syncClass}">
                    <h3>åŒæ­¥æ€§èƒ½æ¸¬è©¦çµæœ - ${syncStatus}</h3>
                    <p><strong>å¹³å‡åŒæ­¥æ™‚é–“:</strong> ${avgSync.toFixed(0)}ms</p>
                    <p><strong>å»ºè­°:</strong> ${avgSync < 1000 ? 'åŒæ­¥æ€§èƒ½è‰¯å¥½ï¼Œé©åˆå”ä½œ' : 'åŒæ­¥è¼ƒæ…¢ï¼Œå»ºè­°å„ªåŒ–ç¶²è·¯ç’°å¢ƒ'}</p>
                </div>
            `;
            
            generateRecommendations(avgSync);
        }

        // ç”Ÿæˆå„ªåŒ–å»ºè­°
        function generateRecommendations(syncTime) {
            const recommendations = document.getElementById('recommendations');
            let advice = [];
            
            if (syncTime > 2000) {
                advice.push('ğŸ”´ <strong>åš´é‡å»¶é²</strong> - å»ºè­°åˆ‡æ›åˆ°æ›´ç©©å®šçš„ç¶²è·¯ç’°å¢ƒ');
                advice.push('ğŸ“¶ æª¢æŸ¥æ‰‹æ©Ÿä¿¡è™Ÿå¼·åº¦ï¼Œç§»å‹•åˆ°ä¿¡è™Ÿè¼ƒå¥½çš„ä½ç½®');
                advice.push('ğŸ“± å¦‚æœå¯èƒ½ï¼Œåˆ‡æ›åˆ° 5G ç¶²è·¯æˆ– WiFi');
                advice.push('ğŸ”„ é—œé–‰å…¶ä»–ä½”ç”¨ç¶²è·¯çš„æ‡‰ç”¨ç¨‹å¼');
            } else if (syncTime > 1000) {
                advice.push('ğŸŸ¡ <strong>ä¸­ç­‰å»¶é²</strong> - å¯ä»¥ä½¿ç”¨ä½†é«”é©—å¯èƒ½ä¸å¤ æµæš¢');
                advice.push('ğŸ“¶ å˜—è©¦ç§»å‹•åˆ°ä¿¡è™Ÿè¼ƒå¥½çš„ä½ç½®');
                advice.push('â±ï¸ é¿å…åŒæ™‚é€²è¡Œå¤§é‡ç¶²è·¯æ´»å‹•');
            } else {
                advice.push('ğŸŸ¢ <strong>å»¶é²è‰¯å¥½</strong> - é©åˆé€²è¡Œå”ä½œç·¨ç¨‹');
                advice.push('âœ¨ ç•¶å‰ç¶²è·¯ç’°å¢ƒé©åˆå”ä½œæ¸¬è©¦');
            }
            
            // é€šç”¨å»ºè­°
            advice.push('ğŸ’¡ <strong>é€šç”¨å„ªåŒ–å»ºè­°:</strong>');
            advice.push('â€¢ ç¢ºä¿æ‰‹æ©Ÿé›»é‡å……è¶³');
            advice.push('â€¢ é¿å…åœ¨ç¶²è·¯é«˜å³°æ™‚æ®µæ¸¬è©¦');
            advice.push('â€¢ é—œé–‰ä¸å¿…è¦çš„èƒŒæ™¯æ‡‰ç”¨');
            advice.push('â€¢ ä¿æŒè¨­å‚™ç›¸å°éœæ­¢');
            
            recommendations.innerHTML = advice.map(item => `<p>${item}</p>`).join('');
        }

        // é é¢è¼‰å…¥æ™‚æª¢æ¸¬ç¶²è·¯ä¿¡æ¯
        window.onload = function() {
            detectNetworkInfo();
            
            // æ¯ 5 ç§’æ›´æ–°ä¸€æ¬¡ç¶²è·¯ä¿¡æ¯
            setInterval(detectNetworkInfo, 5000);
        };
    </script>
</body>
</html> 