<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤ é›™äººå”ä½œæ•ˆæœå¯¦æ¸¬ - Pythonæ•™å­¸å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 15px 25px;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .subtitle {
            margin: 3px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 12px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .collaboration-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            min-width: 70px;
        }
        
        .stat-label {
            color: #666;
            font-size: 10px;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 14px;
        }
        
        .latency-good { color: #28a745; }
        .latency-ok { color: #ffc107; }
        .latency-bad { color: #dc3545; }
        
        .test-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 11px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            height: 600px;
        }
        
        .editor-panel {
            position: relative;
            border-right: 1px solid #e0e0e0;
        }
        
        .CodeMirror {
            height: 600px !important;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .cursor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 18px;
            z-index: 101;
            transition: all 0.2s ease;
        }
        
        .remote-cursor::before {
            content: attr(data-user);
            position: absolute;
            top: -22px;
            left: -3px;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            color: white;
            font-weight: bold;
            z-index: 102;
        }
        
        .remote-cursor.user-a {
            background: #ff6b6b;
            animation: blink-red 1.5s infinite;
        }
        
        .remote-cursor.user-a::before {
            background: #ff6b6b;
        }
        
        .remote-cursor.user-b {
            background: #4ecdc4;
            animation: blink-cyan 1.5s infinite;
        }
        
        .remote-cursor.user-b::before {
            background: #4ecdc4;
        }
        
        @keyframes blink-red {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        @keyframes blink-cyan {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .collaboration-panel {
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }
        
        .panel-section {
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: #f0f0f0;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        .users-section {
            flex: 0 0 100px;
            background: #e8f4fd;
            padding: 12px 15px;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            padding: 6px 8px;
            background: white;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .user-status.editing {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .latency-section {
            flex: 0 0 120px;
            background: #f0f8ff;
            padding: 10px 15px;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .latency-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 11px;
        }
        
        .latency-value {
            font-weight: bold;
        }
        
        .activity-section {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
        }
        
        .activity-item {
            margin-bottom: 8px;
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            font-size: 11px;
            border-left: 3px solid #007bff;
        }
        
        .activity-item.edit { border-left-color: #28a745; }
        .activity-item.cursor { border-left-color: #ffc107; }
        .activity-item.system { border-left-color: #6c757d; }
        
        .activity-time {
            color: #666;
            font-size: 10px;
            margin-top: 2px;
        }
        
        .test-instructions {
            background: #fff3cd;
            padding: 12px 20px;
            border-bottom: 1px solid #ffeaa7;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .test-step {
            margin-bottom: 6px;
            padding: 3px 0;
        }
        
        .test-step.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .simulation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .simulation-modal {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }
        
        .simulation-overlay.show {
            display: flex;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .collaboration-panel {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ é›™äººå”ä½œæ•ˆæœå¯¦æ¸¬</h1>
            <div class="subtitle">å°ˆæ¥­ç‰ˆ - æ¸¬è©¦æ¸¸æ¨™åŒæ­¥ã€ä»£ç¢¼å”ä½œå’Œå»¶é²æ€§èƒ½</div>
        </div>
        
        <div class="control-panel">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">A</div>
                <div>
                    <div><strong id="user-name">ç”¨æˆ¶A</strong></div>
                    <div style="font-size: 11px; color: #666;">æˆ¿é–“: <span id="current-room">dual-test</span></div>
                </div>
            </div>
            
            <div class="collaboration-stats">
                <div class="stat">
                    <div class="stat-label">å»¶é²</div>
                    <div class="stat-value latency-good" id="latency-display">--ms</div>
                </div>
                <div class="stat">
                    <div class="stat-label">åœ¨ç·š</div>
                    <div class="stat-value" id="users-count">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">åŒæ­¥æ¬¡æ•¸</div>
                    <div class="stat-value" id="sync-count">0</div>
                </div>
            </div>
            
            <div class="test-controls">
                <button class="btn btn-primary" onclick="openSecondWindow()">ğŸ‘¥ é–‹å•Ÿç”¨æˆ¶B</button>
                <button class="btn btn-success" onclick="startLatencyTest()">â±ï¸ å»¶é²æ¸¬è©¦</button>
                <button class="btn btn-warning" onclick="simulatePairwork()" id="simulate-btn">ğŸ¤– æ¨¡æ“¬å”ä½œ</button>
                <button class="btn btn-danger" onclick="resetTest()">ğŸ”„ é‡ç½®</button>
            </div>
        </div>
        
        <div class="test-instructions">
            <strong>ğŸ“‹ é›™äººå”ä½œæ¸¬è©¦æ­¥é©Ÿï¼š</strong>
            <div class="test-step" id="step-1">1. é»æ“Š "ğŸ‘¥ é–‹å•Ÿç”¨æˆ¶B" æ‰“é–‹ç¬¬äºŒå€‹å”ä½œçª—å£</div>
            <div class="test-step" id="step-2">2. åœ¨ä»»ä¸€çª—å£ç·¨è¼¯ä»£ç¢¼ï¼Œè§€å¯Ÿå¦ä¸€çª—å£çš„å³æ™‚åŒæ­¥</div>
            <div class="test-step" id="step-3">3. ç§»å‹•æ¸¸æ¨™ï¼Œè§€å¯Ÿå°æ–¹çš„å½©è‰²æ¸¸æ¨™é¡¯ç¤º</div>
            <div class="test-step" id="step-4">4. é»æ“Š "â±ï¸ å»¶é²æ¸¬è©¦" æ¸¬é‡åŒæ­¥å»¶é²æ™‚é–“</div>
            <div class="test-step" id="step-5">5. ä½¿ç”¨ "ğŸ¤– æ¨¡æ“¬å”ä½œ" è‡ªå‹•æ¼”ç¤ºå”ä½œæ•ˆæœ</div>
        </div>
        
        <div class="main-content">
            <div class="editor-panel">
                <div class="cursor-overlay" id="cursor-overlay"></div>
                <textarea id="code-editor" placeholder="é–‹å§‹é›™äººå”ä½œç·¨ç¨‹æ¸¬è©¦..."></textarea>
            </div>
            
            <div class="collaboration-panel">
                <div class="panel-section users-section">
                    <div class="panel-header">ğŸ‘¥ å”ä½œç”¨æˆ¶</div>
                    <div id="users-list">
                        <div class="user-item">
                            <div class="user-status" id="user-status-self"></div>
                            <span>ç”¨æˆ¶A (æ‚¨)</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section latency-section">
                    <div class="panel-header">ğŸ“Š å»¶é²ç›£æ§</div>
                    <div class="latency-item">
                        <span>ä»£ç¢¼åŒæ­¥:</span>
                        <span class="latency-value latency-good" id="code-latency">--ms</span>
                    </div>
                    <div class="latency-item">
                        <span>æ¸¸æ¨™åŒæ­¥:</span>
                        <span class="latency-value latency-good" id="cursor-latency">--ms</span>
                    </div>
                    <div class="latency-item">
                        <span>å¹³å‡å»¶é²:</span>
                        <span class="latency-value latency-good" id="avg-latency">--ms</span>
                    </div>
                    <div class="latency-item">
                        <span>é€£æ¥ç‹€æ…‹:</span>
                        <span class="latency-value" id="connection-status">å°±ç·’</span>
                    </div>
                </div>
                
                <div class="panel-section activity-section">
                    <div class="panel-header">ğŸ“ å”ä½œæ´»å‹•</div>
                    <div id="activity-log">
                        <div class="activity-item system">
                            <div><strong>ç³»çµ±</strong> é›™äººå”ä½œç’°å¢ƒå·²å°±ç·’</div>
                            <div class="activity-time">æº–å‚™é–‹å§‹æ¸¬è©¦</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="simulation-overlay" id="simulation-overlay">
        <div class="simulation-modal">
            <h3>ğŸ¤– æ­£åœ¨æ¨¡æ“¬ç”¨æˆ¶Bçš„æ“ä½œ</h3>
            <p id="simulation-status">æº–å‚™é–‹å§‹å”ä½œæ¼”ç¤º...</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-danger" onclick="stopSimulation()">åœæ­¢æ¨¡æ“¬</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let editor;
        let currentRoom = 'dual-test';
        let userId = 'user_' + Math.random().toString(36).substr(2, 4);
        let userName = 'ç”¨æˆ¶A';
        let collaborationChannel;
        let remoteCursors = new Map();
        let latencyData = {
            code: [],
            cursor: [],
            sync: 0
        };
        let isSimulating = false;
        let simulationInterval;
        let lastActivity = Date.now();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
            initCollaboration();
            startMonitoring();
            
            // è¨­ç½®ç”¨æˆ¶ä¿¡æ¯
            setUserIdentity();
            
            addActivity('ç³»çµ±', 'é›™äººå”ä½œæ¸¬è©¦ç’°å¢ƒå·²å•Ÿå‹•', 'system');
        });
        
        // è¨­ç½®ç”¨æˆ¶èº«ä»½
        function setUserIdentity() {
            // æ ¹æ“šçª—å£æ•¸é‡è‡ªå‹•åˆ†é…ç”¨æˆ¶èº«ä»½
            const windowCount = parseInt(localStorage.getItem('windowCount') || '0') + 1;
            localStorage.setItem('windowCount', windowCount.toString());
            
            if (windowCount === 1) {
                userName = 'ç”¨æˆ¶A';
                document.getElementById('user-avatar').textContent = 'A';
                document.getElementById('user-avatar').style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';
            } else {
                userName = 'ç”¨æˆ¶B';
                document.getElementById('user-avatar').textContent = 'B';
                document.getElementById('user-avatar').style.background = 'linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)';
                document.title = 'ğŸ¤ é›™äººå”ä½œæ•ˆæœå¯¦æ¸¬ - ç”¨æˆ¶B';
            }
            
            document.getElementById('user-name').textContent = userName;
        }
        
        // åˆå§‹åŒ–ç·¨è¼¯å™¨
        function initEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                lineWrapping: true,
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    }
                }
            });
            
            // ç°¡åŒ–çš„åˆå§‹ä»£ç¢¼
            const initialCode = `# ğŸ¤ é›™äººå”ä½œå¯¦æ¸¬ - Python æ•™å­¸å¹³å°
# æ”¯æ´å³æ™‚ä»£ç¢¼åŒæ­¥å’Œæ¸¸æ¨™è¿½è¹¤ï¼

def collaboration_demo():
    """é›™äººå”ä½œæ¼”ç¤ºå‡½æ•¸"""
    print("æ­¡è¿é«”é©—é›™äººå”ä½œç·¨ç¨‹ï¼")
    
    # è«‹åœ¨é€™è£¡æ·»åŠ æ‚¨çš„ä»£ç¢¼
    # å¦ä¸€ä½ç”¨æˆ¶å¯ä»¥å³æ™‚çœ‹åˆ°æ‚¨çš„ä¿®æ”¹
    
    features = [
        "å³æ™‚ä»£ç¢¼åŒæ­¥",
        "æ¸¸æ¨™ä½ç½®é¡¯ç¤º",
        "å»¶é²æ€§èƒ½ç›£æ§"
    ]
    
    for i, feature in enumerate(features, 1):
        print(f"{i}. {feature}")
    
    return "å”ä½œæ¸¬è©¦æˆåŠŸï¼"

# æ¸¬è©¦å‡½æ•¸
def test_sync():
    """æ¸¬è©¦åŒæ­¥æ•ˆæœ"""
    import time
    timestamp = int(time.time())
    print(f"åŒæ­¥æ¸¬è©¦æ™‚é–“æˆ³: {timestamp}")
    return timestamp

if __name__ == "__main__":
    print("ğŸ¯ é–‹å§‹é›™äººå”ä½œæ¸¬è©¦...")
    collaboration_demo()
    test_sync()
`;
            
            editor.setValue(initialCode);
            
            // ç›£è½ç·¨è¼¯å™¨äº‹ä»¶
            editor.on('change', handleCodeChange);
            editor.on('cursorActivity', handleCursorChange);
            
            // ç›£è½ç„¦é»äº‹ä»¶
            editor.on('focus', () => {
                updateUserStatus('editing');
                addActivity(userName, 'é–‹å§‹ç·¨è¼¯ä»£ç¢¼', 'edit');
            });
            
            editor.on('blur', () => {
                updateUserStatus('online');
            });
        }
        
        // åˆå§‹åŒ–å”ä½œåŠŸèƒ½
        function initCollaboration() {
            collaborationChannel = new BroadcastChannel('dual_collab_' + currentRoom);
            
            collaborationChannel.onmessage = function(event) {
                handleCollaborationMessage(event.data);
            };
            
            // å»£æ’­ç”¨æˆ¶åŠ å…¥
            setTimeout(() => {
                broadcastMessage({
                    type: 'user_join',
                    userId: userId,
                    userName: userName,
                    timestamp: Date.now()
                });
            }, 500);
            
            addActivity('ç³»çµ±', 'å·²é€£æ¥åˆ°å”ä½œæˆ¿é–“: ' + currentRoom, 'system');
        }
        
        // è™•ç†ä»£ç¢¼è®Šæ›´
        function handleCodeChange(cm, change) {
            if (change.origin === 'remote' || change.origin === 'simulation') return;
            
            const changeData = {
                type: 'code_change',
                userId: userId,
                userName: userName,
                change: {
                    from: change.from,
                    to: change.to,
                    text: change.text,
                    removed: change.removed
                },
                timestamp: Date.now(),
                fullCode: cm.getValue()
            };
            
            broadcastMessage(changeData);
            updateSyncCount();
            addActivity(userName, `ç·¨è¼¯äº†ç¬¬ ${change.from.line + 1} è¡Œ`, 'edit');
            lastActivity = Date.now();
        }
        
        // è™•ç†æ¸¸æ¨™è®Šæ›´
        function handleCursorChange(cm) {
            const cursor = cm.getCursor();
            const cursorData = {
                type: 'cursor_change',
                userId: userId,
                userName: userName,
                cursor: cursor,
                timestamp: Date.now()
            };
            
            broadcastMessage(cursorData);
            lastActivity = Date.now();
        }
        
        // è™•ç†å”ä½œæ¶ˆæ¯
        function handleCollaborationMessage(data) {
            if (data.userId === userId) return;
            
            const latency = Date.now() - data.timestamp;
            
            switch (data.type) {
                case 'user_join':
                    addUser(data.userId, data.userName);
                    addActivity(data.userName, 'åŠ å…¥äº†å”ä½œ', 'system');
                    break;
                    
                case 'user_leave':
                    removeUser(data.userId);
                    addActivity(data.userName, 'é›¢é–‹äº†å”ä½œ', 'system');
                    break;
                    
                case 'code_change':
                    applyRemoteCodeChange(data);
                    recordLatency('code', latency);
                    addActivity(data.userName, 'åŒæ­¥äº†ä»£ç¢¼è®Šæ›´', 'edit');
                    break;
                    
                case 'cursor_change':
                    updateRemoteCursor(data.userId, data.userName, data.cursor);
                    recordLatency('cursor', latency);
                    break;
            }
            
            updateLatencyDisplay();
        }
        
        // æ‡‰ç”¨é ç¨‹ä»£ç¢¼è®Šæ›´
        function applyRemoteCodeChange(data) {
            const currentCode = editor.getValue();
            if (currentCode !== data.fullCode) {
                const cursor = editor.getCursor();
                editor.setValue(data.fullCode);
                editor.setCursor(cursor);
            }
        }
        
        // æ›´æ–°é ç¨‹æ¸¸æ¨™
        function updateRemoteCursor(userId, userName, cursor) {
            const overlay = document.getElementById('cursor-overlay');
            let cursorElement = document.getElementById('cursor-' + userId);
            
            if (!cursorElement) {
                cursorElement = document.createElement('div');
                cursorElement.id = 'cursor-' + userId;
                cursorElement.className = 'remote-cursor ' + (userName.includes('A') ? 'user-a' : 'user-b');
                cursorElement.setAttribute('data-user', userName);
                overlay.appendChild(cursorElement);
            }
            
            // è¨ˆç®—æ¸¸æ¨™ä½ç½®
            try {
                const coords = editor.cursorCoords({line: cursor.line, ch: cursor.ch}, 'local');
                cursorElement.style.left = coords.left + 'px';
                cursorElement.style.top = coords.top + 'px';
                cursorElement.style.display = 'block';
            } catch (e) {
                cursorElement.style.display = 'none';
            }
            
            remoteCursors.set(userId, {
                element: cursorElement,
                userName: userName,
                lastUpdate: Date.now()
            });
        }
        
        // æ·»åŠ ç”¨æˆ¶
        function addUser(userId, userName) {
            const usersList = document.getElementById('users-list');
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (document.getElementById('user-item-' + userId)) return;
            
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.id = 'user-item-' + userId;
            
            userItem.innerHTML = `
                <div class="user-status" id="status-${userId}"></div>
                <span>${userName}</span>
            `;
            
            usersList.appendChild(userItem);
            updateUsersCount();
        }
        
        // ç§»é™¤ç”¨æˆ¶
        function removeUser(userId) {
            const userItem = document.getElementById('user-item-' + userId);
            if (userItem) {
                userItem.remove();
            }
            
            const cursor = remoteCursors.get(userId);
            if (cursor && cursor.element.parentNode) {
                cursor.element.parentNode.removeChild(cursor.element);
            }
            remoteCursors.delete(userId);
            
            updateUsersCount();
        }
        
        // æ›´æ–°ç”¨æˆ¶æ•¸é‡
        function updateUsersCount() {
            const count = document.getElementById('users-list').children.length;
            document.getElementById('users-count').textContent = count;
        }
        
        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
        function updateUserStatus(status) {
            const statusElement = document.getElementById('user-status-self');
            if (statusElement) {
                statusElement.className = 'user-status ' + status;
            }
        }
        
        // å»£æ’­æ¶ˆæ¯
        function broadcastMessage(data) {
            try {
                collaborationChannel.postMessage(data);
            } catch (error) {
                console.error('å»£æ’­å¤±æ•—:', error);
                document.getElementById('connection-status').textContent = 'ç•°å¸¸';
            }
        }
        
        // è¨˜éŒ„å»¶é²
        function recordLatency(type, latency) {
            if (!latencyData[type]) latencyData[type] = [];
            
            latencyData[type].push(latency);
            if (latencyData[type].length > 5) {
                latencyData[type].shift();
            }
        }
        
        // æ›´æ–°å»¶é²é¡¯ç¤º
        function updateLatencyDisplay() {
            const types = ['code', 'cursor'];
            let totalLatency = 0;
            let count = 0;
            
            types.forEach(type => {
                const data = latencyData[type];
                if (data.length > 0) {
                    const avg = data.reduce((a, b) => a + b, 0) / data.length;
                    const element = document.getElementById(type + '-latency');
                    
                    if (element) {
                        element.textContent = Math.round(avg) + 'ms';
                        element.className = 'latency-value ' + getLatencyClass(avg);
                    }
                    
                    totalLatency += avg;
                    count++;
                }
            });
            
            if (count > 0) {
                const avgLatency = totalLatency / count;
                const avgElement = document.getElementById('avg-latency');
                const displayElement = document.getElementById('latency-display');
                
                if (avgElement) {
                    avgElement.textContent = Math.round(avgLatency) + 'ms';
                    avgElement.className = 'latency-value ' + getLatencyClass(avgLatency);
                }
                
                if (displayElement) {
                    displayElement.textContent = Math.round(avgLatency) + 'ms';
                    displayElement.className = 'stat-value ' + getLatencyClass(avgLatency);
                }
            }
        }
        
        // ç²å–å»¶é²ç­‰ç´š
        function getLatencyClass(latency) {
            if (latency < 100) return 'latency-good';
            if (latency < 300) return 'latency-ok';
            return 'latency-bad';
        }
        
        // é–‹å§‹ç›£æ§
        function startMonitoring() {
            setInterval(() => {
                updateLatencyDisplay();
                
                // æª¢æŸ¥é€£æ¥ç‹€æ…‹
                const now = Date.now();
                if (now - lastActivity > 30000) {
                    document.getElementById('connection-status').textContent = 'é–’ç½®';
                } else {
                    document.getElementById('connection-status').textContent = 'æ´»èº';
                }
            }, 1000);
        }
        
        // æ›´æ–°åŒæ­¥è¨ˆæ•¸
        function updateSyncCount() {
            latencyData.sync++;
            document.getElementById('sync-count').textContent = latencyData.sync;
        }
        
        // æ·»åŠ æ´»å‹•è¨˜éŒ„
        function addActivity(user, action, type) {
            const activityLog = document.getElementById('activity-log');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item ' + type;
            
            const time = new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            activityItem.innerHTML = `
                <div><strong>${user}</strong> ${action}</div>
                <div class="activity-time">${time}</div>
            `;
            
            activityLog.insertBefore(activityItem, activityLog.firstChild);
            
            // é™åˆ¶è¨˜éŒ„æ•¸é‡
            while (activityLog.children.length > 20) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }
        
        // é–‹å•Ÿç¬¬äºŒå€‹çª—å£
        function openSecondWindow() {
            const currentUrl = window.location.href;
            window.open(currentUrl, 'user_b_window', 'width=800,height=700,left=100,top=100');
            
            addActivity('ç³»çµ±', 'å·²é–‹å•Ÿç”¨æˆ¶Bçª—å£', 'system');
            document.getElementById('step-1').classList.add('completed');
            
            setTimeout(() => {
                addActivity('æç¤º', 'ç¾åœ¨å¯ä»¥åœ¨å…©å€‹çª—å£ä¸­æ¸¬è©¦å”ä½œäº†ï¼', 'system');
            }, 2000);
        }
        
        // é–‹å§‹å»¶é²æ¸¬è©¦
        function startLatencyTest() {
            addActivity('ç³»çµ±', 'é–‹å§‹å»¶é²æ¸¬è©¦...', 'system');
            
            let testCount = 0;
            const maxTests = 5;
            
            const testInterval = setInterval(() => {
                if (testCount >= maxTests) {
                    clearInterval(testInterval);
                    addActivity('ç³»çµ±', 'å»¶é²æ¸¬è©¦å®Œæˆ', 'system');
                    document.getElementById('step-4').classList.add('completed');
                    return;
                }
                
                const testData = {
                    type: 'latency_test',
                    userId: userId,
                    userName: userName,
                    testId: testCount,
                    timestamp: Date.now()
                };
                
                broadcastMessage(testData);
                testCount++;
                
                addActivity('æ¸¬è©¦', `å»¶é²æ¸¬è©¦ ${testCount}/${maxTests}`, 'system');
            }, 800);
        }
        
        // æ¨¡æ“¬é›™äººå”ä½œ
        function simulatePairwork() {
            if (isSimulating) return;
            
            isSimulating = true;
            document.getElementById('simulation-overlay').classList.add('show');
            document.getElementById('simulate-btn').disabled = true;
            document.getElementById('step-5').classList.add('completed');
            
            const collaborativeChanges = [
                { line: 8, text: '    # ç”¨æˆ¶Bæ·»åŠ ï¼šå”ä½œé–‹å§‹', action: 'æ·»åŠ è¨»é‡‹', delay: 1000 },
                { line: 12, text: '    user_b_feature = "é›™äººå”ä½œåŠŸèƒ½"', action: 'æ·»åŠ è®Šé‡', delay: 2000 },
                { line: 16, text: '        "ç”¨æˆ¶Bçš„è²¢ç»",', action: 'æ·»åŠ åˆ—è¡¨é …', delay: 1500 },
                { line: 20, text: '        print(f"ç”¨æˆ¶B: {feature}")', action: 'ä¿®æ”¹ä»£ç¢¼', delay: 2000 },
                { line: 24, text: '    print("é›™äººå”ä½œå®Œæˆï¼")', action: 'æ·»åŠ è¼¸å‡º', delay: 1000 }
            ];
            
            let changeIndex = 0;
            
            function executeNextChange() {
                if (changeIndex >= collaborativeChanges.length || !isSimulating) {
                    stopSimulation();
                    return;
                }
                
                const change = collaborativeChanges[changeIndex];
                const partnerName = 'ç”¨æˆ¶B';
                
                // æ›´æ–°ç‹€æ…‹
                document.getElementById('simulation-status').textContent = 
                    `${partnerName} æ­£åœ¨: ${change.action}`;
                
                // æ¨¡æ“¬æ¸¸æ¨™ç§»å‹•
                updateRemoteCursor('sim_user', partnerName, { line: change.line, ch: 0 });
                
                // æ¨¡æ“¬ä»£ç¢¼è®Šæ›´
                setTimeout(() => {
                    const currentCode = editor.getValue();
                    const lines = currentCode.split('\n');
                    
                    if (lines[change.line]) {
                        lines.splice(change.line + 1, 0, change.text);
                    } else {
                        lines.push(change.text);
                    }
                    
                    editor.setValue(lines.join('\n'));
                    addActivity(partnerName, change.action, 'edit');
                    
                    changeIndex++;
                    setTimeout(executeNextChange, change.delay);
                }, 500);
            }
            
            setTimeout(executeNextChange, 1000);
            addActivity('ç³»çµ±', 'é–‹å§‹æ¨¡æ“¬é›™äººå”ä½œ', 'system');
        }
        
        // åœæ­¢æ¨¡æ“¬
        function stopSimulation() {
            isSimulating = false;
            document.getElementById('simulation-overlay').classList.remove('show');
            document.getElementById('simulate-btn').disabled = false;
            
            // æ¸…ç†æ¨¡æ“¬æ¸¸æ¨™
            const simCursor = document.getElementById('cursor-sim_user');
            if (simCursor && simCursor.parentNode) {
                simCursor.parentNode.removeChild(simCursor);
            }
            
            addActivity('ç³»çµ±', 'å”ä½œæ¨¡æ“¬å·²çµæŸ', 'system');
        }
        
        // é‡ç½®æ¸¬è©¦
        function resetTest() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ¸¬è©¦å—ï¼Ÿ')) {
                location.reload();
            }
        }
        
        // é é¢é—œé–‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('windowCount', '0');
            broadcastMessage({
                type: 'user_leave',
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
        });
    </script>
</body>
</html> 