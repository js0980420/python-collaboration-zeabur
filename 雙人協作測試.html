<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ù Èõô‰∫∫Âçî‰ΩúÊïàÊûúÂØ¶Ê∏¨ - PythonÊïôÂ≠∏Âπ≥Âè∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 15px 25px;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .subtitle {
            margin: 3px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 12px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .collaboration-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            min-width: 70px;
        }
        
        .stat-label {
            color: #666;
            font-size: 10px;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 14px;
        }
        
        .latency-good { color: #28a745; }
        .latency-ok { color: #ffc107; }
        .latency-bad { color: #dc3545; }
        
        .test-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 11px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1.8fr 1fr;
            height: 600px;
        }
        
        .editor-panel {
            position: relative;
            border-right: 1px solid #e0e0e0;
        }
        
        .CodeMirror {
            height: 600px !important;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .cursor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 18px;
            z-index: 101;
            transition: all 0.2s ease;
        }
        
        .remote-cursor::before {
            content: attr(data-user);
            position: absolute;
            top: -22px;
            left: -3px;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            color: white;
            font-weight: bold;
            z-index: 102;
        }
        
        .remote-cursor.user-a {
            background: #ff6b6b;
            animation: blink-red 1.5s infinite;
        }
        
        .remote-cursor.user-a::before {
            background: #ff6b6b;
        }
        
        .remote-cursor.user-b {
            background: #4ecdc4;
            animation: blink-cyan 1.5s infinite;
        }
        
        .remote-cursor.user-b::before {
            background: #4ecdc4;
        }
        
        @keyframes blink-red {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        @keyframes blink-cyan {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .collaboration-panel {
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }
        
        .panel-section {
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: #f0f0f0;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        .users-section {
            flex: 0 0 100px;
            background: #e8f4fd;
            padding: 12px 15px;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            padding: 6px 8px;
            background: white;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .user-status.editing {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .latency-section {
            flex: 0 0 120px;
            background: #f0f8ff;
            padding: 10px 15px;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .latency-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 11px;
        }
        
        .latency-value {
            font-weight: bold;
        }
        
        .activity-section {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
        }
        
        .activity-item {
            margin-bottom: 8px;
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            font-size: 11px;
            border-left: 3px solid #007bff;
        }
        
        .activity-item.edit { border-left-color: #28a745; }
        .activity-item.cursor { border-left-color: #ffc107; }
        .activity-item.system { border-left-color: #6c757d; }
        
        .activity-time {
            color: #666;
            font-size: 10px;
            margin-top: 2px;
        }
        
        .test-instructions {
            background: #fff3cd;
            padding: 12px 20px;
            border-bottom: 1px solid #ffeaa7;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .test-step {
            margin-bottom: 6px;
            padding: 3px 0;
        }
        
        .test-step.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .simulation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .simulation-modal {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }
        
        .simulation-overlay.show {
            display: flex;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .collaboration-panel {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Èõô‰∫∫Âçî‰ΩúÊïàÊûúÂØ¶Ê∏¨</h1>
            <div class="subtitle">Â∞àÊ•≠Áâà - Ê∏¨Ë©¶Ê∏∏Ê®ôÂêåÊ≠•„ÄÅ‰ª£Á¢ºÂçî‰ΩúÂíåÂª∂ÈÅ≤ÊÄßËÉΩ</div>
        </div>
        
        <div class="control-panel">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">A</div>
                <div>
                    <div><strong id="user-name">Áî®Êà∂A</strong></div>
                    <div style="font-size: 11px; color: #666;">ÊàøÈñì: <span id="current-room">dual-test</span></div>
                </div>
            </div>
            
            <div class="collaboration-stats">
                <div class="stat">
                    <div class="stat-label">Âª∂ÈÅ≤</div>
                    <div class="stat-value latency-good" id="latency-display">--ms</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Âú®Á∑ö</div>
                    <div class="stat-value" id="users-count">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">ÂêåÊ≠•Ê¨°Êï∏</div>
                    <div class="stat-value" id="sync-count">0</div>
                </div>
            </div>
            
            <div class="test-controls">
                <button class="btn btn-primary" onclick="openSecondWindow()">üë• ÈñãÂïüÁî®Êà∂B</button>
                <button class="btn btn-success" onclick="startLatencyTest()">‚è±Ô∏è Âª∂ÈÅ≤Ê∏¨Ë©¶</button>
                <button class="btn btn-warning" onclick="simulatePairwork()" id="simulate-btn">ü§ñ Ê®°Êì¨Âçî‰Ωú</button>
                <button class="btn btn-danger" onclick="resetTest()">üîÑ ÈáçÁΩÆ</button>
            </div>
        </div>
        
        <div class="test-instructions">
            <strong>üìã Èõô‰∫∫Âçî‰ΩúÊ∏¨Ë©¶Ê≠•È©üÔºö</strong>
            <div class="test-step" id="step-1">1. ÈªûÊìä "üë• ÈñãÂïüÁî®Êà∂B" ÊâìÈñãÁ¨¨‰∫åÂÄãÂçî‰ΩúÁ™óÂè£</div>
            <div class="test-step" id="step-2">2. Âú®‰ªª‰∏ÄÁ™óÂè£Á∑®ËºØ‰ª£Á¢ºÔºåËßÄÂØüÂè¶‰∏ÄÁ™óÂè£ÁöÑÂç≥ÊôÇÂêåÊ≠•</div>
            <div class="test-step" id="step-3">3. ÁßªÂãïÊ∏∏Ê®ôÔºåËßÄÂØüÂ∞çÊñπÁöÑÂΩ©Ëâ≤Ê∏∏Ê®ôÈ°ØÁ§∫</div>
            <div class="test-step" id="step-4">4. ÈªûÊìä "‚è±Ô∏è Âª∂ÈÅ≤Ê∏¨Ë©¶" Ê∏¨ÈáèÂêåÊ≠•Âª∂ÈÅ≤ÊôÇÈñì</div>
            <div class="test-step" id="step-5">5. ‰ΩøÁî® "ü§ñ Ê®°Êì¨Âçî‰Ωú" Ëá™ÂãïÊºîÁ§∫Âçî‰ΩúÊïàÊûú</div>
        </div>
        
        <div class="main-content">
            <div class="editor-panel">
                <div class="cursor-overlay" id="cursor-overlay"></div>
                <textarea id="code-editor" placeholder="ÈñãÂßãÈõô‰∫∫Âçî‰ΩúÁ∑®Á®ãÊ∏¨Ë©¶..."></textarea>
            </div>
            
            <div class="collaboration-panel">
                <div class="panel-section users-section">
                    <div class="panel-header">üë• Âçî‰ΩúÁî®Êà∂</div>
                    <div id="users-list">
                        <div class="user-item">
                            <div class="user-status" id="user-status-self"></div>
                            <span>Áî®Êà∂A (ÊÇ®)</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section latency-section">
                    <div class="panel-header">üìä Âª∂ÈÅ≤Áõ£Êéß</div>
                    <div class="latency-item">
                        <span>‰ª£Á¢ºÂêåÊ≠•:</span>
                        <span class="latency-value latency-good" id="code-latency">--ms</span>
                    </div>
                    <div class="latency-item">
                        <span>Ê∏∏Ê®ôÂêåÊ≠•:</span>
                        <span class="latency-value latency-good" id="cursor-latency">--ms</span>
                    </div>
                    <div class="latency-item">
                        <span>Âπ≥ÂùáÂª∂ÈÅ≤:</span>
                        <span class="latency-value latency-good" id="avg-latency">--ms</span>
                    </div>
                    <div class="latency-item">
                        <span>ÈÄ£Êé•ÁãÄÊÖã:</span>
                        <span class="latency-value" id="connection-status">Â∞±Á∑í</span>
                    </div>
                </div>
                
                <div class="panel-section activity-section">
                    <div class="panel-header">üìù Âçî‰ΩúÊ¥ªÂãï</div>
                    <div id="activity-log">
                        <div class="activity-item system">
                            <div><strong>Á≥ªÁµ±</strong> Èõô‰∫∫Âçî‰ΩúÁí∞Â¢ÉÂ∑≤Â∞±Á∑í</div>
                            <div class="activity-time">Ê∫ñÂÇôÈñãÂßãÊ∏¨Ë©¶</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="simulation-overlay" id="simulation-overlay">
        <div class="simulation-modal">
            <h3>ü§ñ Ê≠£Âú®Ê®°Êì¨Áî®Êà∂BÁöÑÊìç‰Ωú</h3>
            <p id="simulation-status">Ê∫ñÂÇôÈñãÂßãÂçî‰ΩúÊºîÁ§∫...</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-danger" onclick="stopSimulation()">ÂÅúÊ≠¢Ê®°Êì¨</button>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄËÆäÈáè
        let editor;
        let currentRoom = 'dual-test';
        let userId = 'user_' + Math.random().toString(36).substr(2, 4);
        let userName = 'Áî®Êà∂A';
        let collaborationChannel;
        let remoteCursors = new Map();
        let latencyData = {
            code: [],
            cursor: [],
            sync: 0
        };
        let isSimulating = false;
        let simulationInterval;
        let lastActivity = Date.now();
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
            initCollaboration();
            startMonitoring();
            
            // Ë®≠ÁΩÆÁî®Êà∂‰ø°ÊÅØ
            setUserIdentity();
            
            addActivity('Á≥ªÁµ±', 'Èõô‰∫∫Âçî‰ΩúÊ∏¨Ë©¶Áí∞Â¢ÉÂ∑≤ÂïüÂãï', 'system');
        });
        
        // Ë®≠ÁΩÆÁî®Êà∂Ë∫´‰ªΩ
        function setUserIdentity() {
            // Ê†πÊìöÁ™óÂè£Êï∏ÈáèËá™ÂãïÂàÜÈÖçÁî®Êà∂Ë∫´‰ªΩ
            const windowCount = parseInt(localStorage.getItem('windowCount') || '0') + 1;
            localStorage.setItem('windowCount', windowCount.toString());
            
            if (windowCount === 1) {
                userName = 'Áî®Êà∂A';
                document.getElementById('user-avatar').textContent = 'A';
                document.getElementById('user-avatar').style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)';
            } else {
                userName = 'Áî®Êà∂B';
                document.getElementById('user-avatar').textContent = 'B';
                document.getElementById('user-avatar').style.background = 'linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)';
                document.title = 'ü§ù Èõô‰∫∫Âçî‰ΩúÊïàÊûúÂØ¶Ê∏¨ - Áî®Êà∂B';
            }
            
            document.getElementById('user-name').textContent = userName;
        }
        
        // ÂàùÂßãÂåñÁ∑®ËºØÂô®
        function initEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                lineWrapping: true,
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    }
                }
            });
            
            // Á∞°ÂåñÁöÑÂàùÂßã‰ª£Á¢º
            const initialCode = `# ü§ù Èõô‰∫∫Âçî‰ΩúÂØ¶Ê∏¨ - Python ÊïôÂ≠∏Âπ≥Âè∞
# ÊîØÊè¥Âç≥ÊôÇ‰ª£Á¢ºÂêåÊ≠•ÂíåÊ∏∏Ê®ôËøΩËπ§ÔºÅ

def collaboration_demo():
    """Èõô‰∫∫Âçî‰ΩúÊºîÁ§∫ÂáΩÊï∏"""
    print("Ê≠°ËøéÈ´îÈ©óÈõô‰∫∫Âçî‰ΩúÁ∑®Á®ãÔºÅ")
    
    # Ë´ãÂú®ÈÄôË£°Ê∑ªÂä†ÊÇ®ÁöÑ‰ª£Á¢º
    # Âè¶‰∏Ä‰ΩçÁî®Êà∂ÂèØ‰ª•Âç≥ÊôÇÁúãÂà∞ÊÇ®ÁöÑ‰øÆÊîπ
    
    features = [
        "Âç≥ÊôÇ‰ª£Á¢ºÂêåÊ≠•",
        "Ê∏∏Ê®ô‰ΩçÁΩÆÈ°ØÁ§∫",
        "Âª∂ÈÅ≤ÊÄßËÉΩÁõ£Êéß"
    ]
    
    for i, feature in enumerate(features, 1):
        print(f"{i}. {feature}")
    
    return "Âçî‰ΩúÊ∏¨Ë©¶ÊàêÂäüÔºÅ"

# Ê∏¨Ë©¶ÂáΩÊï∏
def test_sync():
    """Ê∏¨Ë©¶ÂêåÊ≠•ÊïàÊûú"""
    import time
    timestamp = int(time.time())
    print(f"ÂêåÊ≠•Ê∏¨Ë©¶ÊôÇÈñìÊà≥: {timestamp}")
    return timestamp

if __name__ == "__main__":
    print("üéØ ÈñãÂßãÈõô‰∫∫Âçî‰ΩúÊ∏¨Ë©¶...")
    collaboration_demo()
    test_sync()
`;
            
            editor.setValue(initialCode);
            
            // Áõ£ËÅΩÁ∑®ËºØÂô®‰∫ã‰ª∂
            editor.on('change', handleCodeChange);
            editor.on('cursorActivity', handleCursorChange);
            
            // Áõ£ËÅΩÁÑ¶Èªû‰∫ã‰ª∂
            editor.on('focus', () => {
                updateUserStatus('editing');
                addActivity(userName, 'ÈñãÂßãÁ∑®ËºØ‰ª£Á¢º', 'edit');
            });
            
            editor.on('blur', () => {
                updateUserStatus('online');
            });
        }
        
        // ÂàùÂßãÂåñÂçî‰ΩúÂäüËÉΩ
        function initCollaboration() {
            collaborationChannel = new BroadcastChannel('dual_collab_' + currentRoom);
            
            collaborationChannel.onmessage = function(event) {
                handleCollaborationMessage(event.data);
            };
            
            // Âª£Êí≠Áî®Êà∂Âä†ÂÖ•
            setTimeout(() => {
                broadcastMessage({
                    type: 'user_join',
                    userId: userId,
                    userName: userName,
                    timestamp: Date.now()
                });
            }, 500);
            
            addActivity('Á≥ªÁµ±', 'Â∑≤ÈÄ£Êé•Âà∞Âçî‰ΩúÊàøÈñì: ' + currentRoom, 'system');
        }
        
        // ËôïÁêÜ‰ª£Á¢ºËÆäÊõ¥
        function handleCodeChange(cm, change) {
            if (change.origin === 'remote' || change.origin === 'simulation') return;
            
            const changeData = {
                type: 'code_change',
                userId: userId,
                userName: userName,
                change: {
                    from: change.from,
                    to: change.to,
                    text: change.text,
                    removed: change.removed
                },
                timestamp: Date.now(),
                fullCode: cm.getValue()
            };
            
            broadcastMessage(changeData);
            updateSyncCount();
            addActivity(userName, `Á∑®ËºØ‰∫ÜÁ¨¨ ${change.from.line + 1} Ë°å`, 'edit');
            lastActivity = Date.now();
        }
        
        // ËôïÁêÜÊ∏∏Ê®ôËÆäÊõ¥
        function handleCursorChange(cm) {
            const cursor = cm.getCursor();
            const cursorData = {
                type: 'cursor_change',
                userId: userId,
                userName: userName,
                cursor: cursor,
                timestamp: Date.now()
            };
            
            broadcastMessage(cursorData);
            lastActivity = Date.now();
        }
        
        // ËôïÁêÜÂçî‰ΩúÊ∂àÊÅØ
        function handleCollaborationMessage(data) {
            if (data.userId === userId) return;
            
            const latency = Date.now() - data.timestamp;
            
            switch (data.type) {
                case 'user_join':
                    addUser(data.userId, data.userName);
                    addActivity(data.userName, 'Âä†ÂÖ•‰∫ÜÂçî‰Ωú', 'system');
                    break;
                    
                case 'user_leave':
                    removeUser(data.userId);
                    addActivity(data.userName, 'Èõ¢Èñã‰∫ÜÂçî‰Ωú', 'system');
                    break;
                    
                case 'code_change':
                    applyRemoteCodeChange(data);
                    recordLatency('code', latency);
                    addActivity(data.userName, 'ÂêåÊ≠•‰∫Ü‰ª£Á¢ºËÆäÊõ¥', 'edit');
                    break;
                    
                case 'cursor_change':
                    updateRemoteCursor(data.userId, data.userName, data.cursor);
                    recordLatency('cursor', latency);
                    break;
            }
            
            updateLatencyDisplay();
        }
        
        // ÊáâÁî®ÈÅ†Á®ã‰ª£Á¢ºËÆäÊõ¥
        function applyRemoteCodeChange(data) {
            const currentCode = editor.getValue();
            if (currentCode !== data.fullCode) {
                const cursor = editor.getCursor();
                editor.setValue(data.fullCode);
                editor.setCursor(cursor);
            }
        }
        
        // Êõ¥Êñ∞ÈÅ†Á®ãÊ∏∏Ê®ô
        function updateRemoteCursor(userId, userName, cursor) {
            const overlay = document.getElementById('cursor-overlay');
            let cursorElement = document.getElementById('cursor-' + userId);
            
            if (!cursorElement) {
                cursorElement = document.createElement('div');
                cursorElement.id = 'cursor-' + userId;
                cursorElement.className = 'remote-cursor ' + (userName.includes('A') ? 'user-a' : 'user-b');
                cursorElement.setAttribute('data-user', userName);
                overlay.appendChild(cursorElement);
            }
            
            // Ë®àÁÆóÊ∏∏Ê®ô‰ΩçÁΩÆ
            try {
                const coords = editor.cursorCoords({line: cursor.line, ch: cursor.ch}, 'local');
                cursorElement.style.left = coords.left + 'px';
                cursorElement.style.top = coords.top + 'px';
                cursorElement.style.display = 'block';
            } catch (e) {
                cursorElement.style.display = 'none';
            }
            
            remoteCursors.set(userId, {
                element: cursorElement,
                userName: userName,
                lastUpdate: Date.now()
            });
        }
        
        // Ê∑ªÂä†Áî®Êà∂
        function addUser(userId, userName) {
            const usersList = document.getElementById('users-list');
            
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®
            if (document.getElementById('user-item-' + userId)) return;
            
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.id = 'user-item-' + userId;
            
            userItem.innerHTML = `
                <div class="user-status" id="status-${userId}"></div>
                <span>${userName}</span>
            `;
            
            usersList.appendChild(userItem);
            updateUsersCount();
        }
        
        // ÁßªÈô§Áî®Êà∂
        function removeUser(userId) {
            const userItem = document.getElementById('user-item-' + userId);
            if (userItem) {
                userItem.remove();
            }
            
            const cursor = remoteCursors.get(userId);
            if (cursor && cursor.element.parentNode) {
                cursor.element.parentNode.removeChild(cursor.element);
            }
            remoteCursors.delete(userId);
            
            updateUsersCount();
        }
        
        // Êõ¥Êñ∞Áî®Êà∂Êï∏Èáè
        function updateUsersCount() {
            const count = document.getElementById('users-list').children.length;
            document.getElementById('users-count').textContent = count;
        }
        
        // Êõ¥Êñ∞Áî®Êà∂ÁãÄÊÖã
        function updateUserStatus(status) {
            const statusElement = document.getElementById('user-status-self');
            if (statusElement) {
                statusElement.className = 'user-status ' + status;
            }
        }
        
        // Âª£Êí≠Ê∂àÊÅØ
        function broadcastMessage(data) {
            try {
                collaborationChannel.postMessage(data);
            } catch (error) {
                console.error('Âª£Êí≠Â§±Êïó:', error);
                document.getElementById('connection-status').textContent = 'Áï∞Â∏∏';
            }
        }
        
        // Ë®òÈåÑÂª∂ÈÅ≤
        function recordLatency(type, latency) {
            if (!latencyData[type]) latencyData[type] = [];
            
            latencyData[type].push(latency);
            if (latencyData[type].length > 5) {
                latencyData[type].shift();
            }
        }
        
        // Êõ¥Êñ∞Âª∂ÈÅ≤È°ØÁ§∫
        function updateLatencyDisplay() {
            const types = ['code', 'cursor'];
            let totalLatency = 0;
            let count = 0;
            
            types.forEach(type => {
                const data = latencyData[type];
                if (data.length > 0) {
                    const avg = data.reduce((a, b) => a + b, 0) / data.length;
                    const element = document.getElementById(type + '-latency');
                    
                    if (element) {
                        element.textContent = Math.round(avg) + 'ms';
                        element.className = 'latency-value ' + getLatencyClass(avg);
                    }
                    
                    totalLatency += avg;
                    count++;
                }
            });
            
            if (count > 0) {
                const avgLatency = totalLatency / count;
                const avgElement = document.getElementById('avg-latency');
                const displayElement = document.getElementById('latency-display');
                
                if (avgElement) {
                    avgElement.textContent = Math.round(avgLatency) + 'ms';
                    avgElement.className = 'latency-value ' + getLatencyClass(avgLatency);
                }
                
                if (displayElement) {
                    displayElement.textContent = Math.round(avgLatency) + 'ms';
                    displayElement.className = 'stat-value ' + getLatencyClass(avgLatency);
                }
            }
        }
        
        // Áç≤ÂèñÂª∂ÈÅ≤Á≠âÁ¥ö
        function getLatencyClass(latency) {
            if (latency < 100) return 'latency-good';
            if (latency < 300) return 'latency-ok';
            return 'latency-bad';
        }
        
        // ÈñãÂßãÁõ£Êéß
        function startMonitoring() {
            setInterval(() => {
                updateLatencyDisplay();
                
                // Ê™¢Êü•ÈÄ£Êé•ÁãÄÊÖã
                const now = Date.now();
                if (now - lastActivity > 30000) {
                    document.getElementById('connection-status').textContent = 'ÈñíÁΩÆ';
                } else {
                    document.getElementById('connection-status').textContent = 'Ê¥ªË∫ç';
                }
            }, 1000);
        }
        
        // Êõ¥Êñ∞ÂêåÊ≠•Ë®àÊï∏
        function updateSyncCount() {
            latencyData.sync++;
            document.getElementById('sync-count').textContent = latencyData.sync;
        }
        
        // Ê∑ªÂä†Ê¥ªÂãïË®òÈåÑ
        function addActivity(user, action, type) {
            const activityLog = document.getElementById('activity-log');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item ' + type;
            
            const time = new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            activityItem.innerHTML = `
                <div><strong>${user}</strong> ${action}</div>
                <div class="activity-time">${time}</div>
            `;
            
            activityLog.insertBefore(activityItem, activityLog.firstChild);
            
            // ÈôêÂà∂Ë®òÈåÑÊï∏Èáè
            while (activityLog.children.length > 20) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }
        
        // ÈñãÂïüÁ¨¨‰∫åÂÄãÁ™óÂè£
        function openSecondWindow() {
            const currentUrl = window.location.href;
            window.open(currentUrl, 'user_b_window', 'width=800,height=700,left=100,top=100');
            
            addActivity('Á≥ªÁµ±', 'Â∑≤ÈñãÂïüÁî®Êà∂BÁ™óÂè£', 'system');
            document.getElementById('step-1').classList.add('completed');
            
            setTimeout(() => {
                addActivity('ÊèêÁ§∫', 'ÁèæÂú®ÂèØ‰ª•Âú®ÂÖ©ÂÄãÁ™óÂè£‰∏≠Ê∏¨Ë©¶Âçî‰Ωú‰∫ÜÔºÅ', 'system');
            }, 2000);
        }
        
        // ÈñãÂßãÂª∂ÈÅ≤Ê∏¨Ë©¶
        function startLatencyTest() {
            addActivity('Á≥ªÁµ±', 'ÈñãÂßãÂª∂ÈÅ≤Ê∏¨Ë©¶...', 'system');
            
            let testCount = 0;
            const maxTests = 5;
            
            const testInterval = setInterval(() => {
                if (testCount >= maxTests) {
                    clearInterval(testInterval);
                    addActivity('Á≥ªÁµ±', 'Âª∂ÈÅ≤Ê∏¨Ë©¶ÂÆåÊàê', 'system');
                    document.getElementById('step-4').classList.add('completed');
                    return;
                }
                
                const testData = {
                    type: 'latency_test',
                    userId: userId,
                    userName: userName,
                    testId: testCount,
                    timestamp: Date.now()
                };
                
                broadcastMessage(testData);
                testCount++;
                
                addActivity('Ê∏¨Ë©¶', `Âª∂ÈÅ≤Ê∏¨Ë©¶ ${testCount}/${maxTests}`, 'system');
            }, 800);
        }
        
        // Ê®°Êì¨Èõô‰∫∫Âçî‰Ωú
        function simulatePairwork() {
            if (isSimulating) return;
            
            isSimulating = true;
            document.getElementById('simulation-overlay').classList.add('show');
            document.getElementById('simulate-btn').disabled = true;
            document.getElementById('step-5').classList.add('completed');
            
            const collaborativeChanges = [
                { line: 8, text: '    # Áî®Êà∂BÊ∑ªÂä†ÔºöÂçî‰ΩúÈñãÂßã', action: 'Ê∑ªÂä†Ë®ªÈáã', delay: 1000 },
                { line: 12, text: '    user_b_feature = "Èõô‰∫∫Âçî‰ΩúÂäüËÉΩ"', action: 'Ê∑ªÂä†ËÆäÈáè', delay: 2000 },
                { line: 16, text: '        "Áî®Êà∂BÁöÑË≤¢Áçª",', action: 'Ê∑ªÂä†ÂàóË°®È†Ö', delay: 1500 },
                { line: 20, text: '        print(f"Áî®Êà∂B: {feature}")', action: '‰øÆÊîπ‰ª£Á¢º', delay: 2000 },
                { line: 24, text: '    print("Èõô‰∫∫Âçî‰ΩúÂÆåÊàêÔºÅ")', action: 'Ê∑ªÂä†Ëº∏Âá∫', delay: 1000 }
            ];
            
            let changeIndex = 0;
            
            function executeNextChange() {
                if (changeIndex >= collaborativeChanges.length || !isSimulating) {
                    stopSimulation();
                    return;
                }
                
                const change = collaborativeChanges[changeIndex];
                const partnerName = 'Áî®Êà∂B';
                
                // Êõ¥Êñ∞ÁãÄÊÖã
                document.getElementById('simulation-status').textContent = 
                    `${partnerName} Ê≠£Âú®: ${change.action}`;
                
                // Ê®°Êì¨Ê∏∏Ê®ôÁßªÂãï
                updateRemoteCursor('sim_user', partnerName, { line: change.line, ch: 0 });
                
                // Ê®°Êì¨‰ª£Á¢ºËÆäÊõ¥
                setTimeout(() => {
                    const currentCode = editor.getValue();
                    const lines = currentCode.split('\n');
                    
                    if (lines[change.line]) {
                        lines.splice(change.line + 1, 0, change.text);
                    } else {
                        lines.push(change.text);
                    }
                    
                    editor.setValue(lines.join('\n'));
                    addActivity(partnerName, change.action, 'edit');
                    
                    changeIndex++;
                    setTimeout(executeNextChange, change.delay);
                }, 500);
            }
            
            setTimeout(executeNextChange, 1000);
            addActivity('Á≥ªÁµ±', 'ÈñãÂßãÊ®°Êì¨Èõô‰∫∫Âçî‰Ωú', 'system');
        }
        
        // ÂÅúÊ≠¢Ê®°Êì¨
        function stopSimulation() {
            isSimulating = false;
            document.getElementById('simulation-overlay').classList.remove('show');
            document.getElementById('simulate-btn').disabled = false;
            
            // Ê∏ÖÁêÜÊ®°Êì¨Ê∏∏Ê®ô
            const simCursor = document.getElementById('cursor-sim_user');
            if (simCursor && simCursor.parentNode) {
                simCursor.parentNode.removeChild(simCursor);
            }
            
            addActivity('Á≥ªÁµ±', 'Âçî‰ΩúÊ®°Êì¨Â∑≤ÁµêÊùü', 'system');
        }
        
        // ÈáçÁΩÆÊ∏¨Ë©¶
        function resetTest() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊ∏¨Ë©¶ÂóéÔºü')) {
                location.reload();
            }
        }
        
        // È†ÅÈù¢ÈóúÈñâÊôÇÊ∏ÖÁêÜ
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('windowCount', '0');
            broadcastMessage({
                type: 'user_leave',
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
        });
    </script>
</body>
</html> 