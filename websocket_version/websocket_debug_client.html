<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket è¨ºæ–·å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; height: 400px; overflow-y: scroll; border: 1px solid #ddd; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ” WebSocket è¨ºæ–·å·¥å…·</h1>
    
    <div>
        <button id="connectBtn">é€£æ¥ WebSocket</button>
        <button id="joinRoomBtn">åŠ å…¥æˆ¿é–“</button>
        <button id="pingBtn">ç™¼é€ Ping</button>
        <button id="clearBtn">æ¸…é™¤æ—¥èªŒ</button>
        <button id="disconnectBtn">æ–·é–‹é€£æ¥</button>
    </div>
    
    <h3>é€£æ¥ç‹€æ…‹: <span id="status">æœªé€£æ¥</span></h3>
    <h3>è©³ç´°æ—¥èªŒ:</h3>
    <div id="log" class="log"></div>

    <script>
        let ws = null;
        const log = document.getElementById('log');
        const status = document.getElementById('status');

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(text, color) {
            status.textContent = text;
            status.style.color = color;
        }

        document.getElementById('connectBtn').onclick = function() {
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                addLog('WebSocket å·²ç¶“é€£æ¥', 'error');
                return;
            }

            addLog('å˜—è©¦é€£æ¥åˆ° ws://localhost:8080...', 'info');
            updateStatus('é€£æ¥ä¸­...', 'orange');

            try {
                ws = new WebSocket('ws://localhost:8080');

                ws.onopen = function(event) {
                    addLog('âœ… WebSocket é€£æ¥æˆåŠŸ', 'success');
                    updateStatus('å·²é€£æ¥', 'green');
                };

                ws.onmessage = function(event) {
                    addLog('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + event.data, 'info');
                    
                    try {
                        const data = JSON.parse(event.data);
                        addLog('  -> é¡å‹: ' + data.type, 'info');
                        if (data.type === 'error') {
                            addLog('  -> éŒ¯èª¤: ' + data.message, 'error');
                        }
                    } catch (e) {
                        addLog('  -> ç„¡æ³•è§£æJSON: ' + e.message, 'error');
                    }
                };

                ws.onclose = function(event) {
                    addLog(`âŒ é€£æ¥é—œé–‰ - ä»£ç¢¼: ${event.code}, åŸå› : ${event.reason || 'æœªçŸ¥'}`, 'error');
                    updateStatus('å·²æ–·é–‹', 'red');
                    
                    // è©³ç´°çš„é—œé–‰ä»£ç¢¼èªªæ˜
                    let codeDescription = '';
                    switch(event.code) {
                        case 1000: codeDescription = 'æ­£å¸¸é—œé–‰'; break;
                        case 1001: codeDescription = 'ç«¯é»é›¢é–‹'; break;
                        case 1002: codeDescription = 'å”è­°éŒ¯èª¤'; break;
                        case 1003: codeDescription = 'æ•¸æ“šé¡å‹éŒ¯èª¤'; break;
                        case 1006: codeDescription = 'ç•°å¸¸é—œé–‰ (å¯èƒ½æ˜¯æœå‹™å™¨å´©æ½°)'; break;
                        case 1007: codeDescription = 'æ•¸æ“šæ ¼å¼éŒ¯èª¤'; break;
                        case 1008: codeDescription = 'é•åæ”¿ç­–'; break;
                        case 1009: codeDescription = 'æ¶ˆæ¯éå¤§'; break;
                        case 1010: codeDescription = 'æ“´å±•å”å•†å¤±æ•—'; break;
                        case 1011: codeDescription = 'æœå‹™å™¨é‡åˆ°æ„å¤–éŒ¯èª¤'; break;
                        default: codeDescription = 'æœªçŸ¥éŒ¯èª¤ä»£ç¢¼';
                    }
                    addLog(`  -> é—œé–‰ä»£ç¢¼èªªæ˜: ${codeDescription}`, 'error');
                };

                ws.onerror = function(error) {
                    addLog('âŒ WebSocket éŒ¯èª¤: ' + error, 'error');
                    updateStatus('éŒ¯èª¤', 'red');
                };

            } catch (e) {
                addLog('âŒ å‰µå»º WebSocket å¤±æ•—: ' + e.message, 'error');
                updateStatus('å‰µå»ºå¤±æ•—', 'red');
            }
        };

        document.getElementById('joinRoomBtn').onclick = function() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('è«‹å…ˆé€£æ¥ WebSocket', 'error');
                return;
            }

            const message = {
                action: 'join_room',
                room: 'test_room',
                user_id: 'debug_user_' + Math.random().toString(36).substr(2, 9),
                user_name: 'èª¿è©¦ç”¨æˆ¶'
            };

            addLog('ç™¼é€åŠ å…¥æˆ¿é–“è«‹æ±‚: ' + JSON.stringify(message), 'info');
            ws.send(JSON.stringify(message));
        };

        document.getElementById('pingBtn').onclick = function() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('è«‹å…ˆé€£æ¥ WebSocket', 'error');
                return;
            }

            const message = {
                action: 'ping',
                timestamp: Date.now()
            };

            addLog('ç™¼é€ Ping: ' + JSON.stringify(message), 'info');
            ws.send(JSON.stringify(message));
        };

        document.getElementById('clearBtn').onclick = function() {
            log.innerHTML = '';
        };

        document.getElementById('disconnectBtn').onclick = function() {
            if (ws) {
                addLog('ä¸»å‹•æ–·é–‹é€£æ¥', 'info');
                ws.close(1000, 'ç”¨æˆ¶ä¸»å‹•æ–·é–‹');
            }
        };

        // é é¢å¸è¼‰æ™‚é—œé–‰é€£æ¥
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html> 