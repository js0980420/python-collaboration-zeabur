<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Pythonå¤šäººå”ä½œå­¸ç¿’å¹³å° - å¯¦æ¸¬ç‰ˆ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .collaboration-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
        }
        
        .editor-container {
            height: 400px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .CodeMirror {
            height: 100%;
            font-size: 14px;
        }
        
        .users-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
        }
        
        .user-item {
            background: white;
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #007bff;
        }
        
        .user-item.online {
            border-left-color: #28a745;
        }
        
        .chat-container {
            height: 250px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .chat-input {
            border-top: 1px solid #dee2e6;
            padding: 0.5rem;
            background: white;
        }
        
        .message {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: white;
            border-left: 3px solid #007bff;
        }
        
        .message.own {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .message.system {
            background: #fff3e0;
            border-left-color: #ff9800;
            font-style: italic;
        }
        
        .message.ai {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .status-panel {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .conflict-alert {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .ai-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .cursor-indicator {
            position: absolute;
            border-left: 2px solid;
            height: 20px;
            z-index: 100;
            pointer-events: none;
        }
        
        .cursor-label {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            top: -20px;
            left: -5px;
        }
        
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-indicator.connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .sync-indicator.disconnected {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .version-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <header class="collaboration-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        ğŸ Pythonå”ä½œå­¸ç¿’å¹³å°
                        <small class="d-block mt-1">PHP + Ratchet + MySQL + OpenAI</small>
                    </h1>
                </div>
                <div class="col-md-6 text-end">
                    <div id="connectionStatus" class="badge bg-secondary">
                        <span class="sync-indicator disconnected"></span>
                        æœªé€£æ¥
                    </div>
                    <div id="versionInfo" class="version-info mt-1">
                        ç‰ˆæœ¬: <span id="currentVersion">0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-4">
        <!-- é€£æ¥æ§åˆ¶ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="userName" class="form-label">æ‚¨çš„å§“åï¼š</label>
                                <input type="text" class="form-control" id="userName" placeholder="è¼¸å…¥æ‚¨çš„å§“å">
                            </div>
                            <div class="col-md-4">
                                <label for="roomId" class="form-label">æˆ¿é–“è™Ÿç¢¼ï¼š</label>
                                <input type="text" class="form-control" id="roomId" placeholder="ä¾‹å¦‚ï¼šroom123">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="connectBtn" class="btn btn-primary me-2">
                                    <i class="fas fa-plug"></i> é€£æ¥
                                </button>
                                <button id="disconnectBtn" class="btn btn-secondary" disabled>
                                    <i class="fas fa-times"></i> æ–·é–‹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¡çªè­¦å‘Š -->
        <div id="conflictAlert" class="conflict-alert" style="display: none;">
            <h5><i class="fas fa-exclamation-triangle"></i> ç¨‹å¼ç¢¼è¡çªæª¢æ¸¬</h5>
            <p id="conflictMessage"></p>
            <div class="btn-group">
                <button id="acceptConflict" class="btn btn-warning">ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬</button>
                <button id="overrideConflict" class="btn btn-danger">è¦†è“‹ç‚ºæˆ‘çš„ç‰ˆæœ¬</button>
                <button id="mergeConflict" class="btn btn-info">æ‰‹å‹•åˆä½µ</button>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="row">
            <!-- å·¦å´ï¼šç¨‹å¼ç¢¼ç·¨è¼¯å™¨ -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-code"></i> Pythonå”ä½œç·¨è¼¯å™¨
                        </h5>
                        <div>
                            <button id="runCode" class="btn btn-success btn-sm">
                                <i class="fas fa-play"></i> é‹è¡Œ
                            </button>
                            <button id="saveCode" class="btn btn-info btn-sm">
                                <i class="fas fa-save"></i> ä¿å­˜
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="editor-container">
                            <textarea id="codeEditor" placeholder="# é–‹å§‹å”ä½œç·¨ç¨‹å§ï¼"></textarea>
                        </div>
                    </div>
                </div>

                <!-- AIåŠ©æ•™é¢æ¿ -->
                <div class="ai-panel">
                    <h6><i class="fas fa-robot"></i> AIç¨‹å¼è¨­è¨ˆåŠ©æ•™</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <button id="explainCode" class="btn btn-outline-primary btn-sm w-100 mb-2">
                                <i class="fas fa-question-circle"></i> è§£é‡‹ç¨‹å¼ç¢¼
                            </button>
                            <button id="findBugs" class="btn btn-outline-warning btn-sm w-100">
                                <i class="fas fa-bug"></i> å°‹æ‰¾éŒ¯èª¤
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="improveCode" class="btn btn-outline-success btn-sm w-100 mb-2">
                                <i class="fas fa-magic"></i> æ”¹é€²å»ºè­°
                            </button>
                            <button id="helpCollaboration" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-users"></i> å”ä½œæŒ‡å°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šç”¨æˆ¶å’ŒèŠå¤© -->
            <div class="col-md-4">
                <!-- åœ¨ç·šç”¨æˆ¶ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-users"></i> åœ¨ç·šæˆå“¡ <span id="userCount" class="badge bg-primary">0</span></h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="usersList" class="users-panel">
                            <div class="text-muted text-center">
                                <i class="fas fa-user-slash"></i><br>
                                å°šæœªé€£æ¥åˆ°æˆ¿é–“
                            </div>
                        </div>
                    </div>
                </div>

                <!-- èŠå¤©åŠŸèƒ½ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-comments"></i> å”ä½œè¨è«–</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="chat-container">
                            <div id="chatMessages" class="chat-messages">
                                <div class="message system">
                                    <small class="text-muted">ç³»çµ±</small><br>
                                    æ­¡è¿ä¾†åˆ°å”ä½œèŠå¤©å®¤ï¼
                                </div>
                            </div>
                            <div class="chat-input">
                                <div class="input-group">
                                    <input type="text" id="chatInput" class="form-control" placeholder="è¼¸å…¥è¨Šæ¯..." disabled>
                                    <button id="sendChat" class="btn btn-primary" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŒæ­¥æ¸¬è©¦æ§åˆ¶ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-sync"></i> å”ä½œæ¸¬è©¦æ§åˆ¶å°</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button id="simulateConflict" class="btn btn-warning w-100">
                                    <i class="fas fa-exclamation-triangle"></i><br>
                                    æ¨¡æ“¬è¡çª
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="testSync" class="btn btn-info w-100">
                                    <i class="fas fa-sync-alt"></i><br>
                                    æ¸¬è©¦åŒæ­¥
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="stressTest" class="btn btn-secondary w-100">
                                    <i class="fas fa-tachometer-alt"></i><br>
                                    å£“åŠ›æ¸¬è©¦
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="measureLatency" class="btn btn-success w-100">
                                    <i class="fas fa-stopwatch"></i><br>
                                    æ¸¬é‡å»¶é²
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ¸¬è©¦çµæœ -->
                        <div id="testResults" class="mt-3">
                            <h6>æ¸¬è©¦çµæœï¼š</h6>
                            <div id="latencyResult" class="alert alert-info" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScriptä¾è³´ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <script>
    class CollaborationClient {
        constructor() {
            this.ws = null;
            this.currentUser = null;
            this.currentRoom = null;
            this.editor = null;
            this.currentVersion = 0;
            this.isConnected = false;
            this.users = new Map();
            this.cursors = new Map();
            this.latencyTest = {
                start: 0,
                results: []
            };
            
            this.initializeEditor();
            this.initializeEventListeners();
        }

        initializeEditor() {
            this.editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                indentUnit: 4,
                lineWrapping: true,
                autoCloseBrackets: true,
                matchBrackets: true
            });

            // ç›£è½ä»£ç¢¼è®Šæ›´
            this.editor.on('change', (instance, change) => {
                if (change.origin !== 'setValue' && this.isConnected) {
                    this.sendCodeChange();
                }
            });

            // ç›£è½å…‰æ¨™è®Šæ›´
            this.editor.on('cursorActivity', () => {
                if (this.isConnected) {
                    this.sendCursorChange();
                }
            });
        }

        initializeEventListeners() {
            // é€£æ¥æ§åˆ¶
            document.getElementById('connectBtn').addEventListener('click', () => this.connect());
            document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());

            // èŠå¤©åŠŸèƒ½
            document.getElementById('sendChat').addEventListener('click', () => this.sendChat());
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.sendChat();
            });

            // AIåŠ©æ•™åŠŸèƒ½
            document.getElementById('explainCode').addEventListener('click', () => this.requestAI('explain_code'));
            document.getElementById('findBugs').addEventListener('click', () => this.requestAI('find_bugs'));
            document.getElementById('improveCode').addEventListener('click', () => this.requestAI('suggest_improvement'));
            document.getElementById('helpCollaboration').addEventListener('click', () => this.requestAI('help_collaboration'));

            // è¡çªè™•ç†
            document.getElementById('acceptConflict').addEventListener('click', () => this.resolveConflict('accept'));
            document.getElementById('overrideConflict').addEventListener('click', () => this.resolveConflict('override'));
            document.getElementById('mergeConflict').addEventListener('click', () => this.resolveConflict('merge'));

            // æ¸¬è©¦æ§åˆ¶
            document.getElementById('simulateConflict').addEventListener('click', () => this.simulateConflict());
            document.getElementById('testSync').addEventListener('click', () => this.testSync());
            document.getElementById('stressTest').addEventListener('click', () => this.stressTest());
            document.getElementById('measureLatency').addEventListener('click', () => this.measureLatency());
        }

        connect() {
            const userName = document.getElementById('userName').value.trim();
            const roomId = document.getElementById('roomId').value.trim();

            if (!userName || !roomId) {
                alert('è«‹è¼¸å…¥å§“åå’Œæˆ¿é–“è™Ÿç¢¼');
                return;
            }

            try {
                this.ws = new WebSocket('ws://localhost:8080');
                
                this.ws.onopen = () => {
                    console.log('WebSocketé€£æ¥æˆåŠŸ');
                    this.updateConnectionStatus(true);
                    
                    // åŠ å…¥æˆ¿é–“
                    this.sendMessage({
                        type: 'join_room',
                        roomId: roomId,
                        userName: userName
                    });
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    } catch (error) {
                        console.error('æ¶ˆæ¯è§£æéŒ¯èª¤:', error);
                    }
                };

                this.ws.onclose = () => {
                    console.log('WebSocketé€£æ¥é—œé–‰');
                    this.updateConnectionStatus(false);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocketéŒ¯èª¤:', error);
                    alert('é€£æ¥å¤±æ•—ï¼è«‹ç¢ºèªWebSocketæœå‹™å™¨å·²å•Ÿå‹• (php websocket_server/websocket_server.php)');
                };

            } catch (error) {
                console.error('é€£æ¥éŒ¯èª¤:', error);
                alert('é€£æ¥å¤±æ•—ï¼š' + error.message);
            }
        }

        disconnect() {
            if (this.ws) {
                this.ws.close();
            }
            this.updateConnectionStatus(false);
        }

        sendMessage(message) {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify(message));
            }
        }

        handleMessage(message) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

            switch (message.type) {
                case 'welcome':
                    this.currentUser = message.userId;
                    break;

                case 'room_joined':
                    this.currentRoom = message.roomId;
                    this.currentVersion = message.version;
                    this.editor.setValue(message.code);
                    this.updateUsers(message.users);
                    this.addSystemMessage(`æˆåŠŸåŠ å…¥æˆ¿é–“ ${message.roomId}`);
                    document.getElementById('currentVersion').textContent = this.currentVersion;
                    break;

                case 'user_joined':
                    this.updateUsers(message.users);
                    this.addSystemMessage(`${message.userName} åŠ å…¥äº†æˆ¿é–“`);
                    break;

                case 'user_left':
                    this.updateUsers(message.users);
                    this.addSystemMessage(`${message.userName} é›¢é–‹äº†æˆ¿é–“`);
                    break;

                case 'code_updated':
                    this.currentVersion = message.version;
                    this.editor.setValue(message.code);
                    document.getElementById('currentVersion').textContent = this.currentVersion;
                    this.addSystemMessage(`${message.userName} æ›´æ–°äº†ç¨‹å¼ç¢¼ (ç‰ˆæœ¬ ${message.version})`);
                    break;

                case 'cursor_updated':
                    this.updateCursor(message.userId, message.userName, message.cursor);
                    break;

                case 'chat_message':
                    this.addChatMessage(message.userName, message.message, message.userId === this.currentUser);
                    break;

                case 'conflict_detected':
                    this.showConflictAlert(message);
                    break;

                case 'ai_response':
                    this.addAIMessage(`AIåŠ©æ•™ (${message.action})`, message.response);
                    break;

                case 'ai_shared_response':
                    this.addAIMessage(`${message.userName} çš„AIåŠ©æ•™`, message.response);
                    break;

                case 'ai_error':
                    this.addSystemMessage(`AIéŒ¯èª¤: ${message.message}`);
                    break;

                case 'pong':
                    if (this.latencyTest.start > 0) {
                        const latency = Date.now() - this.latencyTest.start;
                        this.latencyTest.results.push(latency);
                        this.showLatencyResult(latency);
                        this.latencyTest.start = 0;
                    }
                    break;
            }
        }

        sendCodeChange() {
            const code = this.editor.getValue();
            this.sendMessage({
                type: 'code_change',
                code: code,
                version: this.currentVersion
            });
        }

        sendCursorChange() {
            const cursor = this.editor.getCursor();
            this.sendMessage({
                type: 'cursor_change',
                cursor: cursor
            });
        }

        sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && this.isConnected) {
                this.sendMessage({
                    type: 'chat_message',
                    message: message
                });
                input.value = '';
            }
        }

        requestAI(action) {
            const code = this.editor.getValue();
            const data = { code: code };

            if (action === 'help_collaboration') {
                data.situation = 'éœ€è¦å”ä½œç·¨ç¨‹æŒ‡å°';
            }

            this.sendMessage({
                type: 'ai_request',
                action: action,
                data: data
            });

            this.addSystemMessage(`æ­£åœ¨è«‹æ±‚AIåŠ©æ•™å”åŠ©: ${action}`);
        }

        showConflictAlert(conflictData) {
            document.getElementById('conflictMessage').textContent = conflictData.message;
            document.getElementById('conflictAlert').style.display = 'block';
            
            // å­˜å„²è¡çªæ•¸æ“šä¾›å¾ŒçºŒè™•ç†
            this.conflictData = conflictData;
        }

        resolveConflict(action) {
            switch (action) {
                case 'accept':
                    // æ¥å—æœ€æ–°ç‰ˆæœ¬
                    this.currentVersion = this.conflictData.currentVersion;
                    this.editor.setValue(this.conflictData.currentCode);
                    document.getElementById('currentVersion').textContent = this.currentVersion;
                    this.addSystemMessage('å·²æ¥å—æœ€æ–°ç‰ˆæœ¬');
                    break;

                case 'override':
                    // å¼·åˆ¶ä½¿ç”¨è‡ªå·±çš„ç‰ˆæœ¬
                    this.sendCodeChange();
                    this.addSystemMessage('å·²è¦†è“‹ç‚ºæ‚¨çš„ç‰ˆæœ¬');
                    break;

                case 'merge':
                    // æ‰‹å‹•åˆä½µï¼ˆç°¡åŒ–ç‰ˆï¼‰
                    const myCode = this.editor.getValue();
                    const theirCode = this.conflictData.currentCode;
                    const mergedCode = `# === åˆä½µç‰ˆæœ¬ ===\n# æ‚¨çš„ç‰ˆæœ¬:\n${myCode}\n\n# === åˆ†éš”ç·š ===\n# ä»–äººç‰ˆæœ¬:\n${theirCode}`;
                    this.editor.setValue(mergedCode);
                    this.addSystemMessage('å·²å‰µå»ºåˆä½µç‰ˆæœ¬ï¼Œè«‹æ‰‹å‹•æ•´ç†');
                    break;
            }

            document.getElementById('conflictAlert').style.display = 'none';
        }

        // æ¸¬è©¦åŠŸèƒ½
        simulateConflict() {
            this.addSystemMessage('æ¨¡æ“¬è¡çªï¼šæ­£åœ¨æ•…æ„ç™¼é€èˆŠç‰ˆæœ¬...');
            this.sendMessage({
                type: 'code_change',
                code: this.editor.getValue() + '\n# æ¨¡æ“¬è¡çª',
                version: Math.max(0, this.currentVersion - 1) // æ•…æ„ä½¿ç”¨èˆŠç‰ˆæœ¬è™Ÿ
            });
        }

        testSync() {
            const testCode = `# åŒæ­¥æ¸¬è©¦ ${new Date().toLocaleTimeString()}\nprint("æ¸¬è©¦åŒæ­¥åŠŸèƒ½")`;
            this.editor.setValue(testCode);
            this.sendCodeChange();
            this.addSystemMessage('åŒæ­¥æ¸¬è©¦ï¼šå·²ç™¼é€æ¸¬è©¦ä»£ç¢¼');
        }

        stressTest() {
            this.addSystemMessage('é–‹å§‹å£“åŠ›æ¸¬è©¦ï¼šé€£çºŒç™¼é€10æ¬¡ä»£ç¢¼è®Šæ›´...');
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const testCode = this.editor.getValue() + `\n# å£“åŠ›æ¸¬è©¦ ${i + 1}`;
                    this.editor.setValue(testCode);
                    this.sendCodeChange();
                }, i * 100);
            }
        }

        measureLatency() {
            this.latencyTest.start = Date.now();
            this.sendMessage({ type: 'ping' });
            this.addSystemMessage('æ­£åœ¨æ¸¬é‡å»¶é²...');
        }

        showLatencyResult(latency) {
            const resultDiv = document.getElementById('latencyResult');
            resultDiv.innerHTML = `
                <strong>å»¶é²æ¸¬è©¦çµæœï¼š</strong> ${latency}ms<br>
                <small>å¹³å‡å»¶é²ï¼š${Math.round(this.latencyTest.results.reduce((a, b) => a + b, 0) / this.latencyTest.results.length)}ms 
                (${this.latencyTest.results.length} æ¬¡æ¸¬è©¦)</small>
            `;
            resultDiv.style.display = 'block';
        }

        updateConnectionStatus(connected) {
            this.isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');
            const indicator = statusElement.querySelector('.sync-indicator');
            
            if (connected) {
                statusElement.innerHTML = '<span class="sync-indicator connected"></span>å·²é€£æ¥';
                statusElement.className = 'badge bg-success';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendChat').disabled = false;
            } else {
                statusElement.innerHTML = '<span class="sync-indicator disconnected"></span>æœªé€£æ¥';
                statusElement.className = 'badge bg-secondary';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('chatInput').disabled = true;
                document.getElementById('sendChat').disabled = true;
            }
        }

        updateUsers(users) {
            const usersList = document.getElementById('usersList');
            const userCount = document.getElementById('userCount');
            
            usersList.innerHTML = '';
            userCount.textContent = users.length;
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `user-item ${user.id === this.currentUser ? 'own' : 'online'}`;
                userElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-user"></i> ${user.name}
                            ${user.id === this.currentUser ? '(æ‚¨)' : ''}
                        </span>
                        <small class="text-muted">ç·šä¸Š</small>
                    </div>
                `;
                usersList.appendChild(userElement);
            });
        }

        updateCursor(userId, userName, cursor) {
            // ç°¡åŒ–çš„å…‰æ¨™é¡¯ç¤º
            console.log(`${userName} çš„å…‰æ¨™ä½ç½®:`, cursor);
        }

        addChatMessage(userName, message, isOwn = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOwn ? 'own' : ''}`;
            messageElement.innerHTML = `
                <small class="text-muted">${userName}</small><br>
                ${message}
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        addSystemMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <small class="text-muted">ç³»çµ±</small><br>
                <i class="fas fa-info-circle"></i> ${message}
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        addAIMessage(title, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message ai';
            messageElement.innerHTML = `
                <small class="text-muted">${title}</small><br>
                <i class="fas fa-robot"></i> ${message}
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // åˆå§‹åŒ–å®¢æˆ¶ç«¯
    const client = new CollaborationClient();

    // é é¢è¼‰å…¥å®Œæˆå¾Œçš„æç¤º
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ Pythonå”ä½œå­¸ç¿’å¹³å°å·²è¼‰å…¥');
        console.log('ğŸ“¡ è«‹ç¢ºèªWebSocketæœå‹™å™¨å·²å•Ÿå‹•ï¼šphp websocket_server/websocket_server.php');
        
        // è¨­ç½®é è¨­å€¼
        document.getElementById('userName').value = `æ¸¬è©¦ç”¨æˆ¶${Math.floor(Math.random() * 100)}`;
        document.getElementById('roomId').value = 'test-room';
    });
    </script>
</body>
</html> 