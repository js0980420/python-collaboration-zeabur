<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🐍 Python多人協作學習平台 - 實測版</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .collaboration-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
        }
        
        .editor-container {
            height: 400px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .CodeMirror {
            height: 100%;
            font-size: 14px;
        }
        
        .users-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
        }
        
        .user-item {
            background: white;
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #007bff;
        }
        
        .user-item.online {
            border-left-color: #28a745;
        }
        
        .chat-container {
            height: 250px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .chat-input {
            border-top: 1px solid #dee2e6;
            padding: 0.5rem;
            background: white;
        }
        
        .message {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            background: white;
            border-left: 3px solid #007bff;
        }
        
        .message.own {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .message.system {
            background: #fff3e0;
            border-left-color: #ff9800;
            font-style: italic;
        }
        
        .message.ai {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }
        
        .status-panel {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .conflict-alert {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .ai-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .cursor-indicator {
            position: absolute;
            border-left: 2px solid;
            height: 20px;
            z-index: 100;
            pointer-events: none;
        }
        
        .cursor-label {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            top: -20px;
            left: -5px;
        }
        
        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-indicator.connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .sync-indicator.disconnected {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .version-info {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- 頂部導航 -->
    <header class="collaboration-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        🐍 Python協作學習平台
                        <small class="d-block mt-1">PHP + Ratchet + MySQL + OpenAI</small>
                    </h1>
                </div>
                <div class="col-md-6 text-end">
                    <div id="connectionStatus" class="badge bg-secondary">
                        <span class="sync-indicator disconnected"></span>
                        未連接
                    </div>
                    <div id="versionInfo" class="version-info mt-1">
                        版本: <span id="currentVersion">0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-4">
        <!-- 連接控制 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="userName" class="form-label">您的姓名：</label>
                                <input type="text" class="form-control" id="userName" placeholder="輸入您的姓名">
                            </div>
                            <div class="col-md-4">
                                <label for="roomId" class="form-label">房間號碼：</label>
                                <input type="text" class="form-control" id="roomId" placeholder="例如：room123">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="connectBtn" class="btn btn-primary me-2">
                                    <i class="fas fa-plug"></i> 連接
                                </button>
                                <button id="disconnectBtn" class="btn btn-secondary" disabled>
                                    <i class="fas fa-times"></i> 斷開
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 衝突警告 -->
        <div id="conflictAlert" class="conflict-alert" style="display: none;">
            <h5><i class="fas fa-exclamation-triangle"></i> 程式碼衝突檢測</h5>
            <p id="conflictMessage"></p>
            <div class="btn-group">
                <button id="acceptConflict" class="btn btn-warning">使用最新版本</button>
                <button id="overrideConflict" class="btn btn-danger">覆蓋為我的版本</button>
                <button id="mergeConflict" class="btn btn-info">手動合併</button>
            </div>
        </div>

        <!-- 主要內容 -->
        <div class="row">
            <!-- 左側：程式碼編輯器 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-code"></i> Python協作編輯器
                        </h5>
                        <div>
                            <button id="runCode" class="btn btn-success btn-sm">
                                <i class="fas fa-play"></i> 運行
                            </button>
                            <button id="saveCode" class="btn btn-info btn-sm">
                                <i class="fas fa-save"></i> 保存
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="editor-container">
                            <textarea id="codeEditor" placeholder="# 開始協作編程吧！"></textarea>
                        </div>
                    </div>
                </div>

                <!-- AI助教面板 -->
                <div class="ai-panel">
                    <h6><i class="fas fa-robot"></i> AI程式設計助教</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <button id="explainCode" class="btn btn-outline-primary btn-sm w-100 mb-2">
                                <i class="fas fa-question-circle"></i> 解釋程式碼
                            </button>
                            <button id="findBugs" class="btn btn-outline-warning btn-sm w-100">
                                <i class="fas fa-bug"></i> 尋找錯誤
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="improveCode" class="btn btn-outline-success btn-sm w-100 mb-2">
                                <i class="fas fa-magic"></i> 改進建議
                            </button>
                            <button id="helpCollaboration" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-users"></i> 協作指導
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：用戶和聊天 -->
            <div class="col-md-4">
                <!-- 在線用戶 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-users"></i> 在線成員 <span id="userCount" class="badge bg-primary">0</span></h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="usersList" class="users-panel">
                            <div class="text-muted text-center">
                                <i class="fas fa-user-slash"></i><br>
                                尚未連接到房間
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 聊天功能 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-comments"></i> 協作討論</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="chat-container">
                            <div id="chatMessages" class="chat-messages">
                                <div class="message system">
                                    <small class="text-muted">系統</small><br>
                                    歡迎來到協作聊天室！
                                </div>
                            </div>
                            <div class="chat-input">
                                <div class="input-group">
                                    <input type="text" id="chatInput" class="form-control" placeholder="輸入訊息..." disabled>
                                    <button id="sendChat" class="btn btn-primary" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 同步測試控制 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-sync"></i> 協作測試控制台</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button id="simulateConflict" class="btn btn-warning w-100">
                                    <i class="fas fa-exclamation-triangle"></i><br>
                                    模擬衝突
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="testSync" class="btn btn-info w-100">
                                    <i class="fas fa-sync-alt"></i><br>
                                    測試同步
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="stressTest" class="btn btn-secondary w-100">
                                    <i class="fas fa-tachometer-alt"></i><br>
                                    壓力測試
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="measureLatency" class="btn btn-success w-100">
                                    <i class="fas fa-stopwatch"></i><br>
                                    測量延遲
                                </button>
                            </div>
                        </div>
                        
                        <!-- 測試結果 -->
                        <div id="testResults" class="mt-3">
                            <h6>測試結果：</h6>
                            <div id="latencyResult" class="alert alert-info" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript依賴 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <script>
    class CollaborationClient {
        constructor() {
            this.ws = null;
            this.currentUser = null;
            this.currentRoom = null;
            this.editor = null;
            this.currentVersion = 0;
            this.isConnected = false;
            this.users = new Map();
            this.cursors = new Map();
            this.latencyTest = {
                start: 0,
                results: []
            };
            
            this.initializeEditor();
            this.initializeEventListeners();
        }

        initializeEditor() {
            this.editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                indentUnit: 4,
                lineWrapping: true,
                autoCloseBrackets: true,
                matchBrackets: true
            });

            // 監聽代碼變更
            this.editor.on('change', (instance, change) => {
                if (change.origin !== 'setValue' && this.isConnected) {
                    this.sendCodeChange();
                }
            });

            // 監聽光標變更
            this.editor.on('cursorActivity', () => {
                if (this.isConnected) {
                    this.sendCursorChange();
                }
            });
        }

        initializeEventListeners() {
            // 連接控制
            document.getElementById('connectBtn').addEventListener('click', () => this.connect());
            document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());

            // 聊天功能
            document.getElementById('sendChat').addEventListener('click', () => this.sendChat());
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.sendChat();
            });

            // AI助教功能
            document.getElementById('explainCode').addEventListener('click', () => this.requestAI('explain_code'));
            document.getElementById('findBugs').addEventListener('click', () => this.requestAI('find_bugs'));
            document.getElementById('improveCode').addEventListener('click', () => this.requestAI('suggest_improvement'));
            document.getElementById('helpCollaboration').addEventListener('click', () => this.requestAI('help_collaboration'));

            // 衝突處理
            document.getElementById('acceptConflict').addEventListener('click', () => this.resolveConflict('accept'));
            document.getElementById('overrideConflict').addEventListener('click', () => this.resolveConflict('override'));
            document.getElementById('mergeConflict').addEventListener('click', () => this.resolveConflict('merge'));

            // 測試控制
            document.getElementById('simulateConflict').addEventListener('click', () => this.simulateConflict());
            document.getElementById('testSync').addEventListener('click', () => this.testSync());
            document.getElementById('stressTest').addEventListener('click', () => this.stressTest());
            document.getElementById('measureLatency').addEventListener('click', () => this.measureLatency());
        }

        connect() {
            const userName = document.getElementById('userName').value.trim();
            const roomId = document.getElementById('roomId').value.trim();

            if (!userName || !roomId) {
                alert('請輸入姓名和房間號碼');
                return;
            }

            try {
                this.ws = new WebSocket('ws://localhost:8080');
                
                this.ws.onopen = () => {
                    console.log('WebSocket連接成功');
                    this.updateConnectionStatus(true);
                    
                    // 加入房間
                    this.sendMessage({
                        type: 'join_room',
                        roomId: roomId,
                        userName: userName
                    });
                };

                this.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    } catch (error) {
                        console.error('消息解析錯誤:', error);
                    }
                };

                this.ws.onclose = () => {
                    console.log('WebSocket連接關閉');
                    this.updateConnectionStatus(false);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket錯誤:', error);
                    alert('連接失敗！請確認WebSocket服務器已啟動 (php websocket_server/websocket_server.php)');
                };

            } catch (error) {
                console.error('連接錯誤:', error);
                alert('連接失敗：' + error.message);
            }
        }

        disconnect() {
            if (this.ws) {
                this.ws.close();
            }
            this.updateConnectionStatus(false);
        }

        sendMessage(message) {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify(message));
            }
        }

        handleMessage(message) {
            console.log('收到消息:', message);

            switch (message.type) {
                case 'welcome':
                    this.currentUser = message.userId;
                    break;

                case 'room_joined':
                    this.currentRoom = message.roomId;
                    this.currentVersion = message.version;
                    this.editor.setValue(message.code);
                    this.updateUsers(message.users);
                    this.addSystemMessage(`成功加入房間 ${message.roomId}`);
                    document.getElementById('currentVersion').textContent = this.currentVersion;
                    break;

                case 'user_joined':
                    this.updateUsers(message.users);
                    this.addSystemMessage(`${message.userName} 加入了房間`);
                    break;

                case 'user_left':
                    this.updateUsers(message.users);
                    this.addSystemMessage(`${message.userName} 離開了房間`);
                    break;

                case 'code_updated':
                    this.currentVersion = message.version;
                    this.editor.setValue(message.code);
                    document.getElementById('currentVersion').textContent = this.currentVersion;
                    this.addSystemMessage(`${message.userName} 更新了程式碼 (版本 ${message.version})`);
                    break;

                case 'cursor_updated':
                    this.updateCursor(message.userId, message.userName, message.cursor);
                    break;

                case 'chat_message':
                    this.addChatMessage(message.userName, message.message, message.userId === this.currentUser);
                    break;

                case 'conflict_detected':
                    this.showConflictAlert(message);
                    break;

                case 'ai_response':
                    this.addAIMessage(`AI助教 (${message.action})`, message.response);
                    break;

                case 'ai_shared_response':
                    this.addAIMessage(`${message.userName} 的AI助教`, message.response);
                    break;

                case 'ai_error':
                    this.addSystemMessage(`AI錯誤: ${message.message}`);
                    break;

                case 'pong':
                    if (this.latencyTest.start > 0) {
                        const latency = Date.now() - this.latencyTest.start;
                        this.latencyTest.results.push(latency);
                        this.showLatencyResult(latency);
                        this.latencyTest.start = 0;
                    }
                    break;
            }
        }

        sendCodeChange() {
            const code = this.editor.getValue();
            this.sendMessage({
                type: 'code_change',
                code: code,
                version: this.currentVersion
            });
        }

        sendCursorChange() {
            const cursor = this.editor.getCursor();
            this.sendMessage({
                type: 'cursor_change',
                cursor: cursor
            });
        }

        sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && this.isConnected) {
                this.sendMessage({
                    type: 'chat_message',
                    message: message
                });
                input.value = '';
            }
        }

        requestAI(action) {
            const code = this.editor.getValue();
            const data = { code: code };

            if (action === 'help_collaboration') {
                data.situation = '需要協作編程指導';
            }

            this.sendMessage({
                type: 'ai_request',
                action: action,
                data: data
            });

            this.addSystemMessage(`正在請求AI助教協助: ${action}`);
        }

        showConflictAlert(conflictData) {
            document.getElementById('conflictMessage').textContent = conflictData.message;
            document.getElementById('conflictAlert').style.display = 'block';
            
            // 存儲衝突數據供後續處理
            this.conflictData = conflictData;
        }

        resolveConflict(action) {
            switch (action) {
                case 'accept':
                    // 接受最新版本
                    this.currentVersion = this.conflictData.currentVersion;
                    this.editor.setValue(this.conflictData.currentCode);
                    document.getElementById('currentVersion').textContent = this.currentVersion;
                    this.addSystemMessage('已接受最新版本');
                    break;

                case 'override':
                    // 強制使用自己的版本
                    this.sendCodeChange();
                    this.addSystemMessage('已覆蓋為您的版本');
                    break;

                case 'merge':
                    // 手動合併（簡化版）
                    const myCode = this.editor.getValue();
                    const theirCode = this.conflictData.currentCode;
                    const mergedCode = `# === 合併版本 ===\n# 您的版本:\n${myCode}\n\n# === 分隔線 ===\n# 他人版本:\n${theirCode}`;
                    this.editor.setValue(mergedCode);
                    this.addSystemMessage('已創建合併版本，請手動整理');
                    break;
            }

            document.getElementById('conflictAlert').style.display = 'none';
        }

        // 測試功能
        simulateConflict() {
            this.addSystemMessage('模擬衝突：正在故意發送舊版本...');
            this.sendMessage({
                type: 'code_change',
                code: this.editor.getValue() + '\n# 模擬衝突',
                version: Math.max(0, this.currentVersion - 1) // 故意使用舊版本號
            });
        }

        testSync() {
            const testCode = `# 同步測試 ${new Date().toLocaleTimeString()}\nprint("測試同步功能")`;
            this.editor.setValue(testCode);
            this.sendCodeChange();
            this.addSystemMessage('同步測試：已發送測試代碼');
        }

        stressTest() {
            this.addSystemMessage('開始壓力測試：連續發送10次代碼變更...');
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const testCode = this.editor.getValue() + `\n# 壓力測試 ${i + 1}`;
                    this.editor.setValue(testCode);
                    this.sendCodeChange();
                }, i * 100);
            }
        }

        measureLatency() {
            this.latencyTest.start = Date.now();
            this.sendMessage({ type: 'ping' });
            this.addSystemMessage('正在測量延遲...');
        }

        showLatencyResult(latency) {
            const resultDiv = document.getElementById('latencyResult');
            resultDiv.innerHTML = `
                <strong>延遲測試結果：</strong> ${latency}ms<br>
                <small>平均延遲：${Math.round(this.latencyTest.results.reduce((a, b) => a + b, 0) / this.latencyTest.results.length)}ms 
                (${this.latencyTest.results.length} 次測試)</small>
            `;
            resultDiv.style.display = 'block';
        }

        updateConnectionStatus(connected) {
            this.isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');
            const indicator = statusElement.querySelector('.sync-indicator');
            
            if (connected) {
                statusElement.innerHTML = '<span class="sync-indicator connected"></span>已連接';
                statusElement.className = 'badge bg-success';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendChat').disabled = false;
            } else {
                statusElement.innerHTML = '<span class="sync-indicator disconnected"></span>未連接';
                statusElement.className = 'badge bg-secondary';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('chatInput').disabled = true;
                document.getElementById('sendChat').disabled = true;
            }
        }

        updateUsers(users) {
            const usersList = document.getElementById('usersList');
            const userCount = document.getElementById('userCount');
            
            usersList.innerHTML = '';
            userCount.textContent = users.length;
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = `user-item ${user.id === this.currentUser ? 'own' : 'online'}`;
                userElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-user"></i> ${user.name}
                            ${user.id === this.currentUser ? '(您)' : ''}
                        </span>
                        <small class="text-muted">線上</small>
                    </div>
                `;
                usersList.appendChild(userElement);
            });
        }

        updateCursor(userId, userName, cursor) {
            // 簡化的光標顯示
            console.log(`${userName} 的光標位置:`, cursor);
        }

        addChatMessage(userName, message, isOwn = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isOwn ? 'own' : ''}`;
            messageElement.innerHTML = `
                <small class="text-muted">${userName}</small><br>
                ${message}
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        addSystemMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message system';
            messageElement.innerHTML = `
                <small class="text-muted">系統</small><br>
                <i class="fas fa-info-circle"></i> ${message}
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        addAIMessage(title, message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message ai';
            messageElement.innerHTML = `
                <small class="text-muted">${title}</small><br>
                <i class="fas fa-robot"></i> ${message}
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // 初始化客戶端
    const client = new CollaborationClient();

    // 頁面載入完成後的提示
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Python協作學習平台已載入');
        console.log('📡 請確認WebSocket服務器已啟動：php websocket_server/websocket_server.php');
        
        // 設置預設值
        document.getElementById('userName').value = `測試用戶${Math.floor(Math.random() * 100)}`;
        document.getElementById('roomId').value = 'test-room';
    });
    </script>
</body>
</html> 