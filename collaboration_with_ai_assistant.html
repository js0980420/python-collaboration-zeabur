<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêç PythonÂçî‰ΩúÊïôÂ≠∏Âπ≥Âè∞ - AIÂä©ÊïôÁâà</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .connection-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }
        
        .input-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.connected {
            background: #27ae60;
        }
        
        .btn.connected:hover {
            background: #229954;
        }
        
        .btn.ai-btn {
            background: #9b59b6;
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn.ai-btn:hover {
            background: #8e44ad;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-indicator.connected {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }
        
        .status-indicator.connecting {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }
        
        .status-indicator.disconnected {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        
        .main-container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 140px);
        }
        
        .code-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .code-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .code-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .code-actions {
            display: flex;
            gap: 10px;
        }
        
        .code-actions .btn {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .editor-container {
            flex: 1;
            position: relative;
            background: #1e1e1e;
        }
        
        #codeEditor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            background: #1e1e1e;
            color: #fff;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 20px;
            tab-size: 4;
        }
        
        .code-footer {
            background: #34495e;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .ai-assistant-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 60%;
        }
        
        .ai-header {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-actions {
            display: flex;
            gap: 8px;
        }
        
        .ai-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ai-response {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        
        .ai-response:empty:before {
            content: "ü§ñ ÈªûÊìä‰∏äÊñπÊåâÈàïËÆìAIÂä©ÊïôÂàÜÊûê‰ª£Á¢º";
            color: #7f8c8d;
            font-style: italic;
            display: block;
            text-align: center;
            margin-top: 50px;
        }
        
        .ai-loading {
            text-align: center;
            padding: 20px;
            color: #9b59b6;
        }
        
        .ai-loading .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(155, 89, 182, 0.3);
            border-radius: 50%;
            border-top: 3px solid #9b59b6;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-custom-input {
            padding: 15px;
            border-top: 1px solid #eee;
            background: white;
            display: flex;
            gap: 10px;
        }
        
        .ai-custom-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .ai-custom-input input:focus {
            outline: none;
            border-color: #9b59b6;
        }
        
        .chat-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 40%;
        }
        
        .chat-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .users-list {
            display: flex;
            gap: 5px;
            font-size: 12px;
        }
        
        .user-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
            font-size: 14px;
        }
        
        .message.system {
            background: #ecf0f1;
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
        }
        
        .message.user {
            background: #3498db;
            color: white;
            margin-left: 20px;
            align-self: flex-end;
        }
        
        .message.other {
            background: #e8f4f8;
            color: #2c3e50;
            margin-right: 20px;
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .logs-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .logs-container.show {
            display: block;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #ff4444;
        }
        
        .log-entry.success {
            color: #44ff44;
        }
        
        .log-entry.info {
            color: #4444ff;
        }
        
        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .right-panel {
                flex-direction: row;
                height: 400px;
            }
            
            .ai-assistant-panel,
            .chat-panel {
                height: 100%;
                width: 50%;
            }
        }
        
        @media (max-width: 768px) {
            .right-panel {
                flex-direction: column;
                height: auto;
            }
            
            .ai-assistant-panel,
            .chat-panel {
                height: 300px;
                width: 100%;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .connection-controls {
                flex-direction: column;
                width: 100%;
            }
        }
        
        /* AIÂõûÊáâÊ®£Âºè */
        .ai-response h1, .ai-response h2, .ai-response h3 {
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .ai-response h2 {
            font-size: 1.2em;
            border-bottom: 2px solid #9b59b6;
            padding-bottom: 5px;
        }
        
        .ai-response ul, .ai-response ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .ai-response li {
            margin-bottom: 5px;
        }
        
        .ai-response code {
            background: #f1f2f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #e74c3c;
        }
        
        .ai-response pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .ai-response pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        .ai-response blockquote {
            border-left: 4px solid #9b59b6;
            padding-left: 15px;
            margin: 15px 0;
            font-style: italic;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <!-- È†ÅÈù¢Ê®ôÈ†≠ -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-robot"></i>
                üêç PythonÂçî‰ΩúÊïôÂ≠∏Âπ≥Âè∞ - AIÂä©ÊïôÁâà
            </div>
            <div class="connection-controls">
                <div class="input-group">
                    <label>ÊàøÈñìËôü:</label>
                    <input type="text" id="roomCode" value="demo_room" placeholder="Ëº∏ÂÖ•ÊàøÈñìËôü">
                </div>
                <div class="input-group">
                    <label>ÂßìÂêç:</label>
                    <input type="text" id="userName" value="Â≠∏ÁøíËÄÖ1" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÂßìÂêç">
                </div>
                <button id="connectBtn" class="btn">
                    <i class="fas fa-plug"></i>
                    <span>ÈÄ£Êé•Âçî‰Ωú</span>
                </button>
                <div id="connectionStatus" class="status-indicator disconnected">
                    <i class="fas fa-circle"></i>
                    <span>Êú™ÈÄ£Êé•</span>
                </div>
                <button id="toggleLogs" class="btn" style="background: #34495e;">
                    <i class="fas fa-terminal"></i>
                    Êó•Ë™å
                </button>
            </div>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
    <div class="main-container">
        <!-- ‰ª£Á¢ºÁ∑®ËºØÂçÄÂüü -->
        <div class="code-section">
            <div class="code-header">
                <div class="code-title">
                    <i class="fas fa-code"></i>
                    Python Âçî‰ΩúÁ∑®ËºØÂô®
                </div>
                <div class="code-actions">
                    <button id="saveCode" class="btn">
                        <i class="fas fa-save"></i>
                        ‰øùÂ≠ò
                    </button>
                    <button id="clearCode" class="btn" style="background: #e74c3c;">
                        <i class="fas fa-trash"></i>
                        Ê∏ÖÁ©∫
                    </button>
                </div>
            </div>
            <div class="editor-container">
                <textarea id="codeEditor" placeholder="Âú®ÈÄôË£°ÈñãÂßãÁ∑®ÂØ´Python‰ª£Á¢º...&#10;&#10;üöÄ ÊèêÁ§∫Ôºö&#10;1. ‰Ω†ÁöÑ‰ª£Á¢ºÊúÉËá™ÂãïÂêåÊ≠•Áµ¶ÂÖ∂‰ªñÂçî‰ΩúËÄÖ&#10;2. ÈªûÊìäÂè≥ÂÅ¥AIÂä©ÊïôÊåâÈàïÁç≤ÂæóÊô∫ËÉΩÂª∫Ë≠∞&#10;3. ‰ΩøÁî®ËÅäÂ§©ÂäüËÉΩËàáÂ§•‰º¥‰∫§ÊµÅ"></textarea>
            </div>
            <div class="code-footer">
                <div>
                    <span id="codeStats">Â≠óÁ¨¶Êï∏: 0 | Ë°åÊï∏: 1</span>
                </div>
                <div>
                    <span id="syncStatus">ÂêåÊ≠•ÁãÄÊÖã: Â∞±Á∑í</span>
                </div>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥Èù¢Êùø -->
        <div class="right-panel">
            <!-- AIÂä©ÊïôÈù¢Êùø -->
            <div class="ai-assistant-panel">
                <div class="ai-header">
                    <div class="ai-title">
                        <i class="fas fa-robot"></i>
                        AIÂä©Êïô
                    </div>
                    <div class="ai-actions">
                        <button class="btn ai-btn" onclick="askAI('explain')">
                            <i class="fas fa-lightbulb"></i>
                            Ëß£ÈáãÁ®ãÂºèÁ¢º
                        </button>
                        <button class="btn ai-btn" onclick="askAI('bugs')">
                            <i class="fas fa-bug"></i>
                            Ê™¢Êü•ÈåØË™§
                        </button>
                        <button class="btn ai-btn" onclick="askAI('improve')">
                            <i class="fas fa-rocket"></i>
                            ÊîπÈÄ≤Âª∫Ë≠∞
                        </button>
                        <button class="btn ai-btn" onclick="askAI('help')">
                            <i class="fas fa-graduation-cap"></i>
                            Âçî‰ΩúÊåáÂ∞é
                        </button>
                    </div>
                </div>
                <div class="ai-content">
                    <div id="aiResponse" class="ai-response"></div>
                    <div class="ai-custom-input">
                        <input type="text" id="customPrompt" placeholder="Ëº∏ÂÖ•Ëá™ÂÆöÁæ©ÂïèÈ°å..." 
                               onkeypress="if(event.key==='Enter') askAI('general', this.value)">
                        <button class="btn ai-btn" onclick="askAI('general', document.getElementById('customPrompt').value)">
                            <i class="fas fa-paper-plane"></i>
                            ÊèêÂïè
                        </button>
                    </div>
                </div>
            </div>

            <!-- ËÅäÂ§©Èù¢Êùø -->
            <div class="chat-panel">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-comments"></i>
                        Âçî‰ΩúËÅäÂ§©
                    </div>
                    <div id="usersList" class="users-list">
                        <div class="user-tag">Á≠âÂæÖÈÄ£Êé•...</div>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Ëº∏ÂÖ•Ë®äÊÅØ..." 
                           onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                        ÁôºÈÄÅ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Êó•Ë™åÈù¢Êùø -->
    <div id="logsContainer" class="logs-container"></div>

    <script>
        // ÂÖ®Â±ÄËÆäÊï∏
        let isConnected = false;
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let userName = '';
        let roomCode = '';
        let currentVersion = 0;
        let lastKnownVersion = 0;
        let pollInterval = null;
        let codeEditor = null;
        let lastCodeContent = '';
        let activeUsers = [];
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            codeEditor = document.getElementById('codeEditor');
            
            // Á∂ÅÂÆö‰∫ã‰ª∂
            document.getElementById('connectBtn').addEventListener('click', toggleConnection);
            document.getElementById('toggleLogs').addEventListener('click', toggleLogs);
            document.getElementById('saveCode').addEventListener('click', saveCode);
            document.getElementById('clearCode').addEventListener('click', clearCode);
            
            // ‰ª£Á¢ºÁ∑®ËºØÂô®‰∫ã‰ª∂
            codeEditor.addEventListener('input', handleCodeChange);
            codeEditor.addEventListener('keydown', handleTabKey);
            
            // Ê™¢Êü•AIÂä©ÊïôÁãÄÊÖã
            checkAIStatus();
            
            logMessage('Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê', 'success');
        }
        
        function handleTabKey(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                e.target.value = e.target.value.substring(0, start) + '    ' + e.target.value.substring(end);
                e.target.selectionStart = e.target.selectionEnd = start + 4;
            }
        }
        
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }
        
        function connect() {
            roomCode = document.getElementById('roomCode').value.trim();
            userName = document.getElementById('userName').value.trim();
            
            if (!roomCode) {
                alert('Ë´ãËº∏ÂÖ•ÊàøÈñìËôü');
                return;
            }
            
            if (!userName) {
                alert('Ë´ãËº∏ÂÖ•ÂßìÂêç');
                return;
            }
            
            updateConnectionStatus('connecting');
            logMessage(`ÂòóË©¶ÈÄ£Êé•Âà∞ÊàøÈñì: ${roomCode}`, 'info');
            
            // Ê∏¨Ë©¶ÈÄ£Êé•
            fetch('code_sync_handler.php?action=status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isConnected = true;
                        updateConnectionStatus('connected');
                        logMessage('Âçî‰ΩúÊúçÂãôÈÄ£Êé•ÊàêÂäü', 'success');
                        
                        // ÁôºÈÄÅÁî®Êà∂Âä†ÂÖ•‰∫ã‰ª∂
                        sendUpdate('user_join', {});
                        
                        // ÈñãÂßãËº™Ë©¢Êõ¥Êñ∞
                        startPolling();
                        
                        // Áç≤ÂèñÂàùÂßã‰ª£Á¢º
                        getUpdates();
                        
                        // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                        const connectBtn = document.getElementById('connectBtn');
                        connectBtn.innerHTML = '<i class="fas fa-unlink"></i><span>Êñ∑ÈñãÈÄ£Êé•</span>';
                        connectBtn.classList.add('connected');
                        
                        addChatMessage('system', `${userName} Âä†ÂÖ•‰∫ÜÂçî‰Ωú`);
                    } else {
                        throw new Error('ÊúçÂãôÂô®ÈüøÊáâÈåØË™§');
                    }
                })
                .catch(error => {
                    updateConnectionStatus('disconnected');
                    logMessage(`ÈÄ£Êé•Â§±Êïó: ${error.message}`, 'error');
                    alert('ÈÄ£Êé•Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊúçÂãôÂô®ÁãÄÊÖã');
                });
        }
        
        function disconnect() {
            if (!isConnected) return;
            
            // ÁôºÈÄÅÁî®Êà∂Èõ¢Èñã‰∫ã‰ª∂
            sendUpdate('user_leave', {});
            
            isConnected = false;
            updateConnectionStatus('disconnected');
            
            // ÂÅúÊ≠¢Ëº™Ë©¢
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.innerHTML = '<i class="fas fa-plug"></i><span>ÈÄ£Êé•Âçî‰Ωú</span>';
            connectBtn.classList.remove('connected');
            
            logMessage('Â∑≤Êñ∑ÈñãÂçî‰ΩúÈÄ£Êé•', 'info');
            addChatMessage('system', `${userName} Èõ¢Èñã‰∫ÜÂçî‰Ωú`);
        }
        
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            
            pollInterval = setInterval(() => {
                if (isConnected) {
                    getUpdates();
                }
            }, 2000); // ÊØè2ÁßíÁç≤ÂèñÊõ¥Êñ∞
        }
        
        function getUpdates() {
            const requestData = {
                action: 'get_updates',
                room: roomCode,
                userId: userId,
                userName: userName,
                lastVersion: lastKnownVersion
            };
            
            fetch('code_sync_handler.php?action=get_updates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.updates) {
                    processUpdates(data.updates);
                    if (data.latestVersion) {
                        lastKnownVersion = data.latestVersion;
                    }
                }
            })
            .catch(error => {
                logMessage(`Áç≤ÂèñÊõ¥Êñ∞Â§±Êïó: ${error.message}`, 'error');
            });
        }
        
        function processUpdates(updates) {
            updates.forEach(update => {
                switch (update.type) {
                    case 'code_change':
                        if (update.userId !== userId) {
                            updateCodeEditor(update.data.code, false);
                            logMessage(`Êî∂Âà∞ ${update.userName} ÁöÑ‰ª£Á¢ºÊõ¥Êñ∞`, 'info');
                        }
                        break;
                        
                    case 'active_users_list':
                        updateActiveUsers(update.data);
                        break;
                        
                    case 'cursor_change':
                        updateUserCursor(update.userId, update.userName, update.data.cursor);
                        break;
                }
            });
        }
        
        function updateUserCursor(userId, userName, cursorPos) {
            // Ê∏∏Ê®ôÊõ¥Êñ∞ËôïÁêÜÔºàÁ∞°ÂåñÁâàÔºâ
            logMessage(`${userName} ÁßªÂãï‰∫ÜÊ∏∏Ê®ô`, 'info');
        }
        
        function handleCodeChange() {
            const currentCode = codeEditor.value;
            
            if (currentCode !== lastCodeContent) {
                lastCodeContent = currentCode;
                updateCodeStats();
                
                if (isConnected) {
                    // Âª∂ÈÅ≤ÁôºÈÄÅ‰ª•ÈÅøÂÖçÈÅéÈ†ªÁπÅÁöÑÊõ¥Êñ∞
                    clearTimeout(window.codeChangeTimeout);
                    window.codeChangeTimeout = setTimeout(() => {
                        sendCodeUpdate(currentCode);
                    }, 1000);
                }
            }
        }
        
        function sendCodeUpdate(code) {
            const updateData = {
                action: 'send_update',
                room: roomCode,
                userId: userId,
                userName: userName,
                type: 'code_change',
                data: {
                    code: code,
                    version: currentVersion + 1
                }
            };
            
            fetch('code_sync_handler.php?action=send_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentVersion = data.newVersion || currentVersion + 1;
                    updateSyncStatus('Â∑≤ÂêåÊ≠•');
                    logMessage('‰ª£Á¢ºÂêåÊ≠•ÊàêÂäü', 'success');
                } else {
                    throw new Error(data.error || 'ÂêåÊ≠•Â§±Êïó');
                }
            })
            .catch(error => {
                updateSyncStatus('ÂêåÊ≠•Â§±Êïó');
                logMessage(`‰ª£Á¢ºÂêåÊ≠•Â§±Êïó: ${error.message}`, 'error');
            });
        }
        
        function sendUpdate(type, data) {
            if (!isConnected) return;
            
            const updateData = {
                action: 'send_update',
                room: roomCode,
                userId: userId,
                userName: userName,
                type: type,
                data: data
            };
            
            fetch('code_sync_handler.php?action=send_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    logMessage(`ÁôºÈÄÅÊõ¥Êñ∞Â§±Êïó: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`ÁôºÈÄÅÊõ¥Êñ∞Â§±Êïó: ${error.message}`, 'error');
            });
        }
        
        function updateCodeEditor(code, triggerChange = true) {
            if (codeEditor.value !== code) {
                codeEditor.value = code;
                lastCodeContent = code;
                if (triggerChange) {
                    updateCodeStats();
                }
            }
        }
        
        function updateCodeStats() {
            const code = codeEditor.value;
            const charCount = code.length;
            const lineCount = code.split('\n').length;
            document.getElementById('codeStats').textContent = `Â≠óÁ¨¶Êï∏: ${charCount} | Ë°åÊï∏: ${lineCount}`;
        }
        
        function updateSyncStatus(status) {
            document.getElementById('syncStatus').textContent = `ÂêåÊ≠•ÁãÄÊÖã: ${status}`;
        }
        
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status-indicator ${status}`;
            
            const icons = {
                connected: 'fa-check-circle',
                connecting: 'fa-spinner fa-spin',
                disconnected: 'fa-times-circle'
            };
            
            const texts = {
                connected: 'Â∑≤ÈÄ£Êé•',
                connecting: 'ÈÄ£Êé•‰∏≠...',
                disconnected: 'Êú™ÈÄ£Êé•'
            };
            
            statusEl.innerHTML = `<i class="fas ${icons[status]}"></i><span>${texts[status]}</span>`;
        }
        
        function updateActiveUsers(users) {
            activeUsers = users;
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="user-tag">Á≠âÂæÖÈÄ£Êé•...</div>';
            } else {
                usersList.innerHTML = users.map(user => 
                    `<div class="user-tag">${user.userName}</div>`
                ).join('');
            }
        }
        
        function saveCode() {
            const code = codeEditor.value;
            if (code.trim()) {
                const blob = new Blob([code], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `python_code_${new Date().toISOString().slice(0,10)}.py`;
                a.click();
                URL.revokeObjectURL(url);
                logMessage('‰ª£Á¢ºÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞', 'success');
            }
        }
        
        function clearCode() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâ‰ª£Á¢ºÂóéÔºüÊ≠§Êìç‰ΩúÊúÉÂêåÊ≠•Áµ¶ÂÖ∂‰ªñÂçî‰ΩúËÄÖ„ÄÇ')) {
                codeEditor.value = '';
                lastCodeContent = '';
                updateCodeStats();
                if (isConnected) {
                    sendCodeUpdate('');
                }
                logMessage('‰ª£Á¢ºÂ∑≤Ê∏ÖÁ©∫', 'info');
            }
        }
        
        // ============ AIÂä©ÊïôÂäüËÉΩ ============
        
        function checkAIStatus() {
            fetch('ai_api_handler.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        logMessage(`AIÂä©ÊïôÊúçÂãôÂ∑≤Â∞±Á∑í ${data.demo_mode ? '(ÊºîÁ§∫Ê®°Âºè)' : '(OpenAIÊ®°Âºè)'}`, 'success');
                        if (data.demo_mode) {
                            showAIMessage('ü§ñ AIÂä©ÊïôÂ∑≤Â∞±Á∑íÔºÅ\n\nÁï∂ÂâçÈÅãË°åÂú®**ÊºîÁ§∫Ê®°Âºè**ÔºåÊèê‰æõÊ®°Êì¨ÁöÑAIÂõûÊáâ„ÄÇ\n\nË¶Å‰ΩøÁî®ÁúüÂØ¶ÁöÑOpenAIÂäüËÉΩÔºåË´ãÈÖçÁΩÆAPI Key„ÄÇ');
                        }
                    } else {
                        logMessage('AIÂä©ÊïôÊúçÂãôÊ™¢Êü•Â§±Êïó', 'error');
                    }
                })
                .catch(error => {
                    logMessage(`AIÂä©ÊïôÊúçÂãô‰∏çÂèØÁî®: ${error.message}`, 'error');
                });
        }
        
        function askAI(action, customPrompt = '') {
            const code = codeEditor.value.trim();
            
            if (!code && action !== 'general') {
                alert('Ë´ãÂÖàËº∏ÂÖ•‰∏Ä‰∫õPython‰ª£Á¢º');
                return;
            }
            
            if (action === 'general' && !customPrompt) {
                alert('Ë´ãËº∏ÂÖ•Ë¶ÅË©¢ÂïèÁöÑÂïèÈ°å');
                return;
            }
            
            showAILoading();
            
            const requestData = {
                action: action,
                code: code,
                custom_prompt: customPrompt,
                user_id: userId,
                room: roomCode
            };
            
            fetch('ai_api_handler.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideAILoading();
                
                if (data.success) {
                    showAIMessage(data.response);
                    logMessage(`AIÂä©ÊïôÂõûÊáâÂÆåÊàê (${action})`, 'success');
                    
                    // Ê∏ÖÁ©∫Ëá™ÂÆöÁæ©Ëº∏ÂÖ•
                    if (action === 'general') {
                        document.getElementById('customPrompt').value = '';
                    }
                    
                    // Âú®ËÅäÂ§©‰∏≠ÂàÜ‰∫´AIÂõûÊáâ
                    if (isConnected) {
                        const summary = data.response.split('\n')[0].substring(0, 100) + '...';
                        addChatMessage('system', `${userName} ÂêëAIÂä©ÊïôË©¢Âïè‰∫Ü„Äå${getActionText(action)}„Äç`);
                    }
                } else {
                    showAIMessage(`‚ùå **AIÂä©ÊïôÊö´ÊôÇÁÑ°Ê≥ïÂõûÊáâ**\n\nÈåØË™§: ${data.error}\n\nüí° ${data.suggestion || 'Ë´ãÁ®çÂæåÂÜçË©¶'}`);
                    logMessage(`AIÂä©ÊïôÈåØË™§: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                hideAILoading();
                showAIMessage(`‚ùå **Á∂≤Ë∑ØÈÄ£Êé•ÈåØË™§**\n\nÁÑ°Ê≥ïÈÄ£Êé•Âà∞AIÂä©ÊïôÊúçÂãô„ÄÇ\n\nË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Êé•ÊàñÁ®çÂæåÂÜçË©¶„ÄÇ`);
                logMessage(`AIË´ãÊ±ÇÂ§±Êïó: ${error.message}`, 'error');
            });
        }
        
        function getActionText(action) {
            const actions = {
                'explain': 'Ëß£ÈáãÁ®ãÂºèÁ¢º',
                'bugs': 'Ê™¢Êü•ÈåØË™§',
                'improve': 'ÊîπÈÄ≤Âª∫Ë≠∞',
                'help': 'Âçî‰ΩúÊåáÂ∞é',
                'general': '‰∏ÄËà¨Ë©¢Âïè'
            };
            return actions[action] || 'Ë©¢Âïè';
        }
        
        function showAILoading() {
            const aiResponse = document.getElementById('aiResponse');
            aiResponse.innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    AIÂä©ÊïôÊ≠£Âú®ÊÄùËÄÉ‰∏≠...
                </div>
            `;
        }
        
        function hideAILoading() {
            // ËºâÂÖ•ÁãÄÊÖãÊúÉË¢´ÂõûÊáâÂÖßÂÆπÊõøÊèõ
        }
        
        function showAIMessage(message) {
            const aiResponse = document.getElementById('aiResponse');
            
            // ‰ΩøÁî®marked.jsÊ∏≤ÊüìMarkdown
            if (typeof marked !== 'undefined') {
                aiResponse.innerHTML = marked.parse(message);
            } else {
                // Á∞°ÂñÆÁöÑMarkdownËôïÁêÜ
                const htmlMessage = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/```python\n([\s\S]*?)\n```/g, '<pre><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                aiResponse.innerHTML = htmlMessage;
            }
            
            // ÊªæÂãïÂà∞Â∫ïÈÉ®
            aiResponse.scrollTop = aiResponse.scrollHeight;
            
            // È´ò‰∫Æ‰ª£Á¢º
            if (typeof hljs !== 'undefined') {
                aiResponse.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightBlock(block);
                });
            }
        }
        
        // ============ ËÅäÂ§©ÂäüËÉΩ ============
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            if (!isConnected) {
                alert('Ë´ãÂÖàÈÄ£Êé•Âà∞Âçî‰ΩúÊàøÈñì');
                return;
            }
            
            addChatMessage('user', message);
            chatInput.value = '';
            
            // Âú®ÂØ¶ÈöõÊáâÁî®‰∏≠ÔºåÈÄôË£°ÊúÉÁôºÈÄÅËÅäÂ§©Ê∂àÊÅØÂà∞ÊúçÂãôÂô®
            // ÁõÆÂâçÂè™Âú®Êú¨Âú∞È°ØÁ§∫
            logMessage(`ÁôºÈÄÅËÅäÂ§©Ê∂àÊÅØ: ${message}`, 'info');
        }
        
        function addChatMessage(type, message, senderName = '') {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            if (type === 'user') {
                messageEl.textContent = `‰Ω†: ${message}`;
            } else if (type === 'other') {
                messageEl.textContent = `${senderName}: ${message}`;
            } else {
                messageEl.textContent = message;
            }
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // ÈôêÂà∂Ê∂àÊÅØÊï∏Èáè
            if (chatMessages.children.length > 50) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }
        
        // ============ Êó•Ë™åÁ≥ªÁµ± ============
        
        function toggleLogs() {
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.classList.toggle('show');
        }
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(`%c${logEntry}`, `color: ${getLogColor(type)}`);
            
            const logsContainer = document.getElementById('logsContainer');
            const logEl = document.createElement('div');
            logEl.className = `log-entry ${type}`;
            logEl.textContent = logEntry;
            
            logsContainer.appendChild(logEl);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // ÈôêÂà∂Êó•Ë™åÊï∏Èáè
            if (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }
        
        function getLogColor(type) {
            switch (type) {
                case 'error': return '#ff4444';
                case 'success': return '#44ff44';
                case 'info': return '#4444ff';
                default: return '#ffffff';
            }
        }
        
        // ÂàùÂßãÂåñ‰ª£Á¢ºÁµ±Ë®à
        document.addEventListener('DOMContentLoaded', function() {
            updateCodeStats();
        });
    </script>
</body>
</html> 