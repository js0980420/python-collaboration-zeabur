<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ Pythonå”ä½œæ•™å­¸å¹³å° - AIåŠ©æ•™ç‰ˆ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .connection-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }
        
        .input-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.connected {
            background: #27ae60;
        }
        
        .btn.connected:hover {
            background: #229954;
        }
        
        .btn.ai-btn {
            background: #9b59b6;
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn.ai-btn:hover {
            background: #8e44ad;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-indicator.connected {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }
        
        .status-indicator.connecting {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
        }
        
        .status-indicator.disconnected {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        
        .main-container {
            max-width: 1600px;
            margin: 20px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 140px);
        }
        
        .code-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .code-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .code-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .code-actions {
            display: flex;
            gap: 10px;
        }
        
        .code-actions .btn {
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .editor-container {
            flex: 1;
            position: relative;
            background: #1e1e1e;
        }
        
        #codeEditor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            background: #1e1e1e;
            color: #fff;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 20px;
            tab-size: 4;
        }
        
        .code-footer {
            background: #34495e;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .ai-assistant-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 60%;
        }
        
        .ai-header {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-actions {
            display: flex;
            gap: 8px;
        }
        
        .ai-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .ai-response {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        
        .ai-response:empty:before {
            content: "ğŸ¤– é»æ“Šä¸Šæ–¹æŒ‰éˆ•è®“AIåŠ©æ•™åˆ†æä»£ç¢¼";
            color: #7f8c8d;
            font-style: italic;
            display: block;
            text-align: center;
            margin-top: 50px;
        }
        
        .ai-loading {
            text-align: center;
            padding: 20px;
            color: #9b59b6;
        }
        
        .ai-loading .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(155, 89, 182, 0.3);
            border-radius: 50%;
            border-top: 3px solid #9b59b6;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-custom-input {
            padding: 15px;
            border-top: 1px solid #eee;
            background: white;
            display: flex;
            gap: 10px;
        }
        
        .ai-custom-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .ai-custom-input input:focus {
            outline: none;
            border-color: #9b59b6;
        }
        
        .chat-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 40%;
        }
        
        .chat-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .users-list {
            display: flex;
            gap: 5px;
            font-size: 12px;
        }
        
        .user-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
            font-size: 14px;
        }
        
        .message.system {
            background: #ecf0f1;
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
        }
        
        .message.user {
            background: #3498db;
            color: white;
            margin-left: 20px;
            align-self: flex-end;
        }
        
        .message.other {
            background: #e8f4f8;
            color: #2c3e50;
            margin-right: 20px;
        }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .logs-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .logs-container.show {
            display: block;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #ff4444;
        }
        
        .log-entry.success {
            color: #44ff44;
        }
        
        .log-entry.info {
            color: #4444ff;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .right-panel {
                flex-direction: row;
                height: 400px;
            }
            
            .ai-assistant-panel,
            .chat-panel {
                height: 100%;
                width: 50%;
            }
        }
        
        @media (max-width: 768px) {
            .right-panel {
                flex-direction: column;
                height: auto;
            }
            
            .ai-assistant-panel,
            .chat-panel {
                height: 300px;
                width: 100%;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .connection-controls {
                flex-direction: column;
                width: 100%;
            }
        }
        
        /* AIå›æ‡‰æ¨£å¼ */
        .ai-response h1, .ai-response h2, .ai-response h3 {
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .ai-response h2 {
            font-size: 1.2em;
            border-bottom: 2px solid #9b59b6;
            padding-bottom: 5px;
        }
        
        .ai-response ul, .ai-response ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .ai-response li {
            margin-bottom: 5px;
        }
        
        .ai-response code {
            background: #f1f2f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            color: #e74c3c;
        }
        
        .ai-response pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .ai-response pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        
        .ai-response blockquote {
            border-left: 4px solid #9b59b6;
            padding-left: 15px;
            margin: 15px 0;
            font-style: italic;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <!-- é é¢æ¨™é ­ -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-robot"></i>
                ğŸ Pythonå”ä½œæ•™å­¸å¹³å° - AIåŠ©æ•™ç‰ˆ
            </div>
            <div class="connection-controls">
                <div class="input-group">
                    <label>æˆ¿é–“è™Ÿ:</label>
                    <input type="text" id="roomCode" value="demo_room" placeholder="è¼¸å…¥æˆ¿é–“è™Ÿ">
                </div>
                <div class="input-group">
                    <label>å§“å:</label>
                    <input type="text" id="userName" value="å­¸ç¿’è€…1" placeholder="è¼¸å…¥ä½ çš„å§“å">
                </div>
                <button id="connectBtn" class="btn">
                    <i class="fas fa-plug"></i>
                    <span>é€£æ¥å”ä½œ</span>
                </button>
                <div id="connectionStatus" class="status-indicator disconnected">
                    <i class="fas fa-circle"></i>
                    <span>æœªé€£æ¥</span>
                </div>
                <button id="toggleLogs" class="btn" style="background: #34495e;">
                    <i class="fas fa-terminal"></i>
                    æ—¥èªŒ
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="main-container">
        <!-- ä»£ç¢¼ç·¨è¼¯å€åŸŸ -->
        <div class="code-section">
            <div class="code-header">
                <div class="code-title">
                    <i class="fas fa-code"></i>
                    Python å”ä½œç·¨è¼¯å™¨
                </div>
                <div class="code-actions">
                    <button id="saveCode" class="btn">
                        <i class="fas fa-save"></i>
                        ä¿å­˜
                    </button>
                    <button id="clearCode" class="btn" style="background: #e74c3c;">
                        <i class="fas fa-trash"></i>
                        æ¸…ç©º
                    </button>
                </div>
            </div>
            <div class="editor-container">
                <textarea id="codeEditor" placeholder="åœ¨é€™è£¡é–‹å§‹ç·¨å¯«Pythonä»£ç¢¼...&#10;&#10;ğŸš€ æç¤ºï¼š&#10;1. ä½ çš„ä»£ç¢¼æœƒè‡ªå‹•åŒæ­¥çµ¦å…¶ä»–å”ä½œè€…&#10;2. é»æ“Šå³å´AIåŠ©æ•™æŒ‰éˆ•ç²å¾—æ™ºèƒ½å»ºè­°&#10;3. ä½¿ç”¨èŠå¤©åŠŸèƒ½èˆ‡å¤¥ä¼´äº¤æµ"></textarea>
            </div>
            <div class="code-footer">
                <div>
                    <span id="codeStats">å­—ç¬¦æ•¸: 0 | è¡Œæ•¸: 1</span>
                </div>
                <div>
                    <span id="syncStatus">åŒæ­¥ç‹€æ…‹: å°±ç·’</span>
                </div>
            </div>
        </div>

        <!-- å³å´é¢æ¿ -->
        <div class="right-panel">
            <!-- AIåŠ©æ•™é¢æ¿ -->
            <div class="ai-assistant-panel">
                <div class="ai-header">
                    <div class="ai-title">
                        <i class="fas fa-robot"></i>
                        AIåŠ©æ•™
                    </div>
                    <div class="ai-actions">
                        <button class="btn ai-btn" onclick="askAI('explain')">
                            <i class="fas fa-lightbulb"></i>
                            è§£é‡‹ç¨‹å¼ç¢¼
                        </button>
                        <button class="btn ai-btn" onclick="askAI('bugs')">
                            <i class="fas fa-bug"></i>
                            æª¢æŸ¥éŒ¯èª¤
                        </button>
                        <button class="btn ai-btn" onclick="askAI('improve')">
                            <i class="fas fa-rocket"></i>
                            æ”¹é€²å»ºè­°
                        </button>
                        <button class="btn ai-btn" onclick="askAI('help')">
                            <i class="fas fa-graduation-cap"></i>
                            å”ä½œæŒ‡å°
                        </button>
                    </div>
                </div>
                <div class="ai-content">
                    <div id="aiResponse" class="ai-response"></div>
                    <div class="ai-custom-input">
                        <input type="text" id="customPrompt" placeholder="è¼¸å…¥è‡ªå®šç¾©å•é¡Œ..." 
                               onkeypress="if(event.key==='Enter') askAI('general', this.value)">
                        <button class="btn ai-btn" onclick="askAI('general', document.getElementById('customPrompt').value)">
                            <i class="fas fa-paper-plane"></i>
                            æå•
                        </button>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©é¢æ¿ -->
            <div class="chat-panel">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-comments"></i>
                        å”ä½œèŠå¤©
                    </div>
                    <div id="usersList" class="users-list">
                        <div class="user-tag">ç­‰å¾…é€£æ¥...</div>
                    </div>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." 
                           onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                        ç™¼é€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¥èªŒé¢æ¿ -->
    <div id="logsContainer" class="logs-container"></div>

    <script>
        // å…¨å±€è®Šæ•¸
        let isConnected = false;
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let userName = '';
        let roomCode = '';
        let currentVersion = 0;
        let lastKnownVersion = 0;
        let pollInterval = null;
        let codeEditor = null;
        let lastCodeContent = '';
        let activeUsers = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            codeEditor = document.getElementById('codeEditor');
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('connectBtn').addEventListener('click', toggleConnection);
            document.getElementById('toggleLogs').addEventListener('click', toggleLogs);
            document.getElementById('saveCode').addEventListener('click', saveCode);
            document.getElementById('clearCode').addEventListener('click', clearCode);
            
            // ä»£ç¢¼ç·¨è¼¯å™¨äº‹ä»¶
            codeEditor.addEventListener('input', handleCodeChange);
            codeEditor.addEventListener('keydown', handleTabKey);
            
            // æª¢æŸ¥AIåŠ©æ•™ç‹€æ…‹
            checkAIStatus();
            
            logMessage('ç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'success');
        }
        
        function handleTabKey(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                e.target.value = e.target.value.substring(0, start) + '    ' + e.target.value.substring(end);
                e.target.selectionStart = e.target.selectionEnd = start + 4;
            }
        }
        
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }
        
        function connect() {
            roomCode = document.getElementById('roomCode').value.trim();
            userName = document.getElementById('userName').value.trim();
            
            if (!roomCode) {
                alert('è«‹è¼¸å…¥æˆ¿é–“è™Ÿ');
                return;
            }
            
            if (!userName) {
                alert('è«‹è¼¸å…¥å§“å');
                return;
            }
            
            updateConnectionStatus('connecting');
            logMessage(`å˜—è©¦é€£æ¥åˆ°æˆ¿é–“: ${roomCode}`, 'info');
            
            // æ¸¬è©¦é€£æ¥
            fetch('code_sync_handler.php?action=status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        isConnected = true;
                        updateConnectionStatus('connected');
                        logMessage('å”ä½œæœå‹™é€£æ¥æˆåŠŸ', 'success');
                        
                        // ç™¼é€ç”¨æˆ¶åŠ å…¥äº‹ä»¶
                        sendUpdate('user_join', {});
                        
                        // é–‹å§‹è¼ªè©¢æ›´æ–°
                        startPolling();
                        
                        // ç²å–åˆå§‹ä»£ç¢¼
                        getUpdates();
                        
                        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                        const connectBtn = document.getElementById('connectBtn');
                        connectBtn.innerHTML = '<i class="fas fa-unlink"></i><span>æ–·é–‹é€£æ¥</span>';
                        connectBtn.classList.add('connected');
                        
                        addChatMessage('system', `${userName} åŠ å…¥äº†å”ä½œ`);
                    } else {
                        throw new Error('æœå‹™å™¨éŸ¿æ‡‰éŒ¯èª¤');
                    }
                })
                .catch(error => {
                    updateConnectionStatus('disconnected');
                    logMessage(`é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                    alert('é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æœå‹™å™¨ç‹€æ…‹');
                });
        }
        
        function disconnect() {
            if (!isConnected) return;
            
            // ç™¼é€ç”¨æˆ¶é›¢é–‹äº‹ä»¶
            sendUpdate('user_leave', {});
            
            isConnected = false;
            updateConnectionStatus('disconnected');
            
            // åœæ­¢è¼ªè©¢
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.innerHTML = '<i class="fas fa-plug"></i><span>é€£æ¥å”ä½œ</span>';
            connectBtn.classList.remove('connected');
            
            logMessage('å·²æ–·é–‹å”ä½œé€£æ¥', 'info');
            addChatMessage('system', `${userName} é›¢é–‹äº†å”ä½œ`);
        }
        
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            
            pollInterval = setInterval(() => {
                if (isConnected) {
                    getUpdates();
                }
            }, 2000); // æ¯2ç§’ç²å–æ›´æ–°
        }
        
        function getUpdates() {
            const requestData = {
                action: 'get_updates',
                room: roomCode,
                userId: userId,
                userName: userName,
                lastVersion: lastKnownVersion
            };
            
            fetch('code_sync_handler.php?action=get_updates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.updates) {
                    processUpdates(data.updates);
                    if (data.latestVersion) {
                        lastKnownVersion = data.latestVersion;
                    }
                }
            })
            .catch(error => {
                logMessage(`ç²å–æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
            });
        }
        
        function processUpdates(updates) {
            updates.forEach(update => {
                switch (update.type) {
                    case 'code_change':
                        if (update.userId !== userId) {
                            updateCodeEditor(update.data.code, false);
                            logMessage(`æ”¶åˆ° ${update.userName} çš„ä»£ç¢¼æ›´æ–°`, 'info');
                        }
                        break;
                        
                    case 'active_users_list':
                        updateActiveUsers(update.data);
                        break;
                        
                    case 'cursor_change':
                        updateUserCursor(update.userId, update.userName, update.data.cursor);
                        break;
                }
            });
        }
        
        function updateUserCursor(userId, userName, cursorPos) {
            // æ¸¸æ¨™æ›´æ–°è™•ç†ï¼ˆç°¡åŒ–ç‰ˆï¼‰
            logMessage(`${userName} ç§»å‹•äº†æ¸¸æ¨™`, 'info');
        }
        
        function handleCodeChange() {
            const currentCode = codeEditor.value;
            
            if (currentCode !== lastCodeContent) {
                lastCodeContent = currentCode;
                updateCodeStats();
                
                if (isConnected) {
                    // å»¶é²ç™¼é€ä»¥é¿å…éé »ç¹çš„æ›´æ–°
                    clearTimeout(window.codeChangeTimeout);
                    window.codeChangeTimeout = setTimeout(() => {
                        sendCodeUpdate(currentCode);
                    }, 1000);
                }
            }
        }
        
        function sendCodeUpdate(code) {
            const updateData = {
                action: 'send_update',
                room: roomCode,
                userId: userId,
                userName: userName,
                type: 'code_change',
                data: {
                    code: code,
                    version: currentVersion + 1
                }
            };
            
            fetch('code_sync_handler.php?action=send_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentVersion = data.newVersion || currentVersion + 1;
                    updateSyncStatus('å·²åŒæ­¥');
                    logMessage('ä»£ç¢¼åŒæ­¥æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.error || 'åŒæ­¥å¤±æ•—');
                }
            })
            .catch(error => {
                updateSyncStatus('åŒæ­¥å¤±æ•—');
                logMessage(`ä»£ç¢¼åŒæ­¥å¤±æ•—: ${error.message}`, 'error');
            });
        }
        
        function sendUpdate(type, data) {
            if (!isConnected) return;
            
            const updateData = {
                action: 'send_update',
                room: roomCode,
                userId: userId,
                userName: userName,
                type: type,
                data: data
            };
            
            fetch('code_sync_handler.php?action=send_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    logMessage(`ç™¼é€æ›´æ–°å¤±æ•—: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                logMessage(`ç™¼é€æ›´æ–°å¤±æ•—: ${error.message}`, 'error');
            });
        }
        
        function updateCodeEditor(code, triggerChange = true) {
            if (codeEditor.value !== code) {
                codeEditor.value = code;
                lastCodeContent = code;
                if (triggerChange) {
                    updateCodeStats();
                }
            }
        }
        
        function updateCodeStats() {
            const code = codeEditor.value;
            const charCount = code.length;
            const lineCount = code.split('\n').length;
            document.getElementById('codeStats').textContent = `å­—ç¬¦æ•¸: ${charCount} | è¡Œæ•¸: ${lineCount}`;
        }
        
        function updateSyncStatus(status) {
            document.getElementById('syncStatus').textContent = `åŒæ­¥ç‹€æ…‹: ${status}`;
        }
        
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status-indicator ${status}`;
            
            const icons = {
                connected: 'fa-check-circle',
                connecting: 'fa-spinner fa-spin',
                disconnected: 'fa-times-circle'
            };
            
            const texts = {
                connected: 'å·²é€£æ¥',
                connecting: 'é€£æ¥ä¸­...',
                disconnected: 'æœªé€£æ¥'
            };
            
            statusEl.innerHTML = `<i class="fas ${icons[status]}"></i><span>${texts[status]}</span>`;
        }
        
        function updateActiveUsers(users) {
            activeUsers = users;
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="user-tag">ç­‰å¾…é€£æ¥...</div>';
            } else {
                usersList.innerHTML = users.map(user => 
                    `<div class="user-tag">${user.userName}</div>`
                ).join('');
            }
        }
        
        function saveCode() {
            const code = codeEditor.value;
            if (code.trim()) {
                const blob = new Blob([code], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `python_code_${new Date().toISOString().slice(0,10)}.py`;
                a.click();
                URL.revokeObjectURL(url);
                logMessage('ä»£ç¢¼å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
            }
        }
        
        function clearCode() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ä»£ç¢¼å—ï¼Ÿæ­¤æ“ä½œæœƒåŒæ­¥çµ¦å…¶ä»–å”ä½œè€…ã€‚')) {
                codeEditor.value = '';
                lastCodeContent = '';
                updateCodeStats();
                if (isConnected) {
                    sendCodeUpdate('');
                }
                logMessage('ä»£ç¢¼å·²æ¸…ç©º', 'info');
            }
        }
        
        // ============ AIåŠ©æ•™åŠŸèƒ½ ============
        
        function checkAIStatus() {
            fetch('ai_api_handler.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        logMessage(`AIåŠ©æ•™æœå‹™å·²å°±ç·’ ${data.demo_mode ? '(æ¼”ç¤ºæ¨¡å¼)' : '(OpenAIæ¨¡å¼)'}`, 'success');
                        if (data.demo_mode) {
                            showAIMessage('ğŸ¤– AIåŠ©æ•™å·²å°±ç·’ï¼\n\nç•¶å‰é‹è¡Œåœ¨**æ¼”ç¤ºæ¨¡å¼**ï¼Œæä¾›æ¨¡æ“¬çš„AIå›æ‡‰ã€‚\n\nè¦ä½¿ç”¨çœŸå¯¦çš„OpenAIåŠŸèƒ½ï¼Œè«‹é…ç½®API Keyã€‚');
                        }
                    } else {
                        logMessage('AIåŠ©æ•™æœå‹™æª¢æŸ¥å¤±æ•—', 'error');
                    }
                })
                .catch(error => {
                    logMessage(`AIåŠ©æ•™æœå‹™ä¸å¯ç”¨: ${error.message}`, 'error');
                });
        }
        
        function askAI(action, customPrompt = '') {
            const code = codeEditor.value.trim();
            
            if (!code && action !== 'general') {
                alert('è«‹å…ˆè¼¸å…¥ä¸€äº›Pythonä»£ç¢¼');
                return;
            }
            
            if (action === 'general' && !customPrompt) {
                alert('è«‹è¼¸å…¥è¦è©¢å•çš„å•é¡Œ');
                return;
            }
            
            showAILoading();
            
            const requestData = {
                action: action,
                code: code,
                custom_prompt: customPrompt,
                user_id: userId,
                room: roomCode
            };
            
            fetch('ai_api_handler.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideAILoading();
                
                if (data.success) {
                    showAIMessage(data.response);
                    logMessage(`AIåŠ©æ•™å›æ‡‰å®Œæˆ (${action})`, 'success');
                    
                    // æ¸…ç©ºè‡ªå®šç¾©è¼¸å…¥
                    if (action === 'general') {
                        document.getElementById('customPrompt').value = '';
                    }
                    
                    // åœ¨èŠå¤©ä¸­åˆ†äº«AIå›æ‡‰
                    if (isConnected) {
                        const summary = data.response.split('\n')[0].substring(0, 100) + '...';
                        addChatMessage('system', `${userName} å‘AIåŠ©æ•™è©¢å•äº†ã€Œ${getActionText(action)}ã€`);
                    }
                } else {
                    showAIMessage(`âŒ **AIåŠ©æ•™æš«æ™‚ç„¡æ³•å›æ‡‰**\n\néŒ¯èª¤: ${data.error}\n\nğŸ’¡ ${data.suggestion || 'è«‹ç¨å¾Œå†è©¦'}`);
                    logMessage(`AIåŠ©æ•™éŒ¯èª¤: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                hideAILoading();
                showAIMessage(`âŒ **ç¶²è·¯é€£æ¥éŒ¯èª¤**\n\nç„¡æ³•é€£æ¥åˆ°AIåŠ©æ•™æœå‹™ã€‚\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç¨å¾Œå†è©¦ã€‚`);
                logMessage(`AIè«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            });
        }
        
        function getActionText(action) {
            const actions = {
                'explain': 'è§£é‡‹ç¨‹å¼ç¢¼',
                'bugs': 'æª¢æŸ¥éŒ¯èª¤',
                'improve': 'æ”¹é€²å»ºè­°',
                'help': 'å”ä½œæŒ‡å°',
                'general': 'ä¸€èˆ¬è©¢å•'
            };
            return actions[action] || 'è©¢å•';
        }
        
        function showAILoading() {
            const aiResponse = document.getElementById('aiResponse');
            aiResponse.innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    AIåŠ©æ•™æ­£åœ¨æ€è€ƒä¸­...
                </div>
            `;
        }
        
        function hideAILoading() {
            // è¼‰å…¥ç‹€æ…‹æœƒè¢«å›æ‡‰å…§å®¹æ›¿æ›
        }
        
        function showAIMessage(message) {
            const aiResponse = document.getElementById('aiResponse');
            
            // ä½¿ç”¨marked.jsæ¸²æŸ“Markdown
            if (typeof marked !== 'undefined') {
                aiResponse.innerHTML = marked.parse(message);
            } else {
                // ç°¡å–®çš„Markdownè™•ç†
                const htmlMessage = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/```python\n([\s\S]*?)\n```/g, '<pre><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
                aiResponse.innerHTML = htmlMessage;
            }
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            aiResponse.scrollTop = aiResponse.scrollHeight;
            
            // é«˜äº®ä»£ç¢¼
            if (typeof hljs !== 'undefined') {
                aiResponse.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightBlock(block);
                });
            }
        }
        
        // ============ èŠå¤©åŠŸèƒ½ ============
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            if (!isConnected) {
                alert('è«‹å…ˆé€£æ¥åˆ°å”ä½œæˆ¿é–“');
                return;
            }
            
            addChatMessage('user', message);
            chatInput.value = '';
            
            // åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒç™¼é€èŠå¤©æ¶ˆæ¯åˆ°æœå‹™å™¨
            // ç›®å‰åªåœ¨æœ¬åœ°é¡¯ç¤º
            logMessage(`ç™¼é€èŠå¤©æ¶ˆæ¯: ${message}`, 'info');
        }
        
        function addChatMessage(type, message, senderName = '') {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            if (type === 'user') {
                messageEl.textContent = `ä½ : ${message}`;
            } else if (type === 'other') {
                messageEl.textContent = `${senderName}: ${message}`;
            } else {
                messageEl.textContent = message;
            }
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // é™åˆ¶æ¶ˆæ¯æ•¸é‡
            if (chatMessages.children.length > 50) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }
        
        // ============ æ—¥èªŒç³»çµ± ============
        
        function toggleLogs() {
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.classList.toggle('show');
        }
        
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(`%c${logEntry}`, `color: ${getLogColor(type)}`);
            
            const logsContainer = document.getElementById('logsContainer');
            const logEl = document.createElement('div');
            logEl.className = `log-entry ${type}`;
            logEl.textContent = logEntry;
            
            logsContainer.appendChild(logEl);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            if (logsContainer.children.length > 100) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
        }
        
        function getLogColor(type) {
            switch (type) {
                case 'error': return '#ff4444';
                case 'success': return '#44ff44';
                case 'info': return '#4444ff';
                default: return '#ffffff';
            }
        }
        
        // åˆå§‹åŒ–ä»£ç¢¼çµ±è¨ˆ
        document.addEventListener('DOMContentLoaded', function() {
            updateCodeStats();
        });
    </script>
</body>
</html> 