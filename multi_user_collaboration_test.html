<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Â§ö‰∫∫Âçî‰ΩúÊïàÊûúÂØ¶Ê∏¨ - PythonÊïôÂ≠∏Âπ≥Âè∞</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px 30px;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .subtitle {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .collaboration-stats {
            text-align: center;
        }
        
        .stat {
            display: inline-block;
            margin: 0 10px;
            padding: 5px 12px;
            background: white;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .latency {
            color: #28a745;
        }
        
        .users-count {
            color: #007bff;
        }
        
        .test-controls {
            text-align: right;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0;
            height: 700px;
        }
        
        .editor-panel {
            position: relative;
            border-right: 2px solid #e0e0e0;
        }
        
        .CodeMirror {
            height: 700px !important;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .cursor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            background: #ff4757;
            animation: blink 1s infinite;
            z-index: 10;
        }
        
        .remote-cursor::before {
            content: attr(data-user);
            position: absolute;
            top: -25px;
            left: -5px;
            background: #ff4757;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .remote-cursor.user-2 {
            background: #3742fa;
        }
        
        .remote-cursor.user-2::before {
            background: #3742fa;
        }
        
        .remote-cursor.user-3 {
            background: #2ed573;
        }
        
        .remote-cursor.user-3::before {
            background: #2ed573;
        }
        
        .remote-cursor.user-4 {
            background: #ffa502;
        }
        
        .remote-cursor.user-4::before {
            background: #ffa502;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .collaboration-panel {
            display: flex;
            flex-direction: column;
        }
        
        .panel-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .users-list {
            background: #f0f4ff;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .user-status.typing {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .activity-log {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            background: #fafafa;
        }
        
        .activity-item {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            border-left: 3px solid #007bff;
        }
        
        .activity-item.edit {
            border-left-color: #28a745;
        }
        
        .activity-item.cursor {
            border-left-color: #ffc107;
        }
        
        .activity-item.chat {
            border-left-color: #17a2b8;
        }
        
        .activity-time {
            color: #666;
            font-size: 11px;
        }
        
        .latency-monitor {
            background: #e3f2fd;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
        }
        
        .latency-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .latency-value {
            font-weight: bold;
        }
        
        .latency-value.good { color: #28a745; }
        .latency-value.ok { color: #ffc107; }
        .latency-value.bad { color: #dc3545; }
        
        .test-instructions {
            background: #fff3cd;
            padding: 15px 20px;
            border-bottom: 2px solid #ffeaa7;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .test-step {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .test-step.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .simulated-user {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            min-width: 300px;
            text-align: center;
        }
        
        .simulated-user.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Â§ö‰∫∫Âçî‰ΩúÊïàÊûúÂØ¶Ê∏¨</h1>
            <div class="subtitle">Ê∏¨Ë©¶Ê∏∏Ê®ôÂêåÊ≠•„ÄÅ‰ª£Á¢ºÂçî‰ΩúÂíåÂª∂ÈÅ≤ÊÄßËÉΩ</div>
        </div>
        
        <div class="control-panel">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U1</div>
                <div>
                    <div><strong id="user-name">Ê∏¨Ë©¶Áî®Êà∂1</strong></div>
                    <div style="font-size: 12px; color: #666;">ÊàøÈñì: <span id="current-room">test-collab</span></div>
                </div>
            </div>
            
            <div class="collaboration-stats">
                <span class="stat latency">Âª∂ÈÅ≤: <span id="latency-display">-- ms</span></span>
                <span class="stat users-count">Âú®Á∑ö: <span id="users-count">1</span> ‰∫∫</span>
                <span class="stat">ÂêåÊ≠•: <span id="sync-count">0</span> Ê¨°</span>
            </div>
            
            <div class="test-controls">
                <button class="btn btn-primary" onclick="openMultipleWindows()">üîÄ ÈñãÂïüÂ§öÁ™óÂè£</button>
                <button class="btn btn-success" onclick="startLatencyTest()">‚è±Ô∏è Âª∂ÈÅ≤Ê∏¨Ë©¶</button>
                <button class="btn btn-warning" onclick="simulateCollaboration()">ü§ñ Ê®°Êì¨Âçî‰Ωú</button>
                <button class="btn btn-danger" onclick="resetTest()">üîÑ ÈáçÁΩÆÊ∏¨Ë©¶</button>
            </div>
        </div>
        
        <div class="test-instructions">
            <strong>üìã Â§ö‰∫∫Âçî‰ΩúÊ∏¨Ë©¶Ê≠•È©üÔºö</strong>
            <div class="test-step" id="step-1">1. ÈªûÊìä "üîÄ ÈñãÂïüÂ§öÁ™óÂè£" ÊâìÈñã3-4ÂÄãÂçî‰ΩúÁ™óÂè£</div>
            <div class="test-step" id="step-2">2. Âú®‰∏çÂêåÁ™óÂè£‰∏≠Á∑®ËºØ‰ª£Á¢ºÔºåËßÄÂØüÂÖ∂‰ªñÁ™óÂè£ÁöÑÂç≥ÊôÇÂêåÊ≠•</div>
            <div class="test-step" id="step-3">3. ÁßªÂãïÊ∏∏Ê®ôÔºåËßÄÂØüÂÖ∂‰ªñÁî®Êà∂ÁöÑÊ∏∏Ê®ô‰ΩçÁΩÆÈ°ØÁ§∫</div>
            <div class="test-step" id="step-4">4. ÈªûÊìä "‚è±Ô∏è Âª∂ÈÅ≤Ê∏¨Ë©¶" Ê∏¨ÈáèÂêåÊ≠•Âª∂ÈÅ≤ÊôÇÈñì</div>
            <div class="test-step" id="step-5">5. ‰ΩøÁî® "ü§ñ Ê®°Êì¨Âçî‰Ωú" Ëá™ÂãïÊºîÁ§∫Âçî‰ΩúÊïàÊûú</div>
        </div>
        
        <div class="main-content">
            <div class="editor-panel">
                <div class="cursor-overlay" id="cursor-overlay"></div>
                <textarea id="code-editor" placeholder="ÈñãÂßãÂ§ö‰∫∫Âçî‰ΩúÁ∑®Á®ãÊ∏¨Ë©¶..."></textarea>
            </div>
            
            <div class="collaboration-panel">
                <div class="panel-section" style="flex: 0 0 auto;">
                    <div class="panel-header">üë• Âçî‰ΩúÁî®Êà∂</div>
                    <div class="users-list" id="users-list">
                        <div class="user-item">
                            <div class="user-status" id="user-1-status"></div>
                            <span>Ê∏¨Ë©¶Áî®Êà∂1 (ÊÇ®)</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section" style="flex: 0 0 auto;">
                    <div class="panel-header">üìä Âª∂ÈÅ≤Áõ£Êéß</div>
                    <div class="latency-monitor" id="latency-monitor">
                        <div class="latency-item">
                            <span>‰ª£Á¢ºÂêåÊ≠•Âª∂ÈÅ≤:</span>
                            <span class="latency-value good" id="code-latency">-- ms</span>
                        </div>
                        <div class="latency-item">
                            <span>Ê∏∏Ê®ôÂêåÊ≠•Âª∂ÈÅ≤:</span>
                            <span class="latency-value good" id="cursor-latency">-- ms</span>
                        </div>
                        <div class="latency-item">
                            <span>ËÅäÂ§©Ê∂àÊÅØÂª∂ÈÅ≤:</span>
                            <span class="latency-value good" id="chat-latency">-- ms</span>
                        </div>
                        <div class="latency-item">
                            <span>Âπ≥ÂùáÂª∂ÈÅ≤:</span>
                            <span class="latency-value good" id="avg-latency">-- ms</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-header">üìù Âçî‰ΩúÊ¥ªÂãïË®òÈåÑ</div>
                    <div class="activity-log" id="activity-log">
                        <div class="activity-item">
                            <div><strong>Á≥ªÁµ±ÂïüÂãï</strong></div>
                            <div class="activity-time">Ê∫ñÂÇôÂ§ö‰∫∫Âçî‰ΩúÊ∏¨Ë©¶Áí∞Â¢É</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="simulated-user hidden" id="simulated-user">
        <h3>ü§ñ Ê®°Êì¨Âçî‰Ωú‰∏≠...</h3>
        <p id="simulation-status">Ê≠£Âú®Ê®°Êì¨ÂÖ∂‰ªñÁî®Êà∂ÁöÑÊìç‰Ωú</p>
        <div style="margin-top: 15px;">
            <button class="btn btn-danger" onclick="stopSimulation()">ÂÅúÊ≠¢Ê®°Êì¨</button>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄËÆäÈáè
        let editor;
        let currentRoom = 'test-collab';
        let userId = 'user_' + Math.random().toString(36).substr(2, 6);
        let userName = 'Ê∏¨Ë©¶Áî®Êà∂1';
        let collaborationChannel;
        let remoteCursors = new Map();
        let latencyData = {
            code: [],
            cursor: [],
            chat: [],
            sync: 0
        };
        let isSimulating = false;
        let simulationInterval;
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
            initCollaboration();
            startLatencyMonitoring();
            
            // Êõ¥Êñ∞Áî®Êà∂‰ø°ÊÅØ
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-avatar').textContent = userName.slice(-1);
            
            addActivity('Á≥ªÁµ±', 'Â§ö‰∫∫Âçî‰ΩúÊ∏¨Ë©¶Áí∞Â¢ÉÂ∑≤ÂïüÂãï', 'system');
        });
        
        // ÂàùÂßãÂåñÁ∑®ËºØÂô®
        function initEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                lineWrapping: true,
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    }
                }
            });
            
            // ÂàùÂßã‰ª£Á¢º
            const initialCode = `# üöÄ Â§ö‰∫∫Âçî‰ΩúÂØ¶Ê∏¨ - Python ÊïôÂ≠∏Âπ≥Âè∞
# ÈÄôÂÄãÁ∑®ËºØÂô®ÊîØÊè¥ÁúüÂØ¶ÁöÑÂ§ö‰∫∫Âçî‰ΩúÂäüËÉΩÔºÅ

def collaboration_test():
    """
    Â§ö‰∫∫Âçî‰ΩúÊ∏¨Ë©¶ÂáΩÊï∏
    - ÊîØÊè¥Âç≥ÊôÇ‰ª£Á¢ºÂêåÊ≠•
    - È°ØÁ§∫ÂÖ∂‰ªñÁî®Êà∂Ê∏∏Ê®ô
    - Ê∏¨ÈáèÂêåÊ≠•Âª∂ÈÅ≤
    """
    print("Ê≠°Ëøé‰ΩøÁî®Â§ö‰∫∫Âçî‰ΩúÁ∑®ËºØÂô®ÔºÅ")
    
    # Âçî‰ΩúÂäüËÉΩÂàóË°®
    features = [
        "Âç≥ÊôÇ‰ª£Á¢ºÂêåÊ≠•",
        "Ê∏∏Ê®ô‰ΩçÁΩÆÂêåÊ≠•", 
        "Âª∂ÈÅ≤ÊÄßËÉΩÁõ£Êéß",
        "Â§öÁ™óÂè£Ê∏¨Ë©¶",
        "Ëá™ÂãïË°ùÁ™ÅËß£Ê±∫"
    ]
    
    print("ÊîØÊè¥ÁöÑÂçî‰ΩúÂäüËÉΩÔºö")
    for i, feature in enumerate(features, 1):
        print(f"{i}. {feature}")
    
    return "Âçî‰ΩúÊ∏¨Ë©¶ÂÆåÊàêÔºÅ"

# Ê∏¨Ë©¶Âª∂ÈÅ≤ÂíåÂêåÊ≠•ÊïàÊûú
def latency_test():
    """Ê∏¨Ë©¶ÂêåÊ≠•Âª∂ÈÅ≤"""
    import time
    start_time = time.time()
    
    # ÈÄôË°å‰ª£Á¢ºÁöÑ‰øÆÊîπÊúÉË¢´ÂêåÊ≠•Âà∞ÂÖ∂‰ªñÁî®Êà∂
    result = "ÂêåÊ≠•Ê∏¨Ë©¶Ôºö" + str(int(time.time()))
    
    end_time = time.time()
    latency = (end_time - start_time) * 1000
    
    print(f"Êú¨Âú∞Âª∂ÈÅ≤: {latency:.2f} ms")
    return result

# ÈÅãË°åÊ∏¨Ë©¶
if __name__ == "__main__":
    print("üéØ ÈñãÂßãÂ§ö‰∫∫Âçî‰ΩúÊ∏¨Ë©¶...")
    print("üí° Ë´ãÂú®Â§öÂÄãÁ™óÂè£‰∏≠ÂêåÊôÇÁ∑®ËºØ‰ª£Á¢º")
    print("üëÄ ËßÄÂØüÊ∏∏Ê®ôÂêåÊ≠•ÂíåÂª∂ÈÅ≤Áõ£Êéß")
    
    collaboration_test()
    latency_test()
`;
            
            editor.setValue(initialCode);
            
            // Áõ£ËÅΩÁ∑®ËºØÂô®‰∫ã‰ª∂
            editor.on('change', handleCodeChange);
            editor.on('cursorActivity', handleCursorChange);
            
            // Áõ£ËÅΩÁÑ¶Èªû‰∫ã‰ª∂
            editor.on('focus', () => {
                updateUserStatus('editing');
                addActivity(userName, 'ÈñãÂßãÁ∑®ËºØ‰ª£Á¢º', 'edit');
            });
            
            editor.on('blur', () => {
                updateUserStatus('online');
            });
        }
        
        // ÂàùÂßãÂåñÂçî‰ΩúÂäüËÉΩ
        function initCollaboration() {
            // ‰ΩøÁî® BroadcastChannel ÈÄ≤Ë°åÂ§öÊ®ôÁ±§È†ÅÈÄö‰ø°
            collaborationChannel = new BroadcastChannel('collab_test_' + currentRoom);
            
            collaborationChannel.onmessage = function(event) {
                handleCollaborationMessage(event.data);
            };
            
            // Âª£Êí≠Áî®Êà∂Âä†ÂÖ•
            broadcastMessage({
                type: 'user_join',
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
            
            addActivity('Á≥ªÁµ±', 'Â∑≤ÈÄ£Êé•Âà∞Âçî‰ΩúÊàøÈñì: ' + currentRoom, 'system');
        }
        
        // ËôïÁêÜ‰ª£Á¢ºËÆäÊõ¥
        function handleCodeChange(cm, change) {
            if (change.origin === 'remote') return; // ÂøΩÁï•ÈÅ†Á®ãËÆäÊõ¥
            
            const changeData = {
                type: 'code_change',
                userId: userId,
                userName: userName,
                change: {
                    from: change.from,
                    to: change.to,
                    text: change.text,
                    removed: change.removed
                },
                timestamp: Date.now(),
                fullCode: cm.getValue()
            };
            
            broadcastMessage(changeData);
            updateSyncCount();
            addActivity(userName, `Á∑®ËºØ‰∫ÜÁ¨¨ ${change.from.line + 1} Ë°å`, 'edit');
        }
        
        // ËôïÁêÜÊ∏∏Ê®ôËÆäÊõ¥
        function handleCursorChange(cm) {
            const cursor = cm.getCursor();
            const cursorData = {
                type: 'cursor_change',
                userId: userId,
                userName: userName,
                cursor: cursor,
                timestamp: Date.now()
            };
            
            broadcastMessage(cursorData);
            addActivity(userName, `Ê∏∏Ê®ôÁßªÂãïÂà∞ ${cursor.line + 1}:${cursor.ch + 1}`, 'cursor');
        }
        
        // ËôïÁêÜÂçî‰ΩúÊ∂àÊÅØ
        function handleCollaborationMessage(data) {
            if (data.userId === userId) return; // ÂøΩÁï•Ëá™Â∑±ÁöÑÊ∂àÊÅØ
            
            const latency = Date.now() - data.timestamp;
            
            switch (data.type) {
                case 'user_join':
                    addUser(data.userId, data.userName);
                    addActivity(data.userName, 'Âä†ÂÖ•‰∫ÜÂçî‰Ωú', 'system');
                    break;
                    
                case 'user_leave':
                    removeUser(data.userId);
                    addActivity(data.userName, 'Èõ¢Èñã‰∫ÜÂçî‰Ωú', 'system');
                    break;
                    
                case 'code_change':
                    applyRemoteCodeChange(data);
                    recordLatency('code', latency);
                    addActivity(data.userName, 'ÂêåÊ≠•‰∫Ü‰ª£Á¢ºËÆäÊõ¥', 'edit');
                    break;
                    
                case 'cursor_change':
                    updateRemoteCursor(data.userId, data.userName, data.cursor);
                    recordLatency('cursor', latency);
                    break;
                    
                case 'user_status':
                    updateUserStatus(data.status, data.userId);
                    break;
            }
            
            updateLatencyDisplay();
        }
        
        // ÊáâÁî®ÈÅ†Á®ã‰ª£Á¢ºËÆäÊõ¥
        function applyRemoteCodeChange(data) {
            const currentCode = editor.getValue();
            if (currentCode !== data.fullCode) {
                const cursor = editor.getCursor();
                editor.setValue(data.fullCode);
                editor.setCursor(cursor);
                editor.markText({line: 0, ch: 0}, {line: 0, ch: 0}, {
                    className: 'remote-change',
                    clearOnEnter: true
                });
            }
        }
        
        // Êõ¥Êñ∞ÈÅ†Á®ãÊ∏∏Ê®ô
        function updateRemoteCursor(userId, userName, cursor) {
            const overlay = document.getElementById('cursor-overlay');
            let cursorElement = document.getElementById('cursor-' + userId);
            
            if (!cursorElement) {
                cursorElement = document.createElement('div');
                cursorElement.id = 'cursor-' + userId;
                cursorElement.className = 'remote-cursor user-' + (Object.keys(remoteCursors).length + 2);
                cursorElement.setAttribute('data-user', userName);
                overlay.appendChild(cursorElement);
            }
            
            // Ë®àÁÆóÊ∏∏Ê®ô‰ΩçÁΩÆ
            const coords = editor.cursorCoords({line: cursor.line, ch: cursor.ch}, 'local');
            cursorElement.style.left = coords.left + 'px';
            cursorElement.style.top = coords.top + 'px';
            
            remoteCursors.set(userId, {
                element: cursorElement,
                userName: userName,
                lastUpdate: Date.now()
            });
            
            // Ê∏ÖÁêÜÈÅéÊúüÊ∏∏Ê®ô
            setTimeout(() => {
                if (Date.now() - remoteCursors.get(userId)?.lastUpdate > 5000) {
                    if (cursorElement.parentNode) {
                        cursorElement.parentNode.removeChild(cursorElement);
                    }
                    remoteCursors.delete(userId);
                }
            }, 5000);
        }
        
        // Ê∑ªÂä†Áî®Êà∂
        function addUser(userId, userName) {
            const usersList = document.getElementById('users-list');
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.id = 'user-item-' + userId;
            
            userItem.innerHTML = `
                <div class="user-status" id="status-${userId}"></div>
                <span>${userName}</span>
            `;
            
            usersList.appendChild(userItem);
            updateUsersCount();
        }
        
        // ÁßªÈô§Áî®Êà∂
        function removeUser(userId) {
            const userItem = document.getElementById('user-item-' + userId);
            if (userItem) {
                userItem.remove();
            }
            
            // ÁßªÈô§Ê∏∏Ê®ô
            const cursor = remoteCursors.get(userId);
            if (cursor && cursor.element.parentNode) {
                cursor.element.parentNode.removeChild(cursor.element);
            }
            remoteCursors.delete(userId);
            
            updateUsersCount();
        }
        
        // Êõ¥Êñ∞Áî®Êà∂Êï∏Èáè
        function updateUsersCount() {
            const count = document.getElementById('users-list').children.length;
            document.getElementById('users-count').textContent = count;
        }
        
        // Êõ¥Êñ∞Áî®Êà∂ÁãÄÊÖã
        function updateUserStatus(status, userId = null) {
            const targetUserId = userId || userId;
            const statusElement = document.getElementById('status-' + targetUserId);
            
            if (statusElement) {
                statusElement.className = 'user-status ' + status;
            }
            
            if (!userId) {
                // Âª£Êí≠Ëá™Â∑±ÁöÑÁãÄÊÖã
                broadcastMessage({
                    type: 'user_status',
                    userId: userId,
                    userName: userName,
                    status: status,
                    timestamp: Date.now()
                });
            }
        }
        
        // Âª£Êí≠Ê∂àÊÅØ
        function broadcastMessage(data) {
            try {
                collaborationChannel.postMessage(data);
            } catch (error) {
                console.error('Âª£Êí≠Ê∂àÊÅØÂ§±Êïó:', error);
            }
        }
        
        // Ë®òÈåÑÂª∂ÈÅ≤
        function recordLatency(type, latency) {
            if (!latencyData[type]) latencyData[type] = [];
            
            latencyData[type].push(latency);
            if (latencyData[type].length > 10) {
                latencyData[type].shift(); // Âè™‰øùÁïôÊúÄËøë10Ê¢ùË®òÈåÑ
            }
        }
        
        // Êõ¥Êñ∞Âª∂ÈÅ≤È°ØÁ§∫
        function updateLatencyDisplay() {
            const types = ['code', 'cursor', 'chat'];
            let totalLatency = 0;
            let count = 0;
            
            types.forEach(type => {
                const data = latencyData[type];
                if (data.length > 0) {
                    const avg = data.reduce((a, b) => a + b, 0) / data.length;
                    const element = document.getElementById(type + '-latency');
                    
                    if (element) {
                        element.textContent = Math.round(avg) + ' ms';
                        element.className = 'latency-value ' + getLatencyClass(avg);
                    }
                    
                    totalLatency += avg;
                    count++;
                }
            });
            
            if (count > 0) {
                const avgLatency = totalLatency / count;
                const avgElement = document.getElementById('avg-latency');
                const displayElement = document.getElementById('latency-display');
                
                if (avgElement) {
                    avgElement.textContent = Math.round(avgLatency) + ' ms';
                    avgElement.className = 'latency-value ' + getLatencyClass(avgLatency);
                }
                
                if (displayElement) {
                    displayElement.textContent = Math.round(avgLatency) + ' ms';
                }
            }
        }
        
        // Áç≤ÂèñÂª∂ÈÅ≤Á≠âÁ¥öÈ°ûÂêç
        function getLatencyClass(latency) {
            if (latency < 100) return 'good';
            if (latency < 300) return 'ok';
            return 'bad';
        }
        
        // ÈñãÂßãÂª∂ÈÅ≤Áõ£Êéß
        function startLatencyMonitoring() {
            setInterval(() => {
                updateLatencyDisplay();
            }, 1000);
        }
        
        // Êõ¥Êñ∞ÂêåÊ≠•Ë®àÊï∏
        function updateSyncCount() {
            latencyData.sync++;
            document.getElementById('sync-count').textContent = latencyData.sync;
        }
        
        // Ê∑ªÂä†Ê¥ªÂãïË®òÈåÑ
        function addActivity(user, action, type) {
            const activityLog = document.getElementById('activity-log');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item ' + type;
            
            const time = new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            activityItem.innerHTML = `
                <div><strong>${user}</strong> ${action}</div>
                <div class="activity-time">${time}</div>
            `;
            
            activityLog.insertBefore(activityItem, activityLog.firstChild);
            
            // ÈôêÂà∂Ë®òÈåÑÊï∏Èáè
            while (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }
        
        // ÈñãÂïüÂ§öÂÄãÁ™óÂè£ÈÄ≤Ë°åÊ∏¨Ë©¶
        function openMultipleWindows() {
            const currentUrl = window.location.href;
            const windowCount = 3;
            
            for (let i = 1; i <= windowCount; i++) {
                setTimeout(() => {
                    window.open(currentUrl, `collab_test_${i}`, 'width=800,height=900,left=' + (i * 300) + ',top=' + (i * 100));
                }, i * 500);
            }
            
            addActivity('Á≥ªÁµ±', `Â∑≤ÈñãÂïü ${windowCount} ÂÄãÂçî‰ΩúÁ™óÂè£`, 'system');
            document.getElementById('step-1').classList.add('completed');
        }
        
        // ÈñãÂßãÂª∂ÈÅ≤Ê∏¨Ë©¶
        function startLatencyTest() {
            addActivity('Á≥ªÁµ±', 'ÈñãÂßãÂª∂ÈÅ≤Ê∏¨Ë©¶...', 'system');
            
            let testCount = 0;
            const maxTests = 10;
            
            const testInterval = setInterval(() => {
                if (testCount >= maxTests) {
                    clearInterval(testInterval);
                    addActivity('Á≥ªÁµ±', 'Âª∂ÈÅ≤Ê∏¨Ë©¶ÂÆåÊàê', 'system');
                    document.getElementById('step-4').classList.add('completed');
                    return;
                }
                
                // ÁôºÈÄÅÊ∏¨Ë©¶Ê∂àÊÅØ
                const testData = {
                    type: 'latency_test',
                    userId: userId,
                    userName: userName,
                    testId: testCount,
                    timestamp: Date.now()
                };
                
                broadcastMessage(testData);
                testCount++;
                
                addActivity('Á≥ªÁµ±', `Âª∂ÈÅ≤Ê∏¨Ë©¶ ${testCount}/${maxTests}`, 'system');
            }, 500);
        }
        
        // Ê®°Êì¨Âçî‰Ωú
        function simulateCollaboration() {
            if (isSimulating) return;
            
            isSimulating = true;
            document.getElementById('simulated-user').classList.remove('hidden');
            document.getElementById('step-5').classList.add('completed');
            
            const simulatedChanges = [
                { line: 10, text: '    # Ê®°Êì¨Áî®Êà∂AÁöÑ‰øÆÊîπ', action: 'Ê∑ªÂä†Ë®ªÈáã' },
                { line: 15, text: '    print("Âçî‰ΩúÁî®Êà∂BÊ≠£Âú®Á∑®ËºØ...")', action: 'Ê∑ªÂä†‰ª£Á¢º' },
                { line: 20, text: '    result = "Â§ö‰∫∫Âçî‰ΩúÊ∏¨Ë©¶ÊàêÂäüÔºÅ"', action: '‰øÆÊîπËÆäÈáè' },
                { line: 25, text: '    # Áî®Êà∂CÊ∑ªÂä†ÁöÑÂäüËÉΩ', action: 'ÊèíÂÖ•ÂäüËÉΩ' },
                { line: 30, text: '    return collaboration_success', action: 'ËøîÂõûÁµêÊûú' }
            ];
            
            let changeIndex = 0;
            
            simulationInterval = setInterval(() => {
                if (changeIndex >= simulatedChanges.length || !isSimulating) {
                    stopSimulation();
                    return;
                }
                
                const change = simulatedChanges[changeIndex];
                const userName = `Ê®°Êì¨Áî®Êà∂${String.fromCharCode(65 + changeIndex)}`;
                
                // Ê®°Êì¨Ê∏∏Ê®ôÁßªÂãï
                updateRemoteCursor(`sim_${changeIndex}`, userName, { line: change.line, ch: 0 });
                
                // Ê®°Êì¨‰ª£Á¢ºËÆäÊõ¥
                const currentCode = editor.getValue();
                const lines = currentCode.split('\n');
                
                if (lines[change.line]) {
                    lines[change.line] += '\n' + change.text;
                } else {
                    lines.push(change.text);
                }
                
                editor.setValue(lines.join('\n'));
                
                // Ë®òÈåÑÊ¥ªÂãï
                addActivity(userName, change.action, 'edit');
                
                // Êõ¥Êñ∞ÁãÄÊÖã
                document.getElementById('simulation-status').textContent = 
                    `${userName} Ê≠£Âú®Âü∑Ë°å: ${change.action}`;
                
                changeIndex++;
            }, 2000);
            
            addActivity('Á≥ªÁµ±', 'ÈñãÂßãÊ®°Êì¨Â§öÁî®Êà∂Âçî‰Ωú', 'system');
        }
        
        // ÂÅúÊ≠¢Ê®°Êì¨
        function stopSimulation() {
            isSimulating = false;
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            document.getElementById('simulated-user').classList.add('hidden');
            addActivity('Á≥ªÁµ±', 'Ê®°Êì¨Âçî‰ΩúÂ∑≤ÂÅúÊ≠¢', 'system');
        }
        
        // ÈáçÁΩÆÊ∏¨Ë©¶
        function resetTest() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÊ∏¨Ë©¶Êï∏ÊìöÂóéÔºü')) {
                // ÈáçÁΩÆÁ∑®ËºØÂô®
                editor.setValue(editor.getValue().split('\n').slice(0, 10).join('\n'));
                
                // ÈáçÁΩÆÁµ±Ë®à
                latencyData = { code: [], cursor: [], chat: [], sync: 0 };
                document.getElementById('sync-count').textContent = '0';
                document.getElementById('latency-display').textContent = '-- ms';
                
                // ÈáçÁΩÆÊ≠•È©üÁãÄÊÖã
                document.querySelectorAll('.test-step').forEach(step => {
                    step.classList.remove('completed');
                });
                
                // Ê∏ÖÁ©∫Ê¥ªÂãïË®òÈåÑ
                document.getElementById('activity-log').innerHTML = `
                    <div class="activity-item">
                        <div><strong>Á≥ªÁµ±ÈáçÁΩÆ</strong></div>
                        <div class="activity-time">Ê∏¨Ë©¶Áí∞Â¢ÉÂ∑≤ÈáçÁΩÆ</div>
                    </div>
                `;
                
                // Ê∏ÖÁ©∫ÈÅ†Á®ãÊ∏∏Ê®ô
                remoteCursors.forEach(cursor => {
                    if (cursor.element.parentNode) {
                        cursor.element.parentNode.removeChild(cursor.element);
                    }
                });
                remoteCursors.clear();
                
                addActivity('Á≥ªÁµ±', 'Ê∏¨Ë©¶Áí∞Â¢ÉÂ∑≤ÈáçÁΩÆ', 'system');
            }
        }
        
        // È†ÅÈù¢ÈóúÈñâÊôÇÊ∏ÖÁêÜ
        window.addEventListener('beforeunload', function() {
            broadcastMessage({
                type: 'user_leave',
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
        });
        
        // ÂÆöÊúüÊ∏ÖÁêÜÈÅéÊúüÊ∏∏Ê®ô
        setInterval(() => {
            const now = Date.now();
            remoteCursors.forEach((cursor, userId) => {
                if (now - cursor.lastUpdate > 10000) {
                    if (cursor.element.parentNode) {
                        cursor.element.parentNode.removeChild(cursor.element);
                    }
                    remoteCursors.delete(userId);
                }
            });
        }, 5000);
    </script>
</body>
</html> 