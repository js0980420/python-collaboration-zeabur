<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ å¤šäººå”ä½œæ•ˆæœå¯¦æ¸¬ - Pythonæ•™å­¸å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px 30px;
            color: white;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .subtitle {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .collaboration-stats {
            text-align: center;
        }
        
        .stat {
            display: inline-block;
            margin: 0 10px;
            padding: 5px 12px;
            background: white;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .latency {
            color: #28a745;
        }
        
        .users-count {
            color: #007bff;
        }
        
        .test-controls {
            text-align: right;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0;
            height: 700px;
        }
        
        .editor-panel {
            position: relative;
            border-right: 2px solid #e0e0e0;
        }
        
        .CodeMirror {
            height: 700px !important;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .cursor-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 20px;
            background: #ff4757;
            animation: blink 1s infinite;
            z-index: 10;
        }
        
        .remote-cursor::before {
            content: attr(data-user);
            position: absolute;
            top: -25px;
            left: -5px;
            background: #ff4757;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .remote-cursor.user-2 {
            background: #3742fa;
        }
        
        .remote-cursor.user-2::before {
            background: #3742fa;
        }
        
        .remote-cursor.user-3 {
            background: #2ed573;
        }
        
        .remote-cursor.user-3::before {
            background: #2ed573;
        }
        
        .remote-cursor.user-4 {
            background: #ffa502;
        }
        
        .remote-cursor.user-4::before {
            background: #ffa502;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .collaboration-panel {
            display: flex;
            flex-direction: column;
        }
        
        .panel-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .users-list {
            background: #f0f4ff;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .user-status.typing {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .activity-log {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            background: #fafafa;
        }
        
        .activity-item {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            border-left: 3px solid #007bff;
        }
        
        .activity-item.edit {
            border-left-color: #28a745;
        }
        
        .activity-item.cursor {
            border-left-color: #ffc107;
        }
        
        .activity-item.chat {
            border-left-color: #17a2b8;
        }
        
        .activity-time {
            color: #666;
            font-size: 11px;
        }
        
        .latency-monitor {
            background: #e3f2fd;
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
        }
        
        .latency-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .latency-value {
            font-weight: bold;
        }
        
        .latency-value.good { color: #28a745; }
        .latency-value.ok { color: #ffc107; }
        .latency-value.bad { color: #dc3545; }
        
        .test-instructions {
            background: #fff3cd;
            padding: 15px 20px;
            border-bottom: 2px solid #ffeaa7;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .test-step {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .test-step.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .simulated-user {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            min-width: 300px;
            text-align: center;
        }
        
        .simulated-user.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ å¤šäººå”ä½œæ•ˆæœå¯¦æ¸¬</h1>
            <div class="subtitle">æ¸¬è©¦æ¸¸æ¨™åŒæ­¥ã€ä»£ç¢¼å”ä½œå’Œå»¶é²æ€§èƒ½</div>
        </div>
        
        <div class="control-panel">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U1</div>
                <div>
                    <div><strong id="user-name">æ¸¬è©¦ç”¨æˆ¶1</strong></div>
                    <div style="font-size: 12px; color: #666;">æˆ¿é–“: <span id="current-room">test-collab</span></div>
                </div>
            </div>
            
            <div class="collaboration-stats">
                <span class="stat latency">å»¶é²: <span id="latency-display">-- ms</span></span>
                <span class="stat users-count">åœ¨ç·š: <span id="users-count">1</span> äºº</span>
                <span class="stat">åŒæ­¥: <span id="sync-count">0</span> æ¬¡</span>
            </div>
            
            <div class="test-controls">
                <button class="btn btn-primary" onclick="openMultipleWindows()">ğŸ”€ é–‹å•Ÿå¤šçª—å£</button>
                <button class="btn btn-success" onclick="startLatencyTest()">â±ï¸ å»¶é²æ¸¬è©¦</button>
                <button class="btn btn-warning" onclick="simulateCollaboration()">ğŸ¤– æ¨¡æ“¬å”ä½œ</button>
                <button class="btn btn-danger" onclick="resetTest()">ğŸ”„ é‡ç½®æ¸¬è©¦</button>
            </div>
        </div>
        
        <div class="test-instructions">
            <strong>ğŸ“‹ å¤šäººå”ä½œæ¸¬è©¦æ­¥é©Ÿï¼š</strong>
            <div class="test-step" id="step-1">1. é»æ“Š "ğŸ”€ é–‹å•Ÿå¤šçª—å£" æ‰“é–‹3-4å€‹å”ä½œçª—å£</div>
            <div class="test-step" id="step-2">2. åœ¨ä¸åŒçª—å£ä¸­ç·¨è¼¯ä»£ç¢¼ï¼Œè§€å¯Ÿå…¶ä»–çª—å£çš„å³æ™‚åŒæ­¥</div>
            <div class="test-step" id="step-3">3. ç§»å‹•æ¸¸æ¨™ï¼Œè§€å¯Ÿå…¶ä»–ç”¨æˆ¶çš„æ¸¸æ¨™ä½ç½®é¡¯ç¤º</div>
            <div class="test-step" id="step-4">4. é»æ“Š "â±ï¸ å»¶é²æ¸¬è©¦" æ¸¬é‡åŒæ­¥å»¶é²æ™‚é–“</div>
            <div class="test-step" id="step-5">5. ä½¿ç”¨ "ğŸ¤– æ¨¡æ“¬å”ä½œ" è‡ªå‹•æ¼”ç¤ºå”ä½œæ•ˆæœ</div>
        </div>
        
        <div class="main-content">
            <div class="editor-panel">
                <div class="cursor-overlay" id="cursor-overlay"></div>
                <textarea id="code-editor" placeholder="é–‹å§‹å¤šäººå”ä½œç·¨ç¨‹æ¸¬è©¦..."></textarea>
            </div>
            
            <div class="collaboration-panel">
                <div class="panel-section" style="flex: 0 0 auto;">
                    <div class="panel-header">ğŸ‘¥ å”ä½œç”¨æˆ¶</div>
                    <div class="users-list" id="users-list">
                        <div class="user-item">
                            <div class="user-status" id="user-1-status"></div>
                            <span>æ¸¬è©¦ç”¨æˆ¶1 (æ‚¨)</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section" style="flex: 0 0 auto;">
                    <div class="panel-header">ğŸ“Š å»¶é²ç›£æ§</div>
                    <div class="latency-monitor" id="latency-monitor">
                        <div class="latency-item">
                            <span>ä»£ç¢¼åŒæ­¥å»¶é²:</span>
                            <span class="latency-value good" id="code-latency">-- ms</span>
                        </div>
                        <div class="latency-item">
                            <span>æ¸¸æ¨™åŒæ­¥å»¶é²:</span>
                            <span class="latency-value good" id="cursor-latency">-- ms</span>
                        </div>
                        <div class="latency-item">
                            <span>èŠå¤©æ¶ˆæ¯å»¶é²:</span>
                            <span class="latency-value good" id="chat-latency">-- ms</span>
                        </div>
                        <div class="latency-item">
                            <span>å¹³å‡å»¶é²:</span>
                            <span class="latency-value good" id="avg-latency">-- ms</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="panel-header">ğŸ“ å”ä½œæ´»å‹•è¨˜éŒ„</div>
                    <div class="activity-log" id="activity-log">
                        <div class="activity-item">
                            <div><strong>ç³»çµ±å•Ÿå‹•</strong></div>
                            <div class="activity-time">æº–å‚™å¤šäººå”ä½œæ¸¬è©¦ç’°å¢ƒ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="simulated-user hidden" id="simulated-user">
        <h3>ğŸ¤– æ¨¡æ“¬å”ä½œä¸­...</h3>
        <p id="simulation-status">æ­£åœ¨æ¨¡æ“¬å…¶ä»–ç”¨æˆ¶çš„æ“ä½œ</p>
        <div style="margin-top: 15px;">
            <button class="btn btn-danger" onclick="stopSimulation()">åœæ­¢æ¨¡æ“¬</button>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let editor;
        let currentRoom = 'test-collab';
        let userId = 'user_' + Math.random().toString(36).substr(2, 6);
        let userName = 'æ¸¬è©¦ç”¨æˆ¶1';
        let collaborationChannel;
        let remoteCursors = new Map();
        let latencyData = {
            code: [],
            cursor: [],
            chat: [],
            sync: 0
        };
        let isSimulating = false;
        let simulationInterval;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
            initCollaboration();
            startLatencyMonitoring();
            
            // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-avatar').textContent = userName.slice(-1);
            
            addActivity('ç³»çµ±', 'å¤šäººå”ä½œæ¸¬è©¦ç’°å¢ƒå·²å•Ÿå‹•', 'system');
        });
        
        // åˆå§‹åŒ–ç·¨è¼¯å™¨
        function initEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                lineWrapping: true,
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    }
                }
            });
            
            // åˆå§‹ä»£ç¢¼
            const initialCode = `# ğŸš€ å¤šäººå”ä½œå¯¦æ¸¬ - Python æ•™å­¸å¹³å°
# é€™å€‹ç·¨è¼¯å™¨æ”¯æ´çœŸå¯¦çš„å¤šäººå”ä½œåŠŸèƒ½ï¼

def collaboration_test():
    """
    å¤šäººå”ä½œæ¸¬è©¦å‡½æ•¸
    - æ”¯æ´å³æ™‚ä»£ç¢¼åŒæ­¥
    - é¡¯ç¤ºå…¶ä»–ç”¨æˆ¶æ¸¸æ¨™
    - æ¸¬é‡åŒæ­¥å»¶é²
    """
    print("æ­¡è¿ä½¿ç”¨å¤šäººå”ä½œç·¨è¼¯å™¨ï¼")
    
    # å”ä½œåŠŸèƒ½åˆ—è¡¨
    features = [
        "å³æ™‚ä»£ç¢¼åŒæ­¥",
        "æ¸¸æ¨™ä½ç½®åŒæ­¥", 
        "å»¶é²æ€§èƒ½ç›£æ§",
        "å¤šçª—å£æ¸¬è©¦",
        "è‡ªå‹•è¡çªè§£æ±º"
    ]
    
    print("æ”¯æ´çš„å”ä½œåŠŸèƒ½ï¼š")
    for i, feature in enumerate(features, 1):
        print(f"{i}. {feature}")
    
    return "å”ä½œæ¸¬è©¦å®Œæˆï¼"

# æ¸¬è©¦å»¶é²å’ŒåŒæ­¥æ•ˆæœ
def latency_test():
    """æ¸¬è©¦åŒæ­¥å»¶é²"""
    import time
    start_time = time.time()
    
    # é€™è¡Œä»£ç¢¼çš„ä¿®æ”¹æœƒè¢«åŒæ­¥åˆ°å…¶ä»–ç”¨æˆ¶
    result = "åŒæ­¥æ¸¬è©¦ï¼š" + str(int(time.time()))
    
    end_time = time.time()
    latency = (end_time - start_time) * 1000
    
    print(f"æœ¬åœ°å»¶é²: {latency:.2f} ms")
    return result

# é‹è¡Œæ¸¬è©¦
if __name__ == "__main__":
    print("ğŸ¯ é–‹å§‹å¤šäººå”ä½œæ¸¬è©¦...")
    print("ğŸ’¡ è«‹åœ¨å¤šå€‹çª—å£ä¸­åŒæ™‚ç·¨è¼¯ä»£ç¢¼")
    print("ğŸ‘€ è§€å¯Ÿæ¸¸æ¨™åŒæ­¥å’Œå»¶é²ç›£æ§")
    
    collaboration_test()
    latency_test()
`;
            
            editor.setValue(initialCode);
            
            // ç›£è½ç·¨è¼¯å™¨äº‹ä»¶
            editor.on('change', handleCodeChange);
            editor.on('cursorActivity', handleCursorChange);
            
            // ç›£è½ç„¦é»äº‹ä»¶
            editor.on('focus', () => {
                updateUserStatus('editing');
                addActivity(userName, 'é–‹å§‹ç·¨è¼¯ä»£ç¢¼', 'edit');
            });
            
            editor.on('blur', () => {
                updateUserStatus('online');
            });
        }
        
        // åˆå§‹åŒ–å”ä½œåŠŸèƒ½
        function initCollaboration() {
            // ä½¿ç”¨ BroadcastChannel é€²è¡Œå¤šæ¨™ç±¤é é€šä¿¡
            collaborationChannel = new BroadcastChannel('collab_test_' + currentRoom);
            
            collaborationChannel.onmessage = function(event) {
                handleCollaborationMessage(event.data);
            };
            
            // å»£æ’­ç”¨æˆ¶åŠ å…¥
            broadcastMessage({
                type: 'user_join',
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
            
            addActivity('ç³»çµ±', 'å·²é€£æ¥åˆ°å”ä½œæˆ¿é–“: ' + currentRoom, 'system');
        }
        
        // è™•ç†ä»£ç¢¼è®Šæ›´
        function handleCodeChange(cm, change) {
            if (change.origin === 'remote') return; // å¿½ç•¥é ç¨‹è®Šæ›´
            
            const changeData = {
                type: 'code_change',
                userId: userId,
                userName: userName,
                change: {
                    from: change.from,
                    to: change.to,
                    text: change.text,
                    removed: change.removed
                },
                timestamp: Date.now(),
                fullCode: cm.getValue()
            };
            
            broadcastMessage(changeData);
            updateSyncCount();
            addActivity(userName, `ç·¨è¼¯äº†ç¬¬ ${change.from.line + 1} è¡Œ`, 'edit');
        }
        
        // è™•ç†æ¸¸æ¨™è®Šæ›´
        function handleCursorChange(cm) {
            const cursor = cm.getCursor();
            const cursorData = {
                type: 'cursor_change',
                userId: userId,
                userName: userName,
                cursor: cursor,
                timestamp: Date.now()
            };
            
            broadcastMessage(cursorData);
            addActivity(userName, `æ¸¸æ¨™ç§»å‹•åˆ° ${cursor.line + 1}:${cursor.ch + 1}`, 'cursor');
        }
        
        // è™•ç†å”ä½œæ¶ˆæ¯
        function handleCollaborationMessage(data) {
            if (data.userId === userId) return; // å¿½ç•¥è‡ªå·±çš„æ¶ˆæ¯
            
            const latency = Date.now() - data.timestamp;
            
            switch (data.type) {
                case 'user_join':
                    addUser(data.userId, data.userName);
                    addActivity(data.userName, 'åŠ å…¥äº†å”ä½œ', 'system');
                    break;
                    
                case 'user_leave':
                    removeUser(data.userId);
                    addActivity(data.userName, 'é›¢é–‹äº†å”ä½œ', 'system');
                    break;
                    
                case 'code_change':
                    applyRemoteCodeChange(data);
                    recordLatency('code', latency);
                    addActivity(data.userName, 'åŒæ­¥äº†ä»£ç¢¼è®Šæ›´', 'edit');
                    break;
                    
                case 'cursor_change':
                    updateRemoteCursor(data.userId, data.userName, data.cursor);
                    recordLatency('cursor', latency);
                    break;
                    
                case 'user_status':
                    updateUserStatus(data.status, data.userId);
                    break;
            }
            
            updateLatencyDisplay();
        }
        
        // æ‡‰ç”¨é ç¨‹ä»£ç¢¼è®Šæ›´
        function applyRemoteCodeChange(data) {
            const currentCode = editor.getValue();
            if (currentCode !== data.fullCode) {
                const cursor = editor.getCursor();
                editor.setValue(data.fullCode);
                editor.setCursor(cursor);
                editor.markText({line: 0, ch: 0}, {line: 0, ch: 0}, {
                    className: 'remote-change',
                    clearOnEnter: true
                });
            }
        }
        
        // æ›´æ–°é ç¨‹æ¸¸æ¨™
        function updateRemoteCursor(userId, userName, cursor) {
            const overlay = document.getElementById('cursor-overlay');
            let cursorElement = document.getElementById('cursor-' + userId);
            
            if (!cursorElement) {
                cursorElement = document.createElement('div');
                cursorElement.id = 'cursor-' + userId;
                cursorElement.className = 'remote-cursor user-' + (Object.keys(remoteCursors).length + 2);
                cursorElement.setAttribute('data-user', userName);
                overlay.appendChild(cursorElement);
            }
            
            // è¨ˆç®—æ¸¸æ¨™ä½ç½®
            const coords = editor.cursorCoords({line: cursor.line, ch: cursor.ch}, 'local');
            cursorElement.style.left = coords.left + 'px';
            cursorElement.style.top = coords.top + 'px';
            
            remoteCursors.set(userId, {
                element: cursorElement,
                userName: userName,
                lastUpdate: Date.now()
            });
            
            // æ¸…ç†éæœŸæ¸¸æ¨™
            setTimeout(() => {
                if (Date.now() - remoteCursors.get(userId)?.lastUpdate > 5000) {
                    if (cursorElement.parentNode) {
                        cursorElement.parentNode.removeChild(cursorElement);
                    }
                    remoteCursors.delete(userId);
                }
            }, 5000);
        }
        
        // æ·»åŠ ç”¨æˆ¶
        function addUser(userId, userName) {
            const usersList = document.getElementById('users-list');
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.id = 'user-item-' + userId;
            
            userItem.innerHTML = `
                <div class="user-status" id="status-${userId}"></div>
                <span>${userName}</span>
            `;
            
            usersList.appendChild(userItem);
            updateUsersCount();
        }
        
        // ç§»é™¤ç”¨æˆ¶
        function removeUser(userId) {
            const userItem = document.getElementById('user-item-' + userId);
            if (userItem) {
                userItem.remove();
            }
            
            // ç§»é™¤æ¸¸æ¨™
            const cursor = remoteCursors.get(userId);
            if (cursor && cursor.element.parentNode) {
                cursor.element.parentNode.removeChild(cursor.element);
            }
            remoteCursors.delete(userId);
            
            updateUsersCount();
        }
        
        // æ›´æ–°ç”¨æˆ¶æ•¸é‡
        function updateUsersCount() {
            const count = document.getElementById('users-list').children.length;
            document.getElementById('users-count').textContent = count;
        }
        
        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
        function updateUserStatus(status, userId = null) {
            const targetUserId = userId || userId;
            const statusElement = document.getElementById('status-' + targetUserId);
            
            if (statusElement) {
                statusElement.className = 'user-status ' + status;
            }
            
            if (!userId) {
                // å»£æ’­è‡ªå·±çš„ç‹€æ…‹
                broadcastMessage({
                    type: 'user_status',
                    userId: userId,
                    userName: userName,
                    status: status,
                    timestamp: Date.now()
                });
            }
        }
        
        // å»£æ’­æ¶ˆæ¯
        function broadcastMessage(data) {
            try {
                collaborationChannel.postMessage(data);
            } catch (error) {
                console.error('å»£æ’­æ¶ˆæ¯å¤±æ•—:', error);
            }
        }
        
        // è¨˜éŒ„å»¶é²
        function recordLatency(type, latency) {
            if (!latencyData[type]) latencyData[type] = [];
            
            latencyData[type].push(latency);
            if (latencyData[type].length > 10) {
                latencyData[type].shift(); // åªä¿ç•™æœ€è¿‘10æ¢è¨˜éŒ„
            }
        }
        
        // æ›´æ–°å»¶é²é¡¯ç¤º
        function updateLatencyDisplay() {
            const types = ['code', 'cursor', 'chat'];
            let totalLatency = 0;
            let count = 0;
            
            types.forEach(type => {
                const data = latencyData[type];
                if (data.length > 0) {
                    const avg = data.reduce((a, b) => a + b, 0) / data.length;
                    const element = document.getElementById(type + '-latency');
                    
                    if (element) {
                        element.textContent = Math.round(avg) + ' ms';
                        element.className = 'latency-value ' + getLatencyClass(avg);
                    }
                    
                    totalLatency += avg;
                    count++;
                }
            });
            
            if (count > 0) {
                const avgLatency = totalLatency / count;
                const avgElement = document.getElementById('avg-latency');
                const displayElement = document.getElementById('latency-display');
                
                if (avgElement) {
                    avgElement.textContent = Math.round(avgLatency) + ' ms';
                    avgElement.className = 'latency-value ' + getLatencyClass(avgLatency);
                }
                
                if (displayElement) {
                    displayElement.textContent = Math.round(avgLatency) + ' ms';
                }
            }
        }
        
        // ç²å–å»¶é²ç­‰ç´šé¡å
        function getLatencyClass(latency) {
            if (latency < 100) return 'good';
            if (latency < 300) return 'ok';
            return 'bad';
        }
        
        // é–‹å§‹å»¶é²ç›£æ§
        function startLatencyMonitoring() {
            setInterval(() => {
                updateLatencyDisplay();
            }, 1000);
        }
        
        // æ›´æ–°åŒæ­¥è¨ˆæ•¸
        function updateSyncCount() {
            latencyData.sync++;
            document.getElementById('sync-count').textContent = latencyData.sync;
        }
        
        // æ·»åŠ æ´»å‹•è¨˜éŒ„
        function addActivity(user, action, type) {
            const activityLog = document.getElementById('activity-log');
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item ' + type;
            
            const time = new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            activityItem.innerHTML = `
                <div><strong>${user}</strong> ${action}</div>
                <div class="activity-time">${time}</div>
            `;
            
            activityLog.insertBefore(activityItem, activityLog.firstChild);
            
            // é™åˆ¶è¨˜éŒ„æ•¸é‡
            while (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }
        
        // é–‹å•Ÿå¤šå€‹çª—å£é€²è¡Œæ¸¬è©¦
        function openMultipleWindows() {
            const currentUrl = window.location.href;
            const windowCount = 3;
            
            for (let i = 1; i <= windowCount; i++) {
                setTimeout(() => {
                    window.open(currentUrl, `collab_test_${i}`, 'width=800,height=900,left=' + (i * 300) + ',top=' + (i * 100));
                }, i * 500);
            }
            
            addActivity('ç³»çµ±', `å·²é–‹å•Ÿ ${windowCount} å€‹å”ä½œçª—å£`, 'system');
            document.getElementById('step-1').classList.add('completed');
        }
        
        // é–‹å§‹å»¶é²æ¸¬è©¦
        function startLatencyTest() {
            addActivity('ç³»çµ±', 'é–‹å§‹å»¶é²æ¸¬è©¦...', 'system');
            
            let testCount = 0;
            const maxTests = 10;
            
            const testInterval = setInterval(() => {
                if (testCount >= maxTests) {
                    clearInterval(testInterval);
                    addActivity('ç³»çµ±', 'å»¶é²æ¸¬è©¦å®Œæˆ', 'system');
                    document.getElementById('step-4').classList.add('completed');
                    return;
                }
                
                // ç™¼é€æ¸¬è©¦æ¶ˆæ¯
                const testData = {
                    type: 'latency_test',
                    userId: userId,
                    userName: userName,
                    testId: testCount,
                    timestamp: Date.now()
                };
                
                broadcastMessage(testData);
                testCount++;
                
                addActivity('ç³»çµ±', `å»¶é²æ¸¬è©¦ ${testCount}/${maxTests}`, 'system');
            }, 500);
        }
        
        // æ¨¡æ“¬å”ä½œ
        function simulateCollaboration() {
            if (isSimulating) return;
            
            isSimulating = true;
            document.getElementById('simulated-user').classList.remove('hidden');
            document.getElementById('step-5').classList.add('completed');
            
            const simulatedChanges = [
                { line: 10, text: '    # æ¨¡æ“¬ç”¨æˆ¶Açš„ä¿®æ”¹', action: 'æ·»åŠ è¨»é‡‹' },
                { line: 15, text: '    print("å”ä½œç”¨æˆ¶Bæ­£åœ¨ç·¨è¼¯...")', action: 'æ·»åŠ ä»£ç¢¼' },
                { line: 20, text: '    result = "å¤šäººå”ä½œæ¸¬è©¦æˆåŠŸï¼"', action: 'ä¿®æ”¹è®Šé‡' },
                { line: 25, text: '    # ç”¨æˆ¶Cæ·»åŠ çš„åŠŸèƒ½', action: 'æ’å…¥åŠŸèƒ½' },
                { line: 30, text: '    return collaboration_success', action: 'è¿”å›çµæœ' }
            ];
            
            let changeIndex = 0;
            
            simulationInterval = setInterval(() => {
                if (changeIndex >= simulatedChanges.length || !isSimulating) {
                    stopSimulation();
                    return;
                }
                
                const change = simulatedChanges[changeIndex];
                const userName = `æ¨¡æ“¬ç”¨æˆ¶${String.fromCharCode(65 + changeIndex)}`;
                
                // æ¨¡æ“¬æ¸¸æ¨™ç§»å‹•
                updateRemoteCursor(`sim_${changeIndex}`, userName, { line: change.line, ch: 0 });
                
                // æ¨¡æ“¬ä»£ç¢¼è®Šæ›´
                const currentCode = editor.getValue();
                const lines = currentCode.split('\n');
                
                if (lines[change.line]) {
                    lines[change.line] += '\n' + change.text;
                } else {
                    lines.push(change.text);
                }
                
                editor.setValue(lines.join('\n'));
                
                // è¨˜éŒ„æ´»å‹•
                addActivity(userName, change.action, 'edit');
                
                // æ›´æ–°ç‹€æ…‹
                document.getElementById('simulation-status').textContent = 
                    `${userName} æ­£åœ¨åŸ·è¡Œ: ${change.action}`;
                
                changeIndex++;
            }, 2000);
            
            addActivity('ç³»çµ±', 'é–‹å§‹æ¨¡æ“¬å¤šç”¨æˆ¶å”ä½œ', 'system');
        }
        
        // åœæ­¢æ¨¡æ“¬
        function stopSimulation() {
            isSimulating = false;
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            document.getElementById('simulated-user').classList.add('hidden');
            addActivity('ç³»çµ±', 'æ¨¡æ“¬å”ä½œå·²åœæ­¢', 'system');
        }
        
        // é‡ç½®æ¸¬è©¦
        function resetTest() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æ¸¬è©¦æ•¸æ“šå—ï¼Ÿ')) {
                // é‡ç½®ç·¨è¼¯å™¨
                editor.setValue(editor.getValue().split('\n').slice(0, 10).join('\n'));
                
                // é‡ç½®çµ±è¨ˆ
                latencyData = { code: [], cursor: [], chat: [], sync: 0 };
                document.getElementById('sync-count').textContent = '0';
                document.getElementById('latency-display').textContent = '-- ms';
                
                // é‡ç½®æ­¥é©Ÿç‹€æ…‹
                document.querySelectorAll('.test-step').forEach(step => {
                    step.classList.remove('completed');
                });
                
                // æ¸…ç©ºæ´»å‹•è¨˜éŒ„
                document.getElementById('activity-log').innerHTML = `
                    <div class="activity-item">
                        <div><strong>ç³»çµ±é‡ç½®</strong></div>
                        <div class="activity-time">æ¸¬è©¦ç’°å¢ƒå·²é‡ç½®</div>
                    </div>
                `;
                
                // æ¸…ç©ºé ç¨‹æ¸¸æ¨™
                remoteCursors.forEach(cursor => {
                    if (cursor.element.parentNode) {
                        cursor.element.parentNode.removeChild(cursor.element);
                    }
                });
                remoteCursors.clear();
                
                addActivity('ç³»çµ±', 'æ¸¬è©¦ç’°å¢ƒå·²é‡ç½®', 'system');
            }
        }
        
        // é é¢é—œé–‰æ™‚æ¸…ç†
        window.addEventListener('beforeunload', function() {
            broadcastMessage({
                type: 'user_leave',
                userId: userId,
                userName: userName,
                timestamp: Date.now()
            });
        });
        
        // å®šæœŸæ¸…ç†éæœŸæ¸¸æ¨™
        setInterval(() => {
            const now = Date.now();
            remoteCursors.forEach((cursor, userId) => {
                if (now - cursor.lastUpdate > 10000) {
                    if (cursor.element.parentNode) {
                        cursor.element.parentNode.removeChild(cursor.element);
                    }
                    remoteCursors.delete(userId);
                }
            });
        }, 5000);
    </script>
</body>
</html> 